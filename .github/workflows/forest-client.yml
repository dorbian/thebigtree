name: Build Forest Client

on:
  workflow_dispatch:
    inputs:
      dalamud_url:
        description: "Dalamud dev zip URL"
        required: false
        default: "https://goatcorp.github.io/dalamud-distrib/latest.zip"
  push:
    paths:
      - "forest-client/**"
      - ".github/workflows/forest-client.yml"

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write
    env:
      DALAMUD_URL: https://goatcorp.github.io/dalamud-distrib/latest.zip
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Prepare Dalamud
        shell: powershell
        run: |
          $dalamudHome = Join-Path $env:RUNNER_TEMP "dalamud"
          if (-not (Test-Path $dalamudHome)) { New-Item -ItemType Directory -Path $dalamudHome | Out-Null }
          if (-not (Test-Path (Join-Path $dalamudHome "Dalamud.dll"))) {
            $url = "${{ inputs.dalamud_url }}"
            if ([string]::IsNullOrWhiteSpace($url)) {
              $url = $env:DALAMUD_URL
            }
            if ([string]::IsNullOrWhiteSpace($url)) {
              throw "Dalamud URL is empty; set the workflow input 'dalamud_url'."
            }
            $zip = Join-Path $env:RUNNER_TEMP "dalamud.zip"
            Invoke-WebRequest -Uri $url -OutFile $zip
            Expand-Archive -Path $zip -DestinationPath $dalamudHome -Force
          }
          Add-Content -Path $env:GITHUB_ENV -Value ("DALAMUD_HOME=" + $dalamudHome)
          Add-Content -Path $env:GITHUB_ENV -Value ("DALAMUD_LIB_PATH=" + $dalamudHome)

      - name: Set version
        shell: powershell
        run: |
          $prefix = "1.1"
          $version = "$prefix.${{ github.run_number }}"
          $csproj = "forest-client/Forest/Forest.csproj"
          $csprojXml = Get-Content -Raw -Path $csproj
          if ($csprojXml -match "<Version>.*?</Version>") {
            $csprojXml = [regex]::Replace($csprojXml, "<Version>.*?</Version>", "<Version>$version</Version>")
          } else {
            $csprojXml = $csprojXml -replace "</PropertyGroup>", "  <Version>$version</Version>`r`n  </PropertyGroup>"
          }
          Set-Content -Path $csproj -Value $csprojXml -Encoding UTF8

          $manifestPath = "forest-client/Forest/Forest.json"
          $manifest = Get-Content -Raw -Path $manifestPath | ConvertFrom-Json
          $manifest.AssemblyVersion = $version
          $manifest.Version = $version
          $manifest | ConvertTo-Json -Depth 10 | Set-Content -Path $manifestPath -Encoding UTF8

      - name: Build
        shell: powershell
        run: |
          dotnet restore forest-client/Forest/Forest.csproj
          dotnet build forest-client/Forest/Forest.csproj -c Release -o forest-client/dist
          Copy-Item forest-client/Forest/Forest.json forest-client/dist -Force

      - name: Package zip
        shell: powershell
        run: |
          Compress-Archive -Path forest-client/dist/* -DestinationPath forest-client/forest-client.zip -Force

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: forest-client
          path: forest-client/forest-client.zip

      - name: Publish release asset
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v2
        continue-on-error: true
        with:
          tag_name: forest-client-latest
          name: Forest Client (latest)
          files: forest-client/forest-client.zip
          prerelease: false

      - name: Checkout forest_repo
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'
        uses: actions/checkout@v4
        with:
          repository: dorbian/forest_repo
          token: ${{ secrets.FOREST_REPO_TOKEN }}
          path: forest_repo

      - name: Update plogonmaster.json
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'
        shell: powershell
        run: |
          $repo = "${{ github.repository }}"
          $version = "1.1.${{ github.run_number }}"
          $zipUrl = "https://github.com/$repo/releases/download/forest-client-latest/forest-client.zip"
          $path = "forest_repo/plogonmaster.json"
          $json = Get-Content -Raw -Path $path | ConvertFrom-Json
          $json = @($json)
          foreach ($entry in $json) {
            if ($entry.InternalName -eq "Forest") {
              $entry.DalamudApiLevel = 14
              $entry.AssemblyVersion = $version
              $entry.DownloadLinkInstall = $zipUrl
              $entry.DownloadLinkTesting = $zipUrl
              $entry.DownloadLinkUpdate = $zipUrl
            }
          }
          $json | ConvertTo-Json -Depth 10 | Set-Content -Path $path -Encoding UTF8
          git -C forest_repo config user.name "thebigtree-bot"
          git -C forest_repo config user.email "thebigtree-bot@users.noreply.github.com"
          git -C forest_repo add plogonmaster.json
          $msg = "Update Forest download links (API 14)"
          if (git -C forest_repo diff --cached --quiet) {
            Write-Host "No changes to commit."
          } else {
            git -C forest_repo commit -m $msg
            git -C forest_repo push
          }
