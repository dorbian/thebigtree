name: Build Forest Client

on:
  workflow_dispatch:
    inputs:
      dalamud_url:
        description: "Dalamud dev zip URL"
        required: false
        default: "https://goatcorp.github.io/dalamud-distrib/latest.zip"
  push:
    paths:
      - "forest-client/**"
      - ".github/workflows/forest-client.yml"

env:
  DALAMUD_HOME: ${{ runner.temp }}\\dalamud

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Prepare Dalamud
        shell: powershell
        run: |
          $dalamudHome = "${env:DALAMUD_HOME}"
          if (-not (Test-Path $dalamudHome)) { New-Item -ItemType Directory -Path $dalamudHome | Out-Null }
          if (-not (Test-Path (Join-Path $dalamudHome "Dalamud.dll"))) {
            $url = "${{ inputs.dalamud_url }}"
            if ([string]::IsNullOrWhiteSpace($url)) {
              throw "Dalamud URL is empty; set the workflow input 'dalamud_url'."
            }
            $zip = Join-Path $env:RUNNER_TEMP "dalamud.zip"
            Invoke-WebRequest -Uri $url -OutFile $zip
            Expand-Archive -Path $zip -DestinationPath $dalamudHome -Force
          }

      - name: Build
        shell: powershell
        run: |
          dotnet restore forest-client/Forest/Forest.csproj
          dotnet build forest-client/Forest/Forest.csproj -c Release -o forest-client/dist
          Copy-Item forest-client/Forest/Forest.json forest-client/dist -Force

      - name: Package zip
        shell: powershell
        run: |
          Compress-Archive -Path forest-client/dist/* -DestinationPath forest-client/forest-client.zip -Force

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: forest-client
          path: forest-client/forest-client.zip
