<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Forest Calendar</title>
<link rel="icon" href="/icon.png" type="image/png">
<style>
  :root{
    --bg:#0b1310;
    --panel:#101a15;
    --text:#e7f2ea;
    --muted:#9fb4a6;
    --accent:#6bd4a2;
    --line:rgba(255,255,255,.08);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,sans-serif;
    color:var(--text);
    background:
      radial-gradient(1200px 700px at 10% -10%, rgba(107,212,162,.18), transparent 60%),
      linear-gradient(180deg, #0a120f, #0f1713 40%, #0a120f);
    background-repeat:no-repeat;
    background-size:cover;
    background-attachment:fixed;
  }
  header{
    padding:22px;
    border-bottom:1px solid var(--line);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:16px;
  }
  header h1{margin:0 0 6px 0;letter-spacing:.05em}
  header p{margin:0;color:var(--muted)}
  .admin-link{
    color:var(--accent);
    text-decoration:none;
    font-size:13px;
    border:1px solid rgba(107,212,162,.35);
    padding:8px 12px;
    border-radius:999px;
    background:#0f1a14;
    white-space:nowrap;
  }
  .admin-link:hover{border-color:rgba(107,212,162,.7)}
  main{padding:20px}
  .grid{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));
    gap:14px;
  }
  .card{
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:14px;
    padding:10px;
  }
  .card img{width:100%;border-radius:10px;margin-bottom:8px}
  .muted{color:var(--muted);font-size:12px}
  .artist-link{
    color:var(--accent);
    text-decoration:none;
    font-size:12px;
    cursor:pointer;
    display:inline-block;
    margin:2px 0 6px 0;
  }
  .modal{
    position:fixed;
    inset:0;
    background:rgba(4,10,8,.72);
    display:none;
    align-items:center;
    justify-content:center;
    padding:24px;
    z-index:50;
  }
  .modal.show{display:flex}
  .modal-card{
    max-width:420px;
    width:100%;
    background:#0f1814;
    border:1px solid var(--line);
    border-radius:16px;
    padding:18px;
  }
  .modal-card h2{margin:0 0 10px 0;font-size:20px}
  .modal-links a{
    display:inline-block;
    margin:0 8px 8px 0;
    color:var(--accent);
    text-decoration:none;
    font-size:13px;
  }
  .modal-close{
    margin-top:12px;
    width:100%;
    padding:8px 10px;
    border-radius:10px;
    border:1px solid var(--line);
    background:#0c1511;
    color:var(--text);
    font-family:inherit;
    font-size:14px;
  }
  .image-modal{
    position:fixed;
    inset:0;
    background:rgba(4,10,8,.9);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:70;
  }
  .image-modal.show{display:flex}
  .image-modal img{
    max-width:92vw;
    max-height:90vh;
    border-radius:16px;
    box-shadow:0 20px 60px rgba(0,0,0,.5);
  }
  .image-modal .info{
    position:absolute;
    top:16px;
    left:18px;
    color:var(--text);
    background:rgba(12,18,15,.85);
    border:1px solid var(--line);
    border-radius:10px;
    padding:8px 12px;
    font-size:13px;
    opacity:0;
    transition:opacity .2s ease;
  }
  .image-modal.show-info .info{opacity:1}
  .image-modal .close{
    position:absolute;
    top:12px;
    right:12px;
    width:36px;
    height:36px;
    border-radius:999px;
    border:1px solid var(--line);
    background:rgba(12,18,15,.9);
    color:var(--text);
    font-size:18px;
    cursor:pointer;
  }
</style>

<header>
  <div>
    <h1>Forest Calendar</h1>
    <p>Monthly spotlight from the gallery.</p>
  </div>
  <div class="row">
    <a class="admin-link" href="/gallery">Gallery</a>
    <a class="admin-link" href="/elfministration">Admin login</a>
  </div>
</header>

<main>
  <div class="grid" id="grid"></div>
</main>

<div class="modal" id="artistModal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal-card">
    <h2 id="artistName">Artist</h2>
    <div class="modal-links" id="artistLinks"></div>
    <button class="modal-close" id="artistClose">Close</button>
  </div>
</div>
<div class="image-modal" id="imageModal" aria-hidden="true">
  <div class="info" id="imageInfo"></div>
  <button class="close" id="imageClose" aria-label="Close">Ã—</button>
  <img id="imageModalImg" alt="">
</div>

<script>
  const grid = document.getElementById("grid");
  const artistModal = document.getElementById("artistModal");
  const artistName = document.getElementById("artistName");
  const artistLinks = document.getElementById("artistLinks");
  const imageModal = document.getElementById("imageModal");
  const imageModalImg = document.getElementById("imageModalImg");
  const imageInfo = document.getElementById("imageInfo");
  let imageInfoTimer = null;

  function openArtistModal(name, links){
    artistName.textContent = name || "Forest";
    const linkItems = Object.entries(links || {})
      .filter(([, url]) => url)
      .map(([label, url]) => `<a href="${url}" target="_blank" rel="noreferrer">${label}</a>`);
    artistLinks.innerHTML = linkItems.length ? linkItems.join("") : "<span class='muted'>Forest</span>";
    artistModal.classList.add("show");
    artistModal.setAttribute("aria-hidden", "false");
  }

  function closeArtistModal(){
    artistModal.classList.remove("show");
    artistModal.setAttribute("aria-hidden", "true");
  }

  function showImageInfo(){
    imageModal.classList.add("show-info");
    if (imageInfoTimer) clearTimeout(imageInfoTimer);
    imageInfoTimer = setTimeout(() => {
      imageModal.classList.remove("show-info");
    }, 2000);
  }

  function openImageModal(data){
    imageModalImg.src = data.url;
    imageModalImg.alt = data.title || "";
    imageInfo.textContent = data.info || "";
    imageModal.classList.add("show");
    imageModal.setAttribute("aria-hidden", "false");
    showImageInfo();
  }

  function closeImageModal(){
    imageModal.classList.remove("show");
    imageModal.setAttribute("aria-hidden", "true");
    imageModalImg.src = "";
    imageInfo.textContent = "";
  }

  async function load(){
    const res = await fetch(`/api/gallery/calendar`);
    const data = await res.json();
    if (!data.ok){
      grid.innerHTML = "<div class='muted'>Calendar unavailable.</div>";
      return;
    }
    const months = data.months || [];
    grid.innerHTML = months.map(m => {
      const artist = m.artist || {};
      const artistName = artist.name || "Forest";
      const artistLinks = artist.links || {};
      const infoParts = [m.month_name || "", m.title || "", artistName];
      const infoText = infoParts.filter(Boolean).join(" \u2014 ");
      const artistPayload = encodeURIComponent(JSON.stringify({
        name: artistName,
        links: artistLinks
      }));
      return `
        <div class="card">
          <div><strong>${m.month_name || ""}</strong></div>
          ${m.title ? `<div class="muted">${m.title}</div>` : ""}
          ${m.image ? `<img src="${m.image}" alt="${m.title || m.month_name || ""}" data-full='${encodeURIComponent(JSON.stringify({url: m.image, info: infoText, title: m.title || ""}))}'>` : `<div class="muted">No image yet.</div>`}
          <div><a class="artist-link" href="#" data-artist="${artistPayload}">${artistName}</a></div>
        </div>
      `;
    }).join("");
  }

  document.getElementById("artistClose").addEventListener("click", closeArtistModal);
  artistModal.addEventListener("click", (event) => {
    if (event.target === artistModal) closeArtistModal();
  });
  document.getElementById("imageClose").addEventListener("click", closeImageModal);
  imageModal.addEventListener("click", (event) => {
    if (event.target === imageModal) closeImageModal();
  });
  imageModal.addEventListener("mousemove", showImageInfo);
  grid.addEventListener("click", (event) => {
    const target = event.target;
    if (target.tagName === "IMG" && target.getAttribute("data-full")){
      event.preventDefault();
      try{
        const payload = JSON.parse(decodeURIComponent(target.getAttribute("data-full")));
        openImageModal(payload);
      }catch (err){
        return;
      }
      return;
    }
    if (!target.classList || !target.classList.contains("artist-link")) return;
    event.preventDefault();
    const payload = target.getAttribute("data-artist");
    if (!payload) return;
    try{
      const parsed = JSON.parse(decodeURIComponent(payload));
      openArtistModal(parsed.name, parsed.links);
    }catch (err){
      openArtistModal("Forest", {});
    }
  });
  window.addEventListener("keydown", (event) => {
    if (event.key === "Escape" && imageModal.classList.contains("show")){
      closeImageModal();
    }
  });
  load();
</script>
