<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tarot Deck Admin</title>
<style>
  :root{
    --bg:#0b1310;
    --panel:#101a15;
    --text:#e7f2ea;
    --muted:#9fb4a6;
    --accent:#6bd4a2;
    --line:rgba(255,255,255,.08);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:"Spectral","Georgia",serif;
    color:var(--text);
    background:
      radial-gradient(1200px 700px at 10% -10%, rgba(107,212,162,.18), transparent 60%),
      linear-gradient(180deg, #0a120f, #0f1713 40%, #0a120f);
  }
  main{
    max-width:960px;
    margin:30px auto;
    padding:24px;
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:16px;
  }
  h1{margin:0 0 12px 0;letter-spacing:.05em}
  .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
  label{display:block;margin-top:12px;color:var(--muted);font-size:12px}
  input, textarea, button, select{
    width:100%;
    padding:8px 10px;
    border-radius:10px;
    border:1px solid var(--line);
    background:#0c1511;
    color:var(--text);
    font-family:inherit;
    font-size:14px;
  }
  button{background:#122019;border-color:rgba(107,212,162,.4);cursor:pointer}
  .list{margin-top:16px;border-top:1px solid var(--line);padding-top:12px}
  .card{padding:10px;border:1px solid var(--line);border-radius:12px;margin-bottom:8px}
  .muted{color:var(--muted);font-size:12px}
  .status{margin-top:10px}
  .deck-picker{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
    gap:12px;
    margin-top:16px;
  }
  .deck-card{
    border:1px solid var(--line);
    border-radius:12px;
    overflow:hidden;
    background:#0c1511;
    display:flex;
    flex-direction:column;
    text-align:left;
    padding:0;
  }
  .deck-card img{
    width:100%;
    aspect-ratio:3/4.2;
    object-fit:cover;
    background:#0c1511;
  }
  .deck-card .muted{
    padding:8px 10px 10px;
  }
  .deck-placeholder{
    display:flex;
    align-items:center;
    justify-content:center;
    aspect-ratio:3/4.2;
    color:var(--muted);
    background:#0c1511;
    font-size:12px;
    text-transform:uppercase;
    letter-spacing:.08em;
  }
  .icon-btn{
    width:40px;
    padding:6px;
    text-align:center;
  }
  .grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
    gap:12px;
    margin-top:12px;
  }
  .thumb{
    border:1px solid var(--line);
    border-radius:12px;
    overflow:hidden;
    background:#0c1511;
    display:flex;
    flex-direction:column;
  }
  .thumb img{
    width:100%;
    aspect-ratio:3/4.2;
    object-fit:cover;
    background:#0c1511;
  }
  .thumb button{
    border-radius:0;
  }
  .modal{
    position:fixed;
    inset:0;
    background:rgba(6,12,9,.7);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:20;
  }
  .modal.show{display:flex}
  .modal-card{
    width:min(720px,92vw);
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:20px;
    padding:18px;
  }
  .modal-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:10px;
  }
  .modal-title{
    font-size:16px;
    letter-spacing:.08em;
    text-transform:uppercase;
    color:var(--accent);
  }
</style>

<main>
  <h1>Tarot Deck Admin</h1>
  <p class="muted">Add or update cards. Requires a `tarot:admin` API key.</p>

  <label for="apiKey">API Key</label>
  <input id="apiKey" placeholder="X-API-Key">

  <div class="row">
    <div>
      <label for="deckId">Deck</label>
      <select id="deckId"></select>
    </div>
    <div>
      <label>&nbsp;</label>
      <button id="loadDeck">Load deck</button>
    </div>
    <div>
      <label>&nbsp;</label>
      <button id="addDeck">Add deck</button>
    </div>
  </div>
  <div class="row">
    <div>
      <label>Deck back</label>
      <div class="row">
        <button id="backLibrary" class="icon-btn" title="Choose from library">LIB</button>
        <button id="backArtistPick" class="icon-btn" title="Pick artist">ART</button>
      </div>
    </div>
  </div>
  <input id="backImage" type="hidden">
  <input id="backArtist" type="hidden">

  <h2>Add / Update Card</h2>
  <div class="row">
    <div>
      <label for="cardId">Card ID (optional)</label>
      <input id="cardId" placeholder="candlecap_sprite">
    </div>
    <div>
      <label for="cardName">Name</label>
      <input id="cardName" placeholder="Candlecap Sprite">
    </div>
    <div>
      <label for="cardHouse">House</label>
      <select id="cardHouse"></select>
    </div>
  </div>
  <div class="row">
    <div>
      <label for="cardTags">Tags (comma separated)</label>
      <input id="cardTags" placeholder="mischief,curiosity">
    </div>
  </div>
  <div class="row">
    <div>
      <label for="cardUpload">Upload image</label>
      <input id="cardUpload" type="file" accept="image/*">
    </div>
    <div>
      <label>Tools</label>
      <div class="row">
        <button id="cardLibrary" class="icon-btn" title="Choose from library">LIB</button>
        <button id="cardArtistPick" class="icon-btn" title="Pick artist">ART</button>
      </div>
    </div>
    <div>
      <label>House info</label>
      <div class="card" id="houseInfo">Pick a house to see details.</div>
    </div>
  </div>
  <input id="cardArtist" type="hidden">
  <label for="cardUpright">Upright</label>
  <textarea id="cardUpright" rows="3"></textarea>
  <label for="cardReversed">Reversed</label>
  <textarea id="cardReversed" rows="3"></textarea>

  <h3>Artists</h3>
  <div class="row">
    <div>
      <label for="artistSelect">Artist list</label>
      <select id="artistSelect"></select>
    </div>
    <div>
      <label>&nbsp;</label>
      <button id="artistRefresh" class="btn-ghost">Refresh artists</button>
    </div>
  </div>
  <div class="row">
    <div>
      <label for="artistId">Artist ID (optional)</label>
      <input id="artistId" placeholder="artist_id">
    </div>
    <div>
      <label for="artistName">Name</label>
      <input id="artistName" placeholder="Artist name">
    </div>
  </div>
  <div class="row">
    <div>
      <label for="artistInstagram">Instagram</label>
      <input id="artistInstagram" placeholder="https://instagram.com/...">
    </div>
    <div>
      <label for="artistBluesky">Bluesky</label>
      <input id="artistBluesky" placeholder="https://bsky.app/profile/...">
    </div>
    <div>
      <label for="artistX">X / Twitter</label>
      <input id="artistX" placeholder="https://x.com/...">
    </div>
  </div>
  <div class="row">
    <div>
      <label for="artistArtstation">ArtStation</label>
      <input id="artistArtstation" placeholder="https://artstation.com/...">
    </div>
    <div>
      <label for="artistWebsite">Website</label>
      <input id="artistWebsite" placeholder="https://...">
    </div>
  </div>
  <div class="row">
    <div>
      <label>&nbsp;</label>
      <button id="artistSave">Save artist</button>
    </div>
    <div>
      <label>&nbsp;</label>
      <button id="artistDelete" class="btn-ghost">Delete artist</button>
    </div>
  </div>

  <button id="saveCard">Save card</button>
  <div class="status" id="status"></div>
  <div class="modal" id="uploadLibraryModal">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title" id="uploadLibraryTitle">Image Library</div>
        <button class="btn-ghost" id="uploadLibraryClose">Close</button>
      </div>
      <div class="row">
        <div>
          <label>&nbsp;</label>
          <button class="btn-ghost" id="uploadLibraryRefresh">Refresh</button>
        </div>
      </div>
      <div class="grid" id="uploadLibraryGrid"></div>
      <div class="status" id="uploadLibraryStatus">Ready.</div>
    </div>
  </div>
  <div class="modal" id="artistPickerModal">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title">Select Artist</div>
        <button class="btn-ghost" id="artistPickerClose">Close</button>
      </div>
      <div class="row">
        <div>
          <label for="artistPickerSelect">Artist</label>
          <select id="artistPickerSelect"></select>
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="artistPickerUse">Use artist</button>
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="artistPickerClear" class="btn-ghost">Clear</button>
        </div>
      </div>
      <div class="status" id="artistPickerStatus">Pick an artist to apply to the upload.</div>
    </div>
  </div>

  <div class="deck-picker" id="deckPicker"></div>
  <div class="list" id="deckList"></div>
</main>

<script>
  const apiKey = document.getElementById("apiKey");
  const deckId = document.getElementById("deckId");
  const status = document.getElementById("status");
  const deckList = document.getElementById("deckList");
  const deckPicker = document.getElementById("deckPicker");
  const storageKey = "bt_api_key";
  let uploadedImageUrl = "";
  let houseData = [];
  let artistData = [];

  apiKey.value = localStorage.getItem(storageKey) || "";
  apiKey.addEventListener("input", () => {
    localStorage.setItem(storageKey, apiKey.value.trim());
    loadHouses();
    loadDeckList();
  });

  function setStatus(msg, ok){
    status.textContent = msg;
    status.style.color = ok ? "#6bd4a2" : "#e07a7a";
  }

  async function loadArtists(){
    try{
      const res = await fetch("/api/tarot/artists", {
        headers: {"X-API-Key": apiKey.value.trim()}
      });
      if (res.status === 401){
        setStatus("Unauthorized. Enter API key.", false);
        return;
      }
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "Failed");
      artistData = data.artists || [];
      const sel = document.getElementById("artistSelect");
      if (sel){
        sel.innerHTML = "";
        const none = document.createElement("option");
        none.value = "";
        none.textContent = "(none)";
        sel.appendChild(none);
        artistData.forEach(a => {
          const opt = document.createElement("option");
          opt.value = a.artist_id || "";
          opt.textContent = a.name ? `${a.name} (${a.artist_id})` : (a.artist_id || "");
          sel.appendChild(opt);
        });
      }
      renderArtistPicker();
    }catch(err){
      setStatus(err.message, false);
    }
  }

  // Uploads are handled directly on this page.

  let librarySelectHandler = null;
  let libraryKind = "";

  function setLibraryStatus(msg, ok){
    const el = document.getElementById("uploadLibraryStatus");
    el.textContent = msg;
    el.style.color = ok ? "#6bd4a2" : "#e07a7a";
  }

  function showLibraryModal(show){
    document.getElementById("uploadLibraryModal").classList.toggle("show", !!show);
  }

  let artistTarget = "card";

  function setArtistPickerStatus(msg, ok){
    const el = document.getElementById("artistPickerStatus");
    if (!el) return;
    el.textContent = msg;
    el.style.color = ok ? "#6bd4a2" : "#e07a7a";
  }

  function renderArtistPicker(){
    const sel = document.getElementById("artistPickerSelect");
    if (!sel) return;
    sel.innerHTML = "";
    const none = document.createElement("option");
    none.value = "";
    none.textContent = "(none)";
    sel.appendChild(none);
    artistData.forEach(a => {
      const opt = document.createElement("option");
      opt.value = a.artist_id || "";
      opt.textContent = a.name ? `${a.name} (${a.artist_id})` : (a.artist_id || "");
      sel.appendChild(opt);
    });
  }

  function showArtistPicker(show, target){
    if (target) artistTarget = target;
    const modal = document.getElementById("artistPickerModal");
    if (modal) modal.classList.toggle("show", !!show);
    setArtistPickerStatus("Pick an artist to apply to the upload.", true);
    renderArtistPicker();
  }

  async function loadLibrary(kind){
    libraryKind = kind;
    const grid = document.getElementById("uploadLibraryGrid");
    const title = document.getElementById("uploadLibraryTitle");
    title.textContent = kind === "tarot-back" ? "Tarot Backs" : "Tarot Cards";
    setLibraryStatus("Loading...", true);
    grid.innerHTML = "";
    const path = kind === "tarot-back" ? "/api/uploads/tarot/backs" : "/api/uploads/tarot/cards";
    try{
      const res = await fetch(path, {headers: {"X-API-Key": apiKey.value.trim()}});
      if (res.status === 401){
        setLibraryStatus("Unauthorized. Enter API key.", false);
        return;
      }
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "Failed");
      const items = data.items || [];
      if (!items.length){
        setLibraryStatus("No images found.", false);
        return;
      }
      items.forEach(item => {
        const card = document.createElement("div");
        card.className = "thumb";
        const img = document.createElement("img");
        img.src = item.url;
        img.alt = item.name || "image";
        const btn = document.createElement("button");
        btn.textContent = "Use";
        btn.addEventListener("click", () => {
          if (librarySelectHandler){
            librarySelectHandler(item);
          }
          showLibraryModal(false);
        });
        const meta = document.createElement("div");
        meta.className = "muted";
        meta.style.padding = "0 8px 8px";
        meta.textContent = item.artist_name ? `Artist: ${item.artist_name}` : (item.name || "");
        const del = document.createElement("button");
        del.textContent = "Delete";
        del.addEventListener("click", async () => {
          if (!confirm("Delete this file? This cannot be undone.")) return;
          try{
            const delUrl = kind === "tarot-back"
              ? "/api/uploads/tarot/backs/" + encodeURIComponent(item.name || "")
              : "/api/uploads/tarot/cards/" + encodeURIComponent(item.name || "");
            const res = await fetch(delUrl, {method: "DELETE", headers: {"X-API-Key": apiKey.value.trim()}});
            const data = await res.json().catch(() => ({}));
            if (!res.ok || data.ok === false){
              throw new Error(data.error || "Delete failed");
            }
            await loadLibrary(kind);
          }catch(err){
            setLibraryStatus(err.message, false);
          }
        });
        card.appendChild(img);
        card.appendChild(btn);
        card.appendChild(meta);
        card.appendChild(del);
        grid.appendChild(card);
      });
      setLibraryStatus("Pick an image.", true);
    }catch(err){
      setLibraryStatus(err.message, false);
    }
  }

  async function loadDeck(){
    try{
      const deck = deckId.value.trim() || "elf-classic";
      const res = await fetch(`/api/tarot/decks/${encodeURIComponent(deck)}`, {
        headers: {"X-API-Key": apiKey.value.trim()}
      });
      if (res.status === 401){
        setStatus("Unauthorized. Enter API key.", false);
        return;
      }
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "Failed");
      deckList.innerHTML = data.cards.map(c => {
        return `<div class="card"><strong>${c.name}</strong> <span class="muted">(${c.card_id})</span><br><span class="muted">${c.house || ""}</span></div>`;
      }).join("");
      document.getElementById("backImage").value = (data.deck && data.deck.back_image) ? data.deck.back_image : "";
      document.getElementById("backArtist").value = (data.deck && data.deck.back_artist_id) ? data.deck.back_artist_id : "";
      if (!deckId.options.length || !deckId.querySelector(`option[value="${deckId.value}"]`)) {
        await loadDeckList(deck);
      }
      setStatus("Deck loaded.", true);
    }catch(err){
      setStatus(err.message, false);
    }
  }

  document.getElementById("loadDeck").addEventListener("click", loadDeck);
  document.getElementById("addDeck").addEventListener("click", async () => {
    const id = prompt("New deck id (e.g. elf-classic)") || "";
    if (!id.trim()) return;
    const name = prompt("Deck name (optional)") || "";
    try{
      const res = await fetch("/api/tarot/decks", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-API-Key": apiKey.value.trim()
        },
        body: JSON.stringify({deck_id: id.trim(), name: name.trim() || undefined})
      });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "Failed");
      await loadDeckList(id.trim());
      setStatus("Deck created. Pick a back image.", true);
      librarySelectHandler = async (item) => {
        const backImage = item.url || "";
        document.getElementById("backImage").value = backImage;
        document.getElementById("backArtist").value = item.artist_id || "";
        try{
          const res = await fetch(`/api/tarot/decks/${encodeURIComponent(id.trim())}/back`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              "X-API-Key": apiKey.value.trim()
            },
            body: JSON.stringify({
              back_image: backImage,
              artist_id: document.getElementById("backArtist").value.trim() || undefined
            })
          });
          const payload = await res.json().catch(() => ({}));
          if (!res.ok || payload.ok === false){
            throw new Error(payload.error || "Failed");
          }
          await loadDeck();
          setStatus("Deck back saved.", true);
        }catch(err){
          setStatus(err.message, false);
        }
      };
      showLibraryModal(true);
      loadLibrary("tarot-back");
    }catch(err){
      setStatus(err.message, false);
    }
  });

  function renderDeckPicker(decks){
    deckPicker.innerHTML = "";
    decks.forEach(d => {
      const card = document.createElement("button");
      card.type = "button";
      card.className = "deck-card";
      card.title = d.deck_id || "";
      const img = document.createElement("img");
      img.src = d.back_image || "";
      img.alt = d.name || d.deck_id || "deck";
      const label = document.createElement("div");
      label.className = "muted";
      label.textContent = d.name ? `${d.name} (${d.deck_id})` : (d.deck_id || "");
      if (!d.back_image){
        img.style.display = "none";
        const placeholder = document.createElement("div");
        placeholder.className = "deck-placeholder";
        placeholder.textContent = "No back image";
        card.appendChild(placeholder);
      } else {
        card.appendChild(img);
      }
      card.appendChild(label);
      card.addEventListener("click", async () => {
        deckId.value = d.deck_id || "";
        await loadDeck();
      });
      deckPicker.appendChild(card);
    });
  }

  async function loadDeckList(selectValue){
    try{
      const res = await fetch("/api/tarot/decks", {
        headers: {"X-API-Key": apiKey.value.trim()}
      });
      if (res.status === 401){
        setStatus("Unauthorized. Enter API key.", false);
        return;
      }
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "Failed");
      deckId.innerHTML = "";
      const decks = data.decks || [];
      decks.forEach(d => {
        const opt = document.createElement("option");
        opt.value = d.deck_id;
        opt.textContent = d.name ? `${d.name} (${d.deck_id})` : d.deck_id;
        deckId.appendChild(opt);
      });
      renderDeckPicker(decks);
      const fallback = selectValue || "elf-classic";
      deckId.value = fallback;
    }catch(err){
      setStatus(err.message, false);
    }
  }

  document.getElementById("saveCard").addEventListener("click", async () => {
    try{
      const deck = deckId.value.trim() || "elf-classic";
      const tags = document.getElementById("cardTags").value.split(",").map(t => t.trim()).filter(Boolean);
      const body = {
        card_id: document.getElementById("cardId").value.trim() || undefined,
        name: document.getElementById("cardName").value.trim(),
        house: document.getElementById("cardHouse").value.trim(),
        image: uploadedImageUrl || undefined,
        tags,
        upright: document.getElementById("cardUpright").value.trim(),
        reversed: document.getElementById("cardReversed").value.trim(),
        artist_links: undefined
      };
      const res = await fetch(`/api/tarot/decks/${encodeURIComponent(deck)}/cards`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-API-Key": apiKey.value.trim()
        },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "Failed");
      setStatus("Card saved.", true);
      loadDeck();
    }catch(err){
      setStatus(err.message, false);
    }
  });


  document.getElementById("uploadLibraryClose").addEventListener("click", () => showLibraryModal(false));
  document.getElementById("uploadLibraryRefresh").addEventListener("click", () => loadLibrary(libraryKind));
  document.getElementById("backLibrary").addEventListener("click", () => {
    librarySelectHandler = async (item) => {
      const deck = deckId.value.trim() || "elf-classic";
      const backImage = item.url || "";
      document.getElementById("backImage").value = backImage;
      document.getElementById("backArtist").value = item.artist_id || "";
      try{
        const res = await fetch(`/api/tarot/decks/${encodeURIComponent(deck)}/back`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "X-API-Key": apiKey.value.trim()
          },
          body: JSON.stringify({
            back_image: backImage,
            artist_id: document.getElementById("backArtist").value.trim() || undefined
          })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || data.ok === false){
          throw new Error(data.error || "Failed");
        }
        setStatus("Deck back saved from library.", true);
      }catch(err){
        setStatus(err.message, false);
      }
    };
    showLibraryModal(true);
    loadLibrary("tarot-back");
  });
  document.getElementById("cardLibrary").addEventListener("click", () => {
    librarySelectHandler = (item) => {
      uploadedImageUrl = item.url || "";
      document.getElementById("cardArtist").value = item.artist_id || "";
      setStatus("Card image selected from library.", true);
    };
    showLibraryModal(true);
    loadLibrary("tarot-card");
  });

  document.getElementById("backArtistPick").addEventListener("click", () => {
    showArtistPicker(true, "back");
  });
  document.getElementById("cardArtistPick").addEventListener("click", () => {
    showArtistPicker(true, "card");
  });
  document.getElementById("artistPickerClose").addEventListener("click", () => {
    showArtistPicker(false);
  });
  document.getElementById("artistPickerUse").addEventListener("click", () => {
    const sel = document.getElementById("artistPickerSelect");
    const picked = sel ? sel.value.trim() : "";
    if (artistTarget === "back"){
      document.getElementById("backArtist").value = picked;
    } else {
      document.getElementById("cardArtist").value = picked;
    }
    setArtistPickerStatus(picked ? "Artist selected." : "Artist cleared.", true);
    showArtistPicker(false);
  });
  document.getElementById("artistPickerClear").addEventListener("click", () => {
    if (artistTarget === "back"){
      document.getElementById("backArtist").value = "";
    } else {
      document.getElementById("cardArtist").value = "";
    }
    setArtistPickerStatus("Artist cleared.", true);
    showArtistPicker(false);
  });

  document.getElementById("artistRefresh").addEventListener("click", loadArtists);
  document.getElementById("artistSelect").addEventListener("change", (ev) => {
    const pick = artistData.find(a => a.artist_id === ev.target.value);
    if (!pick) return;
    document.getElementById("artistId").value = pick.artist_id || "";
    document.getElementById("artistName").value = pick.name || "";
    const links = pick.links || {};
    document.getElementById("artistInstagram").value = links.instagram || "";
    document.getElementById("artistBluesky").value = links.bluesky || "";
    document.getElementById("artistX").value = links.x || "";
    document.getElementById("artistArtstation").value = links.artstation || "";
    document.getElementById("artistWebsite").value = links.website || "";
  });
  document.getElementById("artistSave").addEventListener("click", async () => {
    try{
      const body = {
        artist_id: document.getElementById("artistId").value.trim() || undefined,
        name: document.getElementById("artistName").value.trim(),
        links: {
          instagram: document.getElementById("artistInstagram").value.trim(),
          bluesky: document.getElementById("artistBluesky").value.trim(),
          x: document.getElementById("artistX").value.trim(),
          artstation: document.getElementById("artistArtstation").value.trim(),
          website: document.getElementById("artistWebsite").value.trim()
        }
      };
      const res = await fetch("/api/tarot/artists", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-API-Key": apiKey.value.trim()
        },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "Failed");
      await loadArtists();
      setStatus("Artist saved.", true);
    }catch(err){
      setStatus(err.message, false);
    }
  });
  document.getElementById("artistDelete").addEventListener("click", async () => {
    const artistId = document.getElementById("artistId").value.trim();
    if (!artistId){
      setStatus("Select an artist to delete.", false);
      return;
    }
    if (!confirm("Delete this artist? Cards will keep the artist_id but links will no longer resolve.")){
      return;
    }
    try{
      const res = await fetch("/api/tarot/artists/" + encodeURIComponent(artistId), {
        method: "DELETE",
        headers: {"X-API-Key": apiKey.value.trim()}
      });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "Failed");
      document.getElementById("artistId").value = "";
      document.getElementById("artistName").value = "";
      document.getElementById("artistInstagram").value = "";
      document.getElementById("artistBluesky").value = "";
      document.getElementById("artistX").value = "";
      document.getElementById("artistArtstation").value = "";
      document.getElementById("artistWebsite").value = "";
      await loadArtists();
      setStatus("Artist deleted.", true);
    }catch(err){
      setStatus(err.message, false);
    }
  });


  document.getElementById("cardUpload").addEventListener("change", async (ev) => {
    const file = ev.target.files[0];
    if (!file) return;
    try{
      const deck = deckId.value.trim() || "elf-classic";
      const form = new FormData();
      form.append("file", file);
      form.append("card_id", document.getElementById("cardId").value.trim());
      const cardArtistId = document.getElementById("cardArtist").value.trim();
      if (cardArtistId) form.append("artist_id", cardArtistId);
      const res = await fetch("/api/tarot/upload-card-image", {
        method: "POST",
        headers: {"X-API-Key": apiKey.value.trim()},
        body: form
      });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "Failed");
      uploadedImageUrl = data.url;
      setStatus("Image uploaded.", true);
    }catch(err){
      setStatus(err.message, false);
    }
  });

  function renderHouseInfo(id){
    const box = document.getElementById("houseInfo");
    const house = houseData.find(h => h.id === id);
    if (!house){
      box.textContent = "Pick a house to see details.";
      return;
    }
    const themes = Object.entries(house.themes || {}).map(([k,v]) => `${k} (${v})`).join(", ");
    const keywords = (house.keywords || []).join(", ");
    const upright = `Upright: ${keywords}.`;
    const reversed = `Reversed: blocked or twisted ${keywords}.`;
    box.innerHTML = `<strong>${house.name}</strong><br><span class="muted">${themes}</span><br><span class="muted">${keywords}</span><br>${upright}<br>${reversed}`;
  }

  async function loadHouses(){
    try{
      const headers = {};
      const key = apiKey.value.trim();
      if (key) headers["X-API-Key"] = key;
      const res = await fetch("/api/tarot/houses", {headers});
      if (res.status === 401){
        setStatus("Unauthorized. Enter API key.", false);
        return;
      }
      const data = await res.json();
      houseData = data.houses || [];
      const select = document.getElementById("cardHouse");
      select.innerHTML = "";
      const none = document.createElement("option");
      none.value = "";
      none.textContent = "(none)";
      select.appendChild(none);
      houseData.forEach(h => {
        const opt = document.createElement("option");
        opt.value = h.id;
        opt.textContent = h.name;
        select.appendChild(opt);
      });
    }catch(err){
      setStatus("Failed to load houses. Check API key.", false);
    }
  }

  document.getElementById("cardHouse").addEventListener("change", (ev) => {
    renderHouseInfo(ev.target.value);
  });

  loadDeckList();
  loadHouses();
  loadArtists();
</script>
