<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tarot Reading</title>
<style>
  :root{
    --bg:#0b1310;
    --panel:#101a15;
    --panel-2:#0c1511;
    --text:#e7f2ea;
    --muted:#9fb4a6;
    --accent:#6bd4a2;
    --line:rgba(255,255,255,.08);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:"Spectral","Georgia",serif;
    color:var(--text);
    background:
      radial-gradient(1200px 700px at 10% -10%, rgba(107,212,162,.18), transparent 60%),
      linear-gradient(180deg, #0a120f, #0f1713 40%, #0a120f);
    background-repeat:no-repeat;
    background-size:cover;
    background-attachment:fixed;
  }
  header{
    padding:18px 22px;
    border-bottom:1px solid var(--line);
  }
  header h1{margin:0;font-size:20px;letter-spacing:.05em}
  .subhead{
    padding:8px 22px 0;
    font-size:12px;
    color:var(--muted);
    display:flex;
    gap:12px;
    flex-wrap:wrap;
    align-items:center;
  }
  .status-dot{
    width:8px;height:8px;border-radius:50%;
    background:#6bd4a2;
    display:inline-block;
    margin-right:6px;
  }
  .status-dot.off{background:#d18b8b}
  .status-dot.warn{background:#d6b26e}
  .wrap{
    padding:16px;
    display:grid;
    grid-template-columns: 1fr 280px;
    gap:16px;
  }
  .panel{
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:14px;
    padding:14px;
  }
  .card-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));
    gap:14px;
  }
  .card-slot{
    background:var(--panel-2);
    border:1px dashed var(--line);
    border-radius:14px;
    padding:10px;
    min-height:240px;
  }
  .label{
    font-size:12px;
    color:var(--muted);
    margin-bottom:8px;
  }
  .card{
    width:100%;
    aspect-ratio:3/4.2;
    perspective:1000px;
  }
  .card .inner{
    position:relative;
    width:100%;height:100%;
    transform-style:preserve-3d;
    transition:transform .7s ease;
  }
  .card.revealed .inner{transform:rotateY(180deg)}
  .face{
    position:absolute;inset:0;
    backface-visibility:hidden;
    border-radius:12px;
    overflow:hidden;
    border:1px solid var(--line);
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .back{
    background:
      radial-gradient(circle at 20% 20%, rgba(214,178,110,.18), transparent 40%),
      linear-gradient(135deg, #1b2d26, #132018);
  }
  .front{
    transform:rotateY(180deg);
    background:#0d1411;
  }
  .front img{width:100%;height:100%;object-fit:cover}
  .narration{
    max-height:420px;
    overflow:auto;
  }
  .deck-preview{
    width:120px;
    aspect-ratio:3/4.2;
    border-radius:12px;
    border:1px solid var(--line);
    background:
      radial-gradient(circle at 20% 20%, rgba(214,178,110,.18), transparent 40%),
      linear-gradient(135deg, #1b2d26, #132018);
    background-size:cover;
    background-position:center;
    margin-bottom:12px;
  }
  .narration .line{
    font-size:13px;
    line-height:1.4;
    margin-bottom:8px;
  }
  .chip{
    display:inline-block;
    padding:2px 8px;
    border-radius:999px;
    border:1px solid var(--line);
    font-size:11px;
    color:var(--muted);
  }
  .notice{
    margin-bottom:10px;
    font-size:12px;
    color:var(--muted);
  }
</style>

<header>
  <h1>Tarot Reading <span class="chip" id="sessionStatus">waiting</span></h1>
</header>
<div class="subhead">
  <span><span class="status-dot" id="connDot"></span><span id="connStatus">connecting</span></span>
  <span>Join: <strong id="joinCode"></strong></span>
  <span>Deck: <strong id="deckName">-</strong></span>
  <span>Spread: <strong id="spreadName">-</strong></span>
</div>

<div class="wrap">
  <div class="panel">
    <div class="notice" id="waitingNote">Waiting for the reader to begin.</div>
    <div id="cardGrid" class="card-grid"></div>
  </div>
  <div class="panel">
    <div class="deck-preview" id="deckPreview"></div>
    <h2 style="margin-top:0;font-size:14px;letter-spacing:.08em;color:var(--muted)">Narration</h2>
    <div class="narration" id="narrationFeed"></div>
  </div>
</div>

<script>
  const joinCode = "{JOIN}";
  const statusEl = document.getElementById("sessionStatus");
  const grid = document.getElementById("cardGrid");
  const narration = document.getElementById("narrationFeed");
  const joinEl = document.getElementById("joinCode");
  const deckEl = document.getElementById("deckName");
  const spreadEl = document.getElementById("spreadName");
  const connDot = document.getElementById("connDot");
  const connStatus = document.getElementById("connStatus");
  const waitingNote = document.getElementById("waitingNote");
  const deckPreview = document.getElementById("deckPreview");
  let currentState = null;
  let sse = null;

  joinEl.textContent = joinCode;

  async function fetchState(){
    const res = await fetch(`/api/tarot/sessions/${joinCode}/state?view=player`);
    const data = await res.json();
    if (!data.ok) return;
    currentState = data.state;
    render();
  }

  function render(){
    if (!currentState) return;
    statusEl.textContent = currentState.session.status || "created";
    deckEl.textContent = currentState.deck ? (currentState.deck.name || currentState.deck.deck_id || "-") : "-";
    spreadEl.textContent = currentState.spread ? (currentState.spread.name || currentState.spread.id || "-") : "-";
    grid.innerHTML = "";
    const backUrl = currentState.deck && currentState.deck.back_image ? currentState.deck.back_image : "";
    if (backUrl){
      deckPreview.style.backgroundImage = `linear-gradient(135deg, rgba(12,18,32,.4), rgba(12,18,32,.6)), url('${backUrl}')`;
    } else {
      deckPreview.style.backgroundImage = "";
    }
    const hasAnyDraw = (currentState.draw || []).length > 0;
    waitingNote.style.display = hasAnyDraw ? "none" : "block";
    currentState.spread.positions.forEach(pos => {
      const draw = currentState.draw.find(d => d.position_id === pos.id);
      const slot = document.createElement("div");
      slot.className = "card-slot";
      const label = document.createElement("div");
      label.className = "label";
      label.textContent = `${pos.label} - ${pos.prompt || ""}`;
      slot.appendChild(label);

      const cardWrap = document.createElement("div");
      cardWrap.className = "card" + (draw && draw.revealed ? " revealed" : "");
      const inner = document.createElement("div");
      inner.className = "inner";
      const back = document.createElement("div");
      back.className = "face back";
      if (backUrl){
        back.style.backgroundImage = `linear-gradient(135deg, rgba(12,18,32,.4), rgba(12,18,32,.6)), url('${backUrl}')`;
        back.style.backgroundSize = "cover";
        back.style.backgroundPosition = "center";
      }
      const front = document.createElement("div");
      front.className = "face front";
      if (draw && draw.card && draw.card.image){
        const img = document.createElement("img");
        img.src = draw.card.image;
        front.appendChild(img);
      } else {
        front.textContent = draw && draw.card ? draw.card.name : "";
      }
      inner.appendChild(back);
      inner.appendChild(front);
      cardWrap.appendChild(inner);
      slot.appendChild(cardWrap);
      grid.appendChild(slot);
    });

    narration.innerHTML = "";
    (currentState.narration || []).slice().reverse().forEach(n => {
      const line = document.createElement("div");
      line.className = "line";
      line.textContent = n.text;
      narration.appendChild(line);
    });
  }

  function connectSSE(){
    if (sse){
      sse.close();
    }
    const src = new EventSource(`/api/tarot/sessions/${joinCode}/stream?view=player`);
    sse = src;
    src.onopen = () => {
      connDot.className = "status-dot";
      connStatus.textContent = "connected";
    };
    src.onerror = () => {
      connDot.className = "status-dot warn";
      connStatus.textContent = "reconnecting";
    };
    src.onmessage = () => fetchState();
  }

  fetchState();
  connectSSE();
  setInterval(fetchState, 5000);
</script>
