<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tarot Reading</title>
<style>
  :root{
    --bg:#0b1310;
    --panel:#101a15;
    --panel-2:#0c1511;
    --text:#e7f2ea;
    --muted:#9fb4a6;
    --accent:#6bd4a2;
    --line:rgba(255,255,255,.08);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:"Spectral","Georgia",serif;
    color:var(--text);
    background:
      radial-gradient(1200px 700px at 10% -10%, rgba(107,212,162,.18), transparent 60%),
      linear-gradient(180deg, #0a120f, #0f1713 40%, #0a120f);
    background-repeat:no-repeat;
    background-size:cover;
    background-attachment:fixed;
  }
  header{
    padding:18px 22px;
    border-bottom:1px solid var(--line);
  }
  header h1{margin:0;font-size:20px;letter-spacing:.05em}
  .wrap{
    padding:16px;
    display:grid;
    grid-template-columns: 1fr 280px;
    gap:16px;
  }
  .panel{
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:14px;
    padding:14px;
  }
  .card-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));
    gap:14px;
  }
  .card-slot{
    background:var(--panel-2);
    border:1px dashed var(--line);
    border-radius:14px;
    padding:10px;
    min-height:240px;
  }
  .label{
    font-size:12px;
    color:var(--muted);
    margin-bottom:8px;
  }
  .card{
    width:100%;
    aspect-ratio:3/4.2;
    perspective:1000px;
  }
  .card .inner{
    position:relative;
    width:100%;height:100%;
    transform-style:preserve-3d;
    transition:transform .7s ease;
  }
  .card.revealed .inner{transform:rotateY(180deg)}
  .face{
    position:absolute;inset:0;
    backface-visibility:hidden;
    border-radius:12px;
    overflow:hidden;
    border:1px solid var(--line);
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .back{
    background:
      radial-gradient(circle at 20% 20%, rgba(214,178,110,.18), transparent 40%),
      linear-gradient(135deg, #1b2d26, #132018);
  }
  .front{
    transform:rotateY(180deg);
    background:#0d1411;
  }
  .front img{width:100%;height:100%;object-fit:cover}
  .narration{
    max-height:420px;
    overflow:auto;
  }
  .narration .line{
    font-size:13px;
    line-height:1.4;
    margin-bottom:8px;
  }
  .chip{
    display:inline-block;
    padding:2px 8px;
    border-radius:999px;
    border:1px solid var(--line);
    font-size:11px;
    color:var(--muted);
  }
</style>

<header>
  <h1>Tarot Reading <span class="chip" id="sessionStatus">waiting</span></h1>
</header>

<div class="wrap">
  <div class="panel">
    <div id="cardGrid" class="card-grid"></div>
  </div>
  <div class="panel">
    <h2 style="margin-top:0;font-size:14px;letter-spacing:.08em;color:var(--muted)">Narration</h2>
    <div class="narration" id="narrationFeed"></div>
  </div>
</div>

<script>
  const joinCode = "{JOIN}";
  const statusEl = document.getElementById("sessionStatus");
  const grid = document.getElementById("cardGrid");
  const narration = document.getElementById("narrationFeed");
  let currentState = null;

  async function fetchState(){
    const res = await fetch(`/api/tarot/sessions/${joinCode}/state?view=player`);
    const data = await res.json();
    if (!data.ok) return;
    currentState = data.state;
    render();
  }

  function render(){
    if (!currentState) return;
    statusEl.textContent = currentState.session.status || "created";
    grid.innerHTML = "";
    const backUrl = currentState.deck && currentState.deck.back_image ? currentState.deck.back_image : "";
    currentState.spread.positions.forEach(pos => {
      const draw = currentState.draw.find(d => d.position_id === pos.id);
      const slot = document.createElement("div");
      slot.className = "card-slot";
      const label = document.createElement("div");
      label.className = "label";
      label.textContent = `${pos.label} â€” ${pos.prompt || ""}`;
      slot.appendChild(label);

      const cardWrap = document.createElement("div");
      cardWrap.className = "card" + (draw && draw.revealed ? " revealed" : "");
      const inner = document.createElement("div");
      inner.className = "inner";
      const back = document.createElement("div");
      back.className = "face back";
      if (backUrl){
        back.style.backgroundImage = `linear-gradient(135deg, rgba(12,18,32,.4), rgba(12,18,32,.6)), url('${backUrl}')`;
        back.style.backgroundSize = "cover";
        back.style.backgroundPosition = "center";
      }
      const front = document.createElement("div");
      front.className = "face front";
      if (draw && draw.card && draw.card.image){
        const img = document.createElement("img");
        img.src = draw.card.image;
        front.appendChild(img);
      } else {
        front.textContent = draw && draw.card ? draw.card.name : "";
      }
      inner.appendChild(back);
      inner.appendChild(front);
      cardWrap.appendChild(inner);
      slot.appendChild(cardWrap);
      grid.appendChild(slot);
    });

    narration.innerHTML = "";
    (currentState.narration || []).slice().reverse().forEach(n => {
      const line = document.createElement("div");
      line.className = "line";
      line.textContent = n.text;
      narration.appendChild(line);
    });
  }

  function connectSSE(){
    const src = new EventSource(`/api/tarot/sessions/${joinCode}/stream?view=player`);
    src.onmessage = () => fetchState();
  }

  fetchState();
  connectSSE();
</script>
