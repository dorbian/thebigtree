<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tarot Reading</title>
<style>
  :root{
    --bg:#0b1310;
    --panel:#101a15;
    --panel-2:#0c1511;
    --text:#e7f2ea;
    --muted:#9fb4a6;
    --accent:#6bd4a2;
    --neutral:#e7ddc7;
    --neutral-2:#c8bfae;
    --line:rgba(255,255,255,.08);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:"Spectral","Georgia",serif;
    color:var(--text);
    background:
      radial-gradient(1200px 700px at 10% -10%, rgba(107,212,162,.18), transparent 60%),
      linear-gradient(180deg, #0a120f, #0f1713 40%, #0a120f);
    background-repeat:no-repeat;
    background-size:cover;
    background-attachment:fixed;
    overflow:hidden;
  }
  body::before{
    content:"";
    position:fixed;
    inset:0;
    background:radial-gradient(circle at 50% 20%, rgba(214,178,110,.12), transparent 55%);
    opacity:.5;
    pointer-events:none;
    animation:breath 18s ease-in-out infinite;
    z-index:0;
  }
  body::after{
    content:"";
    position:fixed;
    inset:0;
    background:linear-gradient(120deg, rgba(255,255,255,.04), transparent 60%);
    opacity:.15;
    pointer-events:none;
    z-index:0;
  }
  @keyframes breath{
    0%, 100%{opacity:.35}
    50%{opacity:.7}
  }
  header{
    padding:18px 22px;
    border-bottom:1px solid var(--line);
    position:relative;
    z-index:1;
  }
  header h1{margin:0;font-size:20px;letter-spacing:.05em}
  .subhead{
    padding:8px 22px 0;
    font-size:12px;
    color:var(--muted);
    display:flex;
    gap:12px;
    flex-wrap:wrap;
    align-items:center;
    position:relative;
    z-index:1;
  }
  .subhead .group{
    display:flex;
    gap:8px;
    align-items:center;
    flex-wrap:wrap;
  }
  .status-dot{
    width:8px;height:8px;border-radius:50%;
    background:#6bd4a2;
    display:inline-block;
    margin-right:6px;
  }
  .status-dot.off{background:#d18b8b}
  .status-dot.warn{background:#d6b26e}
  .wrap{
    padding:16px;
    display:grid;
    grid-template-columns: minmax(0, 1fr) minmax(240px, 0.6fr);
    gap:18px;
    align-items:start;
    position:relative;
    z-index:1;
  }
  .panel{
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:14px;
    padding:14px;
    box-shadow:0 12px 24px rgba(0,0,0,.28);
  }
  .panel.light{
    background:rgba(12,18,14,.5);
    border-color:rgba(214,178,110,.12);
  }
  .panel.spread{
    min-height:70vh;
    display:flex;
    flex-direction:column;
    justify-content:center;
  }
  .card-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));
    gap:20px;
    justify-items:center;
    align-items:center;
  }
  .card-slot{
    background:var(--panel-2);
    border:1px dashed var(--line);
    border-radius:14px;
    padding:10px;
    min-height:260px;
    width:100%;
    display:flex;
    flex-direction:column;
    align-items:center;
    position:relative;
  }
  .card-slot.revealed{
    box-shadow:0 0 18px rgba(214,178,110,.25), inset 0 0 12px rgba(0,0,0,.3);
  }
  .card-slot.reversed{
    box-shadow:0 0 18px rgba(107,212,162,.18), inset 0 0 12px rgba(0,0,0,.3);
  }
  .position-tag{
    position:absolute;
    top:10px;
    left:10px;
    padding:4px 10px;
    border-radius:999px;
    font-size:10px;
    letter-spacing:.08em;
    text-transform:uppercase;
    color:var(--neutral);
    background:rgba(8,12,10,.7);
    border:1px solid rgba(255,255,255,.14);
    z-index:3;
  }
  .card-slot:fullscreen{
    background:rgba(5,10,8,.95);
    border:none;
    padding:24px;
    align-items:center;
    justify-content:center;
  }
  .card-slot:fullscreen .label{
    display:none;
  }
  .card-slot:fullscreen .card{
    max-width:none;
    width:min(80vw, calc(80vh * 3 / 4.2));
  }
  .label{
    font-size:12px;
    color:var(--muted);
    margin-bottom:8px;
  }
  .card{
    width:100%;
    aspect-ratio:3/4.2;
    perspective:1000px;
    max-width:260px;
  }
  .card.dealt-hidden{
    visibility:hidden;
  }
  .card .inner{
    position:relative;
    width:100%;height:100%;
    transform-style:preserve-3d;
    transition:transform 1.1s ease;
  }
  .card.revealed .inner.reversed{
    transform:rotateY(180deg) rotateZ(180deg);
  }
  .card.revealed .inner{transform:rotateY(180deg)}
  .face{
    position:absolute;inset:0;
    backface-visibility:hidden;
    border-radius:12px;
    overflow:hidden;
    border:1px solid var(--line);
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .back{
    background:
      radial-gradient(circle at 20% 20%, rgba(214,178,110,.18), transparent 40%),
      linear-gradient(135deg, #1b2d26, #132018);
  }
  .front{
    transform:rotateY(180deg);
    background:#0d1411;
    position:relative;
    isolation:isolate;
  }
  .front::before{
    content:"";
    position:absolute;
    inset:0;
    background:var(--card-overlay, transparent);
    opacity:var(--card-overlay-opacity, .35);
    mix-blend-mode:screen;
    pointer-events:none;
    z-index:1;
  }
  .front::after{
    content:"";
    position:absolute;
    inset:10px;
    border-radius:10px;
    border:1px solid var(--card-frame, rgba(255,255,255,.16));
    box-shadow:var(--card-frame-shadow, none);
    pointer-events:none;
    z-index:1;
  }
  .front img{width:100%;height:100%;object-fit:cover;position:relative;z-index:0}
  .card-title{
    position:absolute;
    left:50%;
    right:auto;
    bottom:10px;
    transform:translateX(-50%);
    padding:6px 12px;
    font-size:12px;
    letter-spacing:var(--card-title-letter, .04em);
    text-transform:var(--card-title-transform, uppercase);
    color:var(--card-title-color, var(--text));
    font-size:var(--card-title-size, 12px);
    background:var(--card-title-bg, rgba(6,10,8,.65));
    font-family:var(--card-title-font, inherit);
    text-shadow:var(--card-title-shadow, none);
    border:1px solid var(--card-title-border, rgba(255,255,255,.2));
    border-radius:999px;
    min-width:60%;
    text-align:center;
    z-index:2;
  }
  .card-number{
    position:absolute;
    top:8px;
    left:50%;
    transform:translateX(-50%);
    padding:4px 10px;
    border-radius:999px;
    font-size:var(--card-number-size, 11px);
    letter-spacing:var(--card-number-letter, .08em);
    text-transform:var(--card-number-transform, uppercase);
    color:var(--card-number-color, var(--text));
    background:var(--card-number-bg, rgba(6,10,8,.7));
    border:1px solid var(--card-number-border, rgba(255,255,255,.2));
    z-index:2;
  }
  body[data-card-theme="classic"]{
    --card-overlay:radial-gradient(circle at 20% 10%, rgba(214,178,110,.35), transparent 55%),
      linear-gradient(180deg, rgba(10,12,12,.2), rgba(8,8,8,.65));
    --card-overlay-opacity:.45;
    --card-frame:rgba(214,178,110,.65);
    --card-frame-shadow:0 0 0 1px rgba(214,178,110,.25), inset 0 0 12px rgba(0,0,0,.35);
    --card-title-bg:linear-gradient(180deg, rgba(10,10,10,0), rgba(10,10,10,.85));
    --card-title-font:"Cinzel","Garamond","Georgia",serif;
    --card-title-shadow:0 2px 6px rgba(0,0,0,.6);
    --card-title-letter:.12em;
    --card-title-transform:uppercase;
    --card-title-border:rgba(214,178,110,.6);
    --card-number-letter:.16em;
    --card-number-transform:uppercase;
    --card-number-bg:rgba(18,12,6,.78);
    --card-number-border:rgba(214,178,110,.6);
  }
  body[data-card-theme="wood"]{
    --card-overlay:repeating-linear-gradient(45deg, rgba(104,68,36,.28) 0 8px, rgba(74,49,27,.28) 8px 16px),
      radial-gradient(circle at 50% 20%, rgba(162,111,58,.25), transparent 60%);
    --card-overlay-opacity:.5;
    --card-frame:rgba(141,99,58,.9);
    --card-frame-shadow:inset 0 0 0 2px rgba(63,41,24,.5), inset 0 8px 18px rgba(0,0,0,.35);
    --card-title-bg:linear-gradient(180deg, rgba(40,26,16,0), rgba(40,26,16,.85));
    --card-title-font:"Cormorant Garamond","Garamond","Georgia",serif;
    --card-title-color:#f0e6d6;
    --card-title-letter:.04em;
    --card-title-transform:none;
    --card-title-border:rgba(141,99,58,.85);
    --card-number-letter:.08em;
    --card-number-transform:none;
    --card-number-bg:rgba(52,34,20,.85);
    --card-number-border:rgba(141,99,58,.85);
  }
  body[data-card-theme="wood"] .card-title{
    text-transform:none;
    letter-spacing:.02em;
  }
  body[data-card-theme="neon"]{
    --card-overlay:radial-gradient(circle at 20% 20%, rgba(55,226,255,.25), transparent 45%),
      radial-gradient(circle at 80% 0%, rgba(255,82,205,.18), transparent 45%);
    --card-overlay-opacity:.65;
    --card-frame:rgba(70,240,255,.9);
    --card-frame-shadow:0 0 14px rgba(70,240,255,.45), inset 0 0 12px rgba(255,82,205,.25);
    --card-title-bg:linear-gradient(90deg, rgba(7,7,18,.7), rgba(7,7,18,.2));
    --card-title-font:"Orbitron","Trebuchet MS",sans-serif;
    --card-title-color:#e6fbff;
    --card-title-shadow:0 0 10px rgba(70,240,255,.65);
    --card-title-letter:.22em;
    --card-title-transform:uppercase;
    --card-title-border:rgba(70,240,255,.8);
    --card-number-letter:.22em;
    --card-number-transform:uppercase;
    --card-number-bg:rgba(6,8,20,.85);
    --card-number-border:rgba(70,240,255,.8);
  }
  body[data-card-theme="neon"] .card-title{
    letter-spacing:.18em;
  }
  .narration{
    max-height:420px;
    overflow:auto;
  }
  .deck-pile-wrap{
    display:flex;
    align-items:center;
    gap:10px;
    margin-bottom:10px;
  }
  .deck-pile{
    width:64px;
    aspect-ratio:3/4.2;
    border-radius:10px;
    border:1px solid var(--line);
    background:
      radial-gradient(circle at 20% 20%, rgba(214,178,110,.18), transparent 40%),
      linear-gradient(135deg, #1b2d26, #132018);
    background-size:cover;
    background-position:center;
    box-shadow:0 6px 16px rgba(0,0,0,.35);
  }
  .deck-label{
    font-size:11px;
    letter-spacing:.12em;
    text-transform:uppercase;
    color:var(--muted);
  }
  .fly-card{
    position:fixed;
    left:0;
    top:0;
    border-radius:10px;
    border:1px solid var(--line);
    background-size:cover;
    background-position:center;
    box-shadow:0 10px 24px rgba(0,0,0,.35);
    pointer-events:none;
    transition:transform .6s ease, opacity .6s ease;
    z-index:9999;
  }
  .narration .line{
    font-size:13px;
    line-height:1.4;
    margin-bottom:8px;
    opacity:.85;
    transition:opacity .6s ease;
  }
  .narration .line.fresh{
    animation:fadein 1.2s ease;
    opacity:1;
  }
  @keyframes fadein{
    from{opacity:0; transform:translateY(4px)}
    to{opacity:1; transform:translateY(0)}
  }
  .chip{
    display:inline-block;
    padding:2px 8px;
    border-radius:999px;
    border:1px solid var(--line);
    font-size:11px;
    color:var(--muted);
  }
  .notice{
  margin-bottom:10px;
  font-size:12px;
  color:var(--muted);
}
.session-overlay{
  position:fixed;
  inset:0;
  background:rgba(5,10,8,.82);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:80;
  padding:24px;
}
.session-overlay.show{
  display:flex;
}
.session-card{
  width:min(420px, 92vw);
  background:rgba(12,18,14,.92);
  border:1px solid rgba(214,178,110,.3);
  border-radius:16px;
  padding:18px;
  text-align:center;
  box-shadow:0 18px 40px rgba(0,0,0,.4);
}
.session-card h2{
  margin:0 0 8px 0;
  font-size:18px;
  letter-spacing:.08em;
  text-transform:uppercase;
  color:var(--neutral);
}
.session-card p{
  margin:0 0 14px 0;
  font-size:13px;
  color:var(--muted);
}
.session-actions{
  display:flex;
  flex-direction:column;
  gap:8px;
}
.session-actions .btn{
  width:100%;
}
.status-note{
  font-size:12px;
  color:var(--neutral-2);
}
.listen-indicator{
  display:inline-flex;
  align-items:center;
  gap:6px;
  font-size:11px;
  color:var(--neutral-2);
  opacity:0;
  transition:opacity .3s ease;
}
.listen-indicator.active{
  opacity:1;
}
.listen-indicator .pulse{
  width:6px;
  height:6px;
  border-radius:50%;
  background:var(--accent);
  animation:pulse 1.2s ease-in-out infinite;
}
@keyframes pulse{
  0%, 100%{transform:scale(1); opacity:.6}
  50%{transform:scale(1.6); opacity:1}
}
.btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:6px 12px;
  border-radius:999px;
  border:1px solid var(--line);
  background:rgba(8,14,12,.6);
  color:var(--text);
  font-size:12px;
  cursor:pointer;
}
</style>

<header>
  <h1>Tarot Reading <span class="chip" id="sessionStatus">waiting</span></h1>
</header>
<div class="subhead" style="justify-content:flex-end">
  <button class="btn" id="downloadShot" style="display:none">Download screenshot</button>
</div>
<div class="subhead">
  <div class="group">
    <span><span class="status-dot" id="connDot"></span><span id="connStatus">connecting</span></span>
    <span class="listen-indicator" id="listenIndicator"><span class="pulse"></span>Priestess is writing</span>
  </div>
  <div class="group">
    <span>Ritual: <strong id="joinCode"></strong></span>
    <span>Deck: <strong id="deckName">-</strong></span>
    <span>Spread: <strong id="spreadName">-</strong></span>
  </div>
  <div class="status-note" id="statusNote"></div>
</div>

<div class="wrap">
  <div class="panel spread">
    <div class="deck-pile-wrap">
      <div class="deck-pile" id="deckPile"></div>
      <div class="deck-label">Deck</div>
    </div>
    <div class="notice" id="waitingNote">Waiting for the reader to begin.</div>
    <div id="cardGrid" class="card-grid"></div>
  </div>
  <div class="panel light">
    <h2 style="margin-top:0;font-size:14px;letter-spacing:.08em;color:var(--muted)">Narration</h2>
    <div class="narration" id="narrationFeed"></div>
  </div>
</div>
<div class="session-overlay" id="sessionOverlay" aria-hidden="true">
  <div class="session-card">
    <h2>Reading Complete</h2>
    <p>Would you like to photograph this session before you leave?</p>
    <div class="session-actions">
      <button class="btn" id="downloadSession">Download session image</button>
      <button class="btn" id="continueSession">Continue</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
  const joinCode = "{JOIN}";
  const params = new URLSearchParams(location.search);
  const themeParam = params.get("card_theme");
  const themeLocked = params.has("card_theme");
  document.body.dataset.cardTheme = themeParam || "classic";

  function toggleFullscreen(target){
    if (!target || !target.requestFullscreen){
      return;
    }
    if (document.fullscreenElement){
      if (document.fullscreenElement === target){
        document.exitFullscreen();
      }
      return;
    }
    target.requestFullscreen().catch(() => {});
  }

  function parseRoman(value){
    const roman = String(value || "").trim().toUpperCase();
    if (!roman) return NaN;
    const map = {I:1, V:5, X:10, L:50, C:100, D:500, M:1000};
    let total = 0;
    let prev = 0;
    for (let i = roman.length - 1; i >= 0; i -= 1){
      const num = map[roman[i]];
      if (!num) return NaN;
      if (num < prev){
        total -= num;
      } else {
        total += num;
        prev = num;
      }
    }
    return total;
  }

  function parseCardNumber(value){
    const text = String(value).trim();
    if (!text) return NaN;
    if (/^\d+$/.test(text)) return parseInt(text, 10);
    return parseRoman(text);
  }

  function toRoman(num){
    const n = Number(num);
    if (!Number.isFinite(n) || n <= 0) return "";
    const map = [
      [1000, "M"], [900, "CM"], [500, "D"], [400, "CD"],
      [100, "C"], [90, "XC"], [50, "L"], [40, "XL"],
      [10, "X"], [9, "IX"], [5, "V"], [4, "IV"], [1, "I"]
    ];
    let out = "";
    let remaining = Math.floor(n);
    map.forEach(([val, sym]) => {
      while (remaining >= val){
        out += sym;
        remaining -= val;
      }
    });
    return out;
  }

  function formatCardNumber(value){
    if (String(value || "").trim() === "0") return "0";
    const num = parseCardNumber(value);
    if (num === 0) return "0";
    return num ? toRoman(num) || String(value || "") : "";
  }
  const statusEl = document.getElementById("sessionStatus");
  const grid = document.getElementById("cardGrid");
  const narration = document.getElementById("narrationFeed");
  const joinEl = document.getElementById("joinCode");
  const deckEl = document.getElementById("deckName");
  const spreadEl = document.getElementById("spreadName");
  const connDot = document.getElementById("connDot");
  const connStatus = document.getElementById("connStatus");
  const waitingNote = document.getElementById("waitingNote");
  const deckPile = document.getElementById("deckPile");
  const downloadShot = document.getElementById("downloadShot");
  const listenIndicator = document.getElementById("listenIndicator");
  const statusNote = document.getElementById("statusNote");
  const sessionOverlay = document.getElementById("sessionOverlay");
  const downloadSession = document.getElementById("downloadSession");
  const continueSession = document.getElementById("continueSession");
  let currentState = null;
  let sse = null;
  let redirected = false;
  const pendingDraws = [];
  const pendingReveals = new Set();
  let listenTimer = null;
  let statusTimer = null;
  let overlayTimer = null;
  let sessionImageData = null;
  let capturePending = false;

  joinEl.textContent = joinCode;

  async function fetchState(){
    const res = await fetch(`/api/tarot/sessions/${joinCode}/state?view=player`);
    const data = await res.json();
    if (!data.ok) return;
    currentState = data.state;
    render();
  }

  function render(){
    if (!currentState) return;
    const status = currentState.session.status || "created";
    if (!themeLocked){
      const deckTheme = currentState.deck ? currentState.deck.theme : "";
      document.body.dataset.cardTheme = deckTheme || "classic";
    }
    statusEl.textContent = status;
    if (downloadShot){
      downloadShot.style.display = ["finished", "ended", "closed"].includes(status) ? "inline-block" : "none";
    }
    deckEl.textContent = currentState.deck ? (currentState.deck.name || currentState.deck.deck_id || "-") : "-";
    spreadEl.textContent = currentState.spread ? (currentState.spread.name || currentState.spread.id || "-") : "-";
    if (["finished", "ended", "closed"].includes(status)){
      if (sessionImageData){
        showSessionOverlay();
      } else if (!capturePending){
        capturePending = true;
        setTimeout(() => {
          captureSessionImage().then((dataUrl) => {
            sessionImageData = dataUrl || null;
            showSessionOverlay();
          }).catch(() => {
            showSessionOverlay();
          }).finally(() => {
            capturePending = false;
          });
        }, 5000);
      }
    } else {
      hideSessionOverlay();
      sessionImageData = null;
      capturePending = false;
    }
    grid.innerHTML = "";
    const backUrl = currentState.deck && currentState.deck.back_image ? currentState.deck.back_image : "";
    if (deckPile){
      if (backUrl){
        deckPile.style.backgroundImage = `linear-gradient(135deg, rgba(12,18,32,.4), rgba(12,18,32,.6)), url('${backUrl}')`;
      } else {
        deckPile.style.backgroundImage = "";
      }
    }
    const draws = currentState.draw || [];
    const revealedCount = draws.filter(d => d.revealed).length;
    if (!draws.length){
      waitingNote.textContent = "Waiting for the reader to begin.";
      waitingNote.style.display = "block";
    } else if (revealedCount < draws.length){
      waitingNote.textContent = "Waiting for the next reveal.";
      waitingNote.style.display = "block";
    } else {
      waitingNote.textContent = "Waiting for the next card.";
      waitingNote.style.display = "block";
    }
    currentState.spread.positions.forEach(pos => {
      const draw = currentState.draw.find(d => d.position_id === pos.id);
      const slot = document.createElement("div");
      slot.className = "card-slot";
      const label = document.createElement("div");
      label.className = "label";
      label.textContent = `${pos.label}`;
      slot.appendChild(label);
      const tag = document.createElement("div");
      tag.className = "position-tag";
      tag.textContent = pos.label || "Position";
      slot.appendChild(tag);

      if (draw){
        const cardWrap = document.createElement("div");
        const shouldReveal = draw && draw.revealed;
        const animateReveal = shouldReveal && pendingReveals.has(pos.id);
        const animateDraw = pendingDraws.includes(pos.id);
        cardWrap.className = "card" + (shouldReveal && !animateReveal ? " revealed" : "");
        if (animateDraw){
          cardWrap.classList.add("dealt-hidden");
        }
        cardWrap.dataset.positionId = pos.id;
        if (draw.revealed){
          slot.classList.add("revealed");
        }
        if (draw.reversed){
          slot.classList.add("reversed");
        }
      const inner = document.createElement("div");
      inner.className = "inner";
      if (draw && draw.reversed){
        inner.classList.add("reversed");
      }
        const back = document.createElement("div");
        back.className = "face back";
        if (backUrl){
          back.style.backgroundImage = `linear-gradient(135deg, rgba(12,18,32,.4), rgba(12,18,32,.6)), url('${backUrl}')`;
          back.style.backgroundSize = "cover";
          back.style.backgroundPosition = "center";
        }
        const front = document.createElement("div");
        front.className = "face front";
        if (draw && draw.card && draw.card.image){
          const img = document.createElement("img");
          img.src = draw.card.image;
          front.appendChild(img);
        }
        if (draw && draw.card && draw.card.number !== undefined && draw.card.number !== null){
          const number = document.createElement("div");
          number.className = "card-number";
          number.textContent = formatCardNumber(draw.card.number);
          front.appendChild(number);
        }
        if (draw && draw.card && draw.card.name){
          const title = document.createElement("div");
          title.className = "card-title";
          title.textContent = draw.card.name;
          front.appendChild(title);
        }
        inner.appendChild(back);
        inner.appendChild(front);
        cardWrap.appendChild(inner);
        slot.appendChild(cardWrap);
        cardWrap.addEventListener("click", (event) => {
          event.stopPropagation();
          const fullscreenTarget = cardWrap.closest(".card-slot") || cardWrap;
          toggleFullscreen(fullscreenTarget);
        });
        if (animateReveal){
          requestAnimationFrame(() => {
            cardWrap.classList.add("revealed");
          });
          pendingReveals.delete(pos.id);
        }
      }
      grid.appendChild(slot);
    });

    narration.innerHTML = "";
    (currentState.narration || []).slice().reverse().forEach((n, idx) => {
      const line = document.createElement("div");
      line.className = "line";
      if (idx === 0){
        line.classList.add("fresh");
      }
      line.textContent = n.text;
      narration.appendChild(line);
    });
    if (pendingDraws.length){
      pendingDraws.splice(0).forEach(positionId => animateDraw(positionId));
    }
  }

  function animateDraw(positionId){
    if (!deckPile) return;
    const target = grid.querySelector(`[data-position-id="${positionId}"]`);
    if (!target) return;
    const from = deckPile.getBoundingClientRect();
    const to = target.getBoundingClientRect();
    const fly = document.createElement("div");
    fly.className = "fly-card";
    fly.style.width = `${from.width}px`;
    fly.style.height = `${from.height}px`;
    fly.style.left = `${from.left}px`;
    fly.style.top = `${from.top}px`;
    fly.style.backgroundImage = deckPile.style.backgroundImage || "";
    document.body.appendChild(fly);
    const dx = to.left - from.left;
    const dy = to.top - from.top;
    const scaleX = to.width / from.width;
    const scaleY = to.height / from.height;
    requestAnimationFrame(() => {
      fly.style.transform = `translate(${dx}px, ${dy}px) scale(${scaleX}, ${scaleY})`;
      fly.style.opacity = "0";
    });
    fly.addEventListener("transitionend", () => {
      const card = grid.querySelector(`[data-position-id="${positionId}"]`);
      if (card){
        card.classList.remove("dealt-hidden");
      }
      fly.remove();
    }, {once:true});
  }

  function showListenIndicator(){
    if (!listenIndicator) return;
    listenIndicator.classList.add("active");
    if (listenTimer){
      clearTimeout(listenTimer);
    }
    listenTimer = setTimeout(() => {
      listenIndicator.classList.remove("active");
    }, 2000);
  }

  function showStatusNote(text){
    if (!statusNote) return;
    statusNote.textContent = text;
    if (statusTimer){
      clearTimeout(statusTimer);
    }
    statusTimer = setTimeout(() => {
      statusNote.textContent = "";
    }, 2000);
  }

  function showSessionOverlay(){
    if (!sessionOverlay) return;
    sessionOverlay.classList.add("show");
    sessionOverlay.setAttribute("aria-hidden", "false");
    if (downloadSession){
      downloadSession.disabled = !sessionImageData;
    }
    if (overlayTimer){
      clearTimeout(overlayTimer);
    }
    overlayTimer = setTimeout(() => {
      if (redirected) return;
      redirected = true;
      sessionImageData = null;
      window.location.assign("/");
    }, 30000);
  }

  function hideSessionOverlay(){
    if (!sessionOverlay) return;
    sessionOverlay.classList.remove("show");
    sessionOverlay.setAttribute("aria-hidden", "true");
    if (overlayTimer){
      clearTimeout(overlayTimer);
      overlayTimer = null;
    }
  }

  function connectSSE(){
    if (sse){
      sse.close();
    }
    const src = new EventSource(`/api/tarot/sessions/${joinCode}/stream?view=player`);
    sse = src;
    src.onopen = () => {
      connDot.className = "status-dot";
      connStatus.textContent = "connected";
    };
    src.onerror = () => {
      connDot.className = "status-dot warn";
      connStatus.textContent = "reconnecting";
    };
    src.onmessage = (ev) => {
      try{
        const payload = JSON.parse(ev.data);
        if (payload.type === "CARD_DRAWN" && payload.data && payload.data.position_id){
          pendingDraws.push(payload.data.position_id);
          showStatusNote("Card drawn.");
        }
        if (payload.type === "CARD_REVEALED" && payload.data && payload.data.position_id){
          pendingReveals.add(payload.data.position_id);
          showStatusNote("Card revealed.");
        }
        if (payload.type === "PRIESTESS_TYPING" || payload.type === "NARRATION_TYPING"){
          showListenIndicator();
        }
      }catch(err){}
      fetchState();
    };
  }

  fetchState();
  connectSSE();
  setInterval(fetchState, 5000);

  if (downloadShot){
    downloadShot.addEventListener("click", async () => {
      if (!window.html2canvas) return;
      downloadShot.disabled = true;
      downloadShot.textContent = "Rendering...";
      try{
        const canvas = await window.html2canvas(document.body, {backgroundColor: null});
        const link = document.createElement("a");
        link.download = `tarot-session-${joinCode}.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();
      }catch(err){}
      downloadShot.disabled = false;
      downloadShot.textContent = "Download screenshot";
    });
  }

  if (downloadSession){
    downloadSession.addEventListener("click", async () => {
      if (!sessionImageData) return;
      const link = document.createElement("a");
      link.download = `tarot-session-${joinCode}.png`;
      link.href = sessionImageData;
      link.click();
    });
  }

  if (continueSession){
    continueSession.addEventListener("click", () => {
      if (redirected) return;
      redirected = true;
      sessionImageData = null;
      window.location.assign("/");
    });
  }

  async function captureSessionImage(){
    if (!window.html2canvas) return null;
    const overlayWasVisible = sessionOverlay && sessionOverlay.classList.contains("show");
    if (overlayWasVisible){
      sessionOverlay.classList.remove("show");
    }
    try{
      const canvas = await window.html2canvas(document.body, {backgroundColor: null});
      return canvas.toDataURL("image/png");
    }finally{
      if (overlayWasVisible){
        sessionOverlay.classList.add("show");
      }
    }
  }
</script>
