<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Poker</title>
  <link rel="icon" href="/icon.png" type="image/png">
  <style>
    body{margin:0;font-family:"Spectral","Georgia",serif;background:#0b1310;color:#e7f2ea;min-height:100vh;position:relative;overflow-x:hidden}
    body::before{content:"";position:fixed;inset:0;background:var(--bg-image) center/cover no-repeat;opacity:0;pointer-events:none;transition:opacity .6s ease}
    body.has-bg::before{opacity:.25}
    header{padding:18px;border-bottom:1px solid rgba(255,255,255,.08)}
    main{padding:18px;display:grid;gap:16px;justify-items:center}
    .panel{background:#101a15;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:14px;width:100%;max-width:980px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:center}
    .hand-grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit, minmax(240px, 1fr))}
    .hand-col{text-align:center}
    .hand{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
    .card{padding:6px 10px;border-radius:10px;background:#0c1511;border:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;min-width:80px;min-height:120px}
    .card.hidden{color:#9fb4a6;letter-spacing:.12em;text-transform:uppercase;background:linear-gradient(135deg, rgba(20,32,26,.7), rgba(10,18,14,.9));background-size:cover;background-position:center}
    .card img{max-width:120px;max-height:170px;border-radius:8px;display:block}
    .card.placeholder{opacity:.4;letter-spacing:.12em}
    .actions{display:flex;justify-content:center;gap:12px;flex-wrap:wrap}
    .actions button{padding:8px 12px;border-radius:999px;border:1px solid rgba(107,212,162,.4);background:#122019;color:#e7f2ea;cursor:pointer}
    .muted{color:#9fb4a6}
    .house-rules{color:#d6b26e;font-size:13px;letter-spacing:.02em}
    .stepper{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
    .step{padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.1);font-size:12px;color:#9fb4a6}
    .step.active{border-color:rgba(214,178,110,.6);color:#f2e2bf;background:rgba(214,178,110,.08)}
    .intent{color:#f2e2bf}
  </style>
</head>
<body>
  <header>
    <h1>Poker</h1>
    <div class="muted" id="statusLine">Waiting for session...</div>
  </header>
  <main>
    <div class="panel">
      <div class="row">
        <div>Pot: <strong id="potValue">0</strong> gil</div>
        <div>Player committed: <strong id="playerCommit">0</strong> gil</div>
        <div>Dealer liability: <strong id="dealerLiability">0</strong> gil</div>
      </div>
      <div class="row house-rules">Forest Hold'em - Dealer always calls. No re-raises.</div>
    </div>
    <div class="panel">
      <div class="row">
        <div>Role: <strong>Host</strong></div>
        <div>Join code: <strong id="joinCode">-</strong></div>
      </div>
      <div class="row">
        <button id="copyPlayerLink">Copy player link</button>
        <button id="createNext">Create next session</button>
      </div>
      <div class="muted" id="nextSessionLinks">No new session yet.</div>
    </div>
    <div class="panel">
      <div class="stepper" id="roundStepper">
        <span class="step" data-stage="preflop">Pre-Flop</span>
        <span class="step" data-stage="flop">Flop</span>
        <span class="step" data-stage="turn">Turn</span>
        <span class="step" data-stage="river">River</span>
        <span class="step" data-stage="showdown">Showdown</span>
      </div>
      <div class="muted" id="roundStatus">Waiting for round.</div>
    </div>
    <div class="panel">
      <div class="muted">Player action</div>
      <div class="intent" id="playerAction">Awaiting player action.</div>
    </div>
    <div class="panel">
      <div class="hand-grid">
        <div class="hand-col">
          <div class="muted">Player hand</div>
          <div class="hand" id="playerHand"></div>
        </div>
        <div class="hand-col">
          <div class="muted">Dealer hand</div>
          <div class="hand" id="dealerHand"></div>
        </div>
      </div>
    </div>
    <div class="panel">
      <div class="muted">Community</div>
      <div class="hand" id="communityCards"></div>
    </div>
    <div class="panel">
      <div class="muted" id="resultLine">Result: --</div>
    </div>
    <div class="panel actions">
      <button id="startBtn">Start</button>
      <button id="finishBtn">Finish</button>
    </div>
    <div class="panel" id="artistPanel">
      <div class="muted">Artist credits</div>
      <div id="artistCredits" class="muted">No artist credits.</div>
    </div>
  </main>
<script>
  const joinCode = "{JOIN}";
  const gameId = "poker";
  const statusLine = document.getElementById("statusLine");
  const potValue = document.getElementById("potValue");
  const playerCommit = document.getElementById("playerCommit");
  const dealerLiability = document.getElementById("dealerLiability");
  const playerHand = document.getElementById("playerHand");
  const dealerHand = document.getElementById("dealerHand");
  const communityCards = document.getElementById("communityCards");
  const resultLine = document.getElementById("resultLine");
  const joinCodeEl = document.getElementById("joinCode");
  const copyPlayerLink = document.getElementById("copyPlayerLink");
  const createNext = document.getElementById("createNext");
  const nextSessionLinks = document.getElementById("nextSessionLinks");
  const startBtn = document.getElementById("startBtn");
  const finishBtn = document.getElementById("finishBtn");
  const artistPanel = document.getElementById("artistPanel");
  const artistCredits = document.getElementById("artistCredits");
  const roundStepper = document.getElementById("roundStepper");
  const roundStatus = document.getElementById("roundStatus");
  const playerAction = document.getElementById("playerAction");
  const token = new URLSearchParams(window.location.search).get("token") || "";
  let sessionId = "";
  let sessionState = null;

  const STAGE_LABELS = {
    preflop: "Pre-Flop",
    flop: "Flop",
    turn: "Turn",
    river: "River",
    showdown: "Showdown"
  };

  function cardLabel(card){
    if (!card) return "?";
    const suitMap = {spades:"S", hearts:"H", diamonds:"D", clubs:"C"};
    return `${card.rank || "?"}${suitMap[card.suit] || ""}`;
  }

  function renderHiddenHand(el, count, backUrl){
    const total = Math.max(2, count || 0);
    el.innerHTML = Array.from({length: total}).map(() => {
      if (backUrl){
        return `<div class="card hidden" style="background-image:linear-gradient(135deg, rgba(12,18,32,.4), rgba(12,18,32,.6)), url('${backUrl}')"></div>`;
      }
      return `<div class="card hidden">Hidden</div>`;
    }).join("");
  }

  function renderHand(el, hand){
    if (el === playerHand){
      const count = sessionState && sessionState.state ? sessionState.state.player_hand_count : 0;
      const backUrl = sessionState && sessionState.state ? sessionState.state.player_hand_back : "";
      renderHiddenHand(el, count || (hand || []).length, backUrl);
      return;
    }
    el.innerHTML = (hand || []).map(card => {
      if (card && card.image){
        return `<div class="card"><img src="${card.image}" alt="${cardLabel(card)}"></div>`;
      }
      return `<div class="card">${cardLabel(card)}</div>`;
    }).join("");
  }

  function renderCommunity(hand, stage){
    const revealCount = stage === "flop" ? 3 : stage === "turn" ? 4 : stage === "river" || stage === "showdown" ? 5 : 0;
    const slots = [];
    for (let i = 0; i < 5; i++){
      const card = hand[i];
      if (i < revealCount && card){
        if (card.image){
          slots.push(`<div class="card"><img src="${card.image}" alt="${cardLabel(card)}"></div>`);
        }else{
          slots.push(`<div class="card">${cardLabel(card)}</div>`);
        }
      }else{
        slots.push(`<div class="card placeholder">?</div>`);
      }
    }
    communityCards.innerHTML = slots.join("");
  }

  function collectArtists(cards){
    const artists = [];
    (cards || []).forEach(card => {
      if (!card) return;
      const name = card.artist_name || card.artist || card.artist_id || "";
      if (name && !artists.includes(name)){
        artists.push(name);
      }
    });
    return artists;
  }

  function renderArtists(cards){
    const names = collectArtists(cards);
    if (!names.length){
      artistCredits.textContent = "No artist credits.";
      if (artistPanel) artistPanel.style.display = "none";
      return;
    }
    if (artistPanel) artistPanel.style.display = "";
    artistCredits.innerHTML = names.map(n => `<div>${n}</div>`).join("");
  }

  function applyBackground(url){
    if (!url){
      document.body.classList.remove("has-bg");
      document.body.style.removeProperty("--bg-image");
      return;
    }
    document.body.style.setProperty("--bg-image", `url('${url}')`);
    document.body.classList.add("has-bg");
  }

  function renderStepper(stage){
    const steps = roundStepper.querySelectorAll(".step");
    steps.forEach(step => {
      const key = step.dataset.stage;
      step.classList.toggle("active", key === stage);
    });
  }

  function resultCopy(state){
    if (!state) return "Result: --";
    const reason = state.ended_reason;
    if (reason === "fold"){
      return "Player folded. Dealer wins the pot.";
    }
    const result = state.result;
    const playerRank = state.player_rank ? state.player_rank.replace(/_/g, " ") : "";
    const dealerRank = state.dealer_rank ? state.dealer_rank.replace(/_/g, " ") : "";
    if (result === "player") return `Player wins - ${playerRank} beats ${dealerRank}.`; 
    if (result === "dealer") return `Dealer wins - ${dealerRank} beats ${playerRank}.`;
    if (result === "push") return "Push. The pot is split.";
    return "Result: --";
  }

  function actionCopy(action){
    if (!action) return "Awaiting player action.";
    const amt = action.amount ? ` ${action.amount} gil` : "";
    if (action.action === "bet") return `Bet${amt} (${STAGE_LABELS[action.stage] || ""})`;
    if (action.action === "raise") return `Raise${amt} (${STAGE_LABELS[action.stage] || ""})`;
    if (action.action === "check") return "Check";
    if (action.action === "call") return "Call";
    if (action.action === "fold") return "Folded";
    return action.action || "Awaiting player action.";
  }

  async function postAdmin(path){
    if (!token){
      statusLine.textContent = "Missing priestess token.";
      return;
    }
    if (!sessionId) return;
    try{
      const res = await fetch(`/api/cardgames/${gameId}/sessions/${sessionId}/${path}`, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({token})
      });
      const data = await res.json();
      if (!data.ok){
        statusLine.textContent = data.error || "Action failed.";
      }
    }catch(err){
      statusLine.textContent = "Action failed.";
    }
    loadState();
  }

  function render(state){
    if (!state || !state.session) return;
    sessionId = state.session.session_id || "";
    sessionState = state;
    joinCodeEl.textContent = state.session.join_code || "-";
    const pot = state.state && typeof state.state.pot === "number" ? state.state.pot : (state.session.pot || 0);
    potValue.textContent = pot;
    playerCommit.textContent = state.state && state.state.player_commit != null ? state.state.player_commit : 0;
    dealerLiability.textContent = pot;
    statusLine.textContent = `Status: ${state.session.status}`;
    applyBackground(state.session.background_url || "");
    const player = (state.state && state.state.player_hand) || [];
    const dealer = (state.state && state.state.dealer_hand) || [];
    const community = (state.state && state.state.community) || [];
    renderHand(playerHand, player);
    renderHand(dealerHand, dealer);
    renderCommunity(community, (state.state && state.state.stage) || "preflop");
    renderArtists(player.concat(dealer).concat(community));
    const stage = (state.state && state.state.stage) || "preflop";
    renderStepper(stage);
    roundStatus.textContent = `Current round: ${STAGE_LABELS[stage] || stage}`;
    playerAction.textContent = actionCopy(state.state && state.state.last_action);
    resultLine.textContent = resultCopy(state.state || {});
    const status = state.session.status;
    startBtn.disabled = status !== "created";
    finishBtn.disabled = status === "finished";
    createNext.disabled = status !== "live";
  }

  startBtn.addEventListener("click", () => postAdmin("start"));
  finishBtn.addEventListener("click", () => postAdmin("finish"));
  copyPlayerLink.addEventListener("click", async () => {
    const url = `${window.location.origin}/cardgames/${gameId}/session/${joinCode}`;
    try{
      await navigator.clipboard.writeText(url);
      nextSessionLinks.textContent = "Player link copied.";
    }catch(err){
      nextSessionLinks.textContent = url;
    }
  });
  createNext.addEventListener("click", async () => {
    if (!sessionState || !sessionState.session){
      nextSessionLinks.textContent = "Session not ready yet.";
      return;
    }
    try{
      const res = await fetch(`/api/cardgames/${gameId}/sessions/${sessionId}/clone`, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({token})
      });
      const data = await res.json();
      if (!data || !data.session){
        nextSessionLinks.textContent = (data && data.error) ? data.error : "Failed to create session.";
        return;
      }
      const newJoin = data.session.join_code || "";
      const hostToken = data.session.priestess_token || "";
      const playerUrl = `${window.location.origin}/cardgames/${gameId}/session/${newJoin}`;
      const hostUrl = `${window.location.origin}/cardgames/${gameId}/session/${newJoin}?view=priestess&token=${encodeURIComponent(hostToken)}`;
      nextSessionLinks.innerHTML = `Next session: <a href="${playerUrl}" target="_blank" rel="noreferrer">Player</a> | <a href="${hostUrl}" target="_blank" rel="noreferrer">Host</a>`;
      window.open(hostUrl, "_blank");
    }catch(err){
      nextSessionLinks.textContent = "Failed to create session.";
    }
  });

  async function loadState(){
    const res = await fetch(`/api/cardgames/${gameId}/sessions/${joinCode}/state?view=priestess`);
    const data = await res.json();
    if (data && data.ok && data.state){
      render(data.state);
    }else if (data && data.redirect){
      statusLine.textContent = "Session closed.";
      startBtn.disabled = true;
      finishBtn.disabled = true;
    }
  }

  const src = new EventSource(`/api/cardgames/${gameId}/sessions/${joinCode}/stream?view=priestess`);
  src.onmessage = (ev) => {
    try{
      const payload = JSON.parse(ev.data);
      if (payload.type === "STATE" && payload.state){
        render(payload.state);
      }else if (payload.type === "SESSION_GONE"){
        statusLine.textContent = "Session closed.";
        startBtn.disabled = true;
        finishBtn.disabled = true;
      }else{
        loadState();
      }
    }catch(err){}
  };
  loadState();
  setInterval(() => {
    if (!document.hidden) loadState();
  }, 3000);
</script>
</body>
</html>
