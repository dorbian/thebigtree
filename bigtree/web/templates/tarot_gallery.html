<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Forest Gallery</title>
<link rel="icon" href="/icon.png" type="image/png">
<meta name="description" content="A shrine of offerings left by those who sustain the Forest.">
<meta property="og:title" content="Forest Gallery">
<meta property="og:description" content="A shrine of offerings left by those who sustain the Forest.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://rites.thebigtree.life/">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Forest Gallery">
<meta name="twitter:description" content="A shrine of offerings left by those who sustain the Forest.">
<style>
  :root{
    --bg:#0b1310;
    --panel:#101a15;
    --panel-2:#0c1511;
    --text:#e7f2ea;
    --muted:#9fb4a6;
    --accent:#6bd4a2;
    --accent-2:#d6b26e;
    --neutral:#e7ddc7;
    --neutral-2:#c8bfae;
    --line:rgba(255,255,255,.08);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:"Spectral","Georgia",serif;
    color:var(--text);
    background:
      radial-gradient(1200px 700px at 10% -10%, rgba(107,212,162,.18), transparent 60%),
      linear-gradient(180deg, #0a120f, #0f1713 40%, #0a120f);
    background-repeat:no-repeat;
    background-size:cover;
    background-attachment:fixed;
  }
  body::before{
    content:"";
    position:fixed;
    inset:0;
    background:radial-gradient(circle at 50% 20%, rgba(214,178,110,.12), transparent 55%);
    opacity:.5;
    pointer-events:none;
    animation:breath 18s ease-in-out infinite;
    z-index:0;
  }
  body::after{
    content:"";
    position:fixed;
    inset:0;
    background:linear-gradient(120deg, rgba(255,255,255,.04), transparent 60%);
    opacity:.15;
    pointer-events:none;
    z-index:0;
  }
  @keyframes breath{
    0%, 100%{opacity:.35}
    50%{opacity:.7}
  }
  header{
    padding:22px;
    border-bottom:1px solid var(--line);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:16px;
    position:relative;
    z-index:1;
  }
  .header-actions{
    display:flex;
    gap:10px;
    align-items:center;
  }
  .icon-link{
    width:36px;
    height:36px;
    border-radius:10px;
    border:1px solid rgba(107,212,162,.35);
    display:inline-flex;
    align-items:center;
    justify-content:center;
    color:var(--accent);
    text-decoration:none;
  }
  .icon-link svg{
    width:18px;
    height:18px;
    fill:currentColor;
  }
  header h1{margin:0 0 6px 0;letter-spacing:.08em;text-transform:uppercase}
  header p{margin:0;color:var(--muted)}
  .header-subtitle{
    font-size:13px;
    color:var(--neutral);
  }
  .header-context{
    font-size:12px;
    color:var(--muted);
    margin-top:4px;
  }
  .admin-link{
    color:var(--accent);
    text-decoration:none;
    font-size:13px;
    border:1px solid rgba(107,212,162,.35);
    padding:8px 12px;
    border-radius:999px;
    background:#0f1a14;
    white-space:nowrap;
  }
  .admin-link:hover{border-color:rgba(107,212,162,.7)}
  main{padding:20px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:end}
  label{color:var(--muted);font-size:12px}
  input, button{
    padding:8px 10px;
    border-radius:10px;
    border:1px solid var(--line);
    background:#0c1511;
    color:var(--text);
    font-family:inherit;
    font-size:14px;
  }
  button{background:#122019;border-color:rgba(107,212,162,.4);cursor:pointer}
  .grid{
    margin-top:16px;
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));
    column-gap:14px;
    row-gap:20px;
    grid-auto-rows:1fr;
    position:relative;
    z-index:1;
  }
  .grid.virtualized{
    position:relative;
    display:block;
  }
  .grid.virtualized .card{
    position:absolute;
    width:var(--card-width, 220px);
    height:var(--card-height, 420px);
  }
  .grid.filtering .card{opacity:.5}
  .grid.filtering .card.active{opacity:1}
  .artist-link{
    color:var(--accent);
    text-decoration:none;
    font-size:12px;
    cursor:pointer;
    display:inline-block;
    margin:2px 0 6px 0;
  }
  .card{
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:14px;
    padding:10px;
    display:flex;
    flex-direction:column;
    gap:6px;
    min-height:100%;
    position:relative;
    overflow:hidden;
    transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease;
    box-shadow:0 12px 22px rgba(0,0,0,.22);
  }
  .grid.virtualized .card{
    height:var(--card-height, 360px);
  }
  .work-title,
  .origin{
    display:-webkit-box;
    -webkit-line-clamp:1;
    -webkit-box-orient:vertical;
    overflow:hidden;
  }
  .pill-row,
  .reaction-row{
    max-height:26px;
    overflow:hidden;
  }
  .card:hover{
    transform:translateY(-3px);
    border-color:rgba(214,178,110,.35);
    box-shadow:0 16px 28px rgba(0,0,0,.3);
  }
  .card:hover .origin,
  .card:hover .muted{
    color:var(--neutral-2);
  }
  .card img{
    width:100%;
    border-radius:10px;
    margin:0;
    aspect-ratio:3/3.6;
    object-fit:cover;
    background:var(--panel-2);
  }
  .card-media{
    position:relative;
    border-radius:12px;
    overflow:hidden;
  }
  .card-media::after{
    content:"";
    position:absolute;
    inset:0;
    box-shadow:inset 0 -40px 50px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.06);
    pointer-events:none;
  }
  .card-media::before{
    content:"";
    position:absolute;
    inset:0;
    background:radial-gradient(circle at 50% 20%, rgba(255,255,255,.08), transparent 55%);
    opacity:.6;
    pointer-events:none;
  }
  .card-body{
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  .artist-name{
    font-size:15px;
    letter-spacing:.04em;
    color:var(--neutral);
  }
  .work-title{
    font-size:13px;
    color:var(--text);
  }
  .origin{
    font-size:11px;
    color:var(--muted);
    text-transform:uppercase;
    letter-spacing:.06em;
  }
  .pill-row{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
  }
  .type-pill{
    display:inline-flex;
    padding:3px 8px;
    border-radius:999px;
    border:1px solid rgba(214,178,110,.4);
    color:var(--accent-2);
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:.08em;
  }
  .tag-pill{
    display:inline-flex;
    padding:3px 8px;
    border-radius:999px;
    border:1px solid rgba(107,212,162,.3);
    color:var(--accent);
    font-size:11px;
  }
  .reaction-row{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    margin-top:4px;
  }
  .reaction{
    display:inline-flex;
    align-items:center;
    gap:6px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.1);
    background:rgba(8,14,12,.45);
    padding:4px 8px;
    font-size:11px;
    color:var(--neutral-2);
    cursor:pointer;
  }
  .reaction span{
    color:var(--accent);
  }
  .card-actions{
    display:flex;
    justify-content:flex-end;
    margin-top:4px;
  }
  .view-btn{
    border-radius:999px;
    border:1px solid rgba(214,178,110,.4);
    background:rgba(18,22,18,.6);
    color:var(--neutral);
    padding:6px 12px;
    font-size:12px;
    cursor:pointer;
  }
  .view-btn:disabled{
    opacity:.5;
    cursor:not-allowed;
  }
  .muted{color:var(--muted);font-size:12px}
  .links a{color:var(--accent);text-decoration:none;margin-right:8px;font-size:12px}
  .skeleton-card{
    height:320px;
    border-radius:14px;
    background:linear-gradient(110deg, rgba(12,18,15,.8) 8%, rgba(20,28,23,.9) 18%, rgba(12,18,15,.8) 33%);
    background-size:200% 100%;
    animation:shimmer 1.4s infinite;
  }
  @keyframes shimmer{
    to{background-position:-200% 0}
  }
  .modal{
    position:fixed;
    inset:0;
    background:rgba(4,10,8,.72);
    display:none;
    align-items:center;
    justify-content:center;
    padding:24px;
    z-index:50;
  }
  .modal.show{display:flex}
  .modal-card{
    max-width:420px;
    width:100%;
    background:#0f1814;
    border:1px solid var(--line);
    border-radius:16px;
    padding:18px;
  }
  .modal-card h2{margin:0 0 10px 0;font-size:20px}
  .artist-focus{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    margin-bottom:10px;
  }
  .artist-filter{
    border-radius:999px;
    padding:6px 12px;
    border:1px solid rgba(214,178,110,.35);
    background:rgba(12,18,15,.6);
    color:var(--neutral);
    font-size:12px;
    cursor:pointer;
  }
  .filter-chip{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(214,178,110,.35);
    color:var(--neutral);
    font-size:12px;
  }
  .filter-chip button{
    background:transparent;
    border:none;
    color:var(--neutral);
    cursor:pointer;
  }
  .modal-links a{
    display:inline-block;
    margin:0 8px 8px 0;
    color:var(--accent);
    text-decoration:none;
    font-size:13px;
  }
  .modal-close{
    margin-top:12px;
    width:100%;
  }
  .image-modal{
    position:fixed;
    inset:0;
    background:rgba(4,10,8,.9);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:70;
  }
  .image-modal.show{display:flex}
  .image-modal img{
    max-width:92vw;
    max-height:90vh;
    border-radius:16px;
    box-shadow:0 20px 60px rgba(0,0,0,.5);
  }
  .image-modal .info{
    position:absolute;
    top:16px;
    left:18px;
    color:var(--text);
    background:rgba(12,18,15,.85);
    border:1px solid var(--line);
    border-radius:10px;
    padding:8px 12px;
    font-size:13px;
    opacity:0;
    transition:opacity .2s ease;
  }
  .image-modal.show-info .info{opacity:1}
  .image-modal .close{
    position:absolute;
    top:12px;
    right:12px;
    width:36px;
    height:36px;
    border-radius:999px;
    border:1px solid var(--line);
    background:rgba(12,18,15,.9);
    color:var(--text);
    font-size:18px;
    cursor:pointer;
  }
</style>
</head>
<body>

<header>
  <div>
    <h1>Forest Gallery</h1>
    <p class="header-subtitle">A shrine of offerings left by those who sustain the Forest.</p>
    <p class="header-context">All works here were offered during rites, gatherings, or games.</p>
  </div>
  <div class="header-actions">
    <a class="icon-link" href="/tarot/calendar" aria-label="Forest calendar">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M7 2h2v2h6V2h2v2h3a1 1 0 0 1 1 1v15a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a1 1 0 0 1 1-1h4V2zm-3 6v12h16V8H4zm2 2h4v4H6v-4z"/>
      </svg>
    </a>
    <a class="icon-link" href="/overlay" target="_blank" rel="noreferrer" aria-label="Admin overlay">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M12 2a4 4 0 0 1 4 4v2h2a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2V6a4 4 0 0 1 4-4zm-2 6h4V6a2 2 0 1 0-4 0v2z"/>
      </svg>
    </a>
    <a class="icon-link" href="https://join.thebigtree.life" target="_blank" rel="noreferrer" aria-label="Join the Forest on Discord">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M20.5 4.6A18.5 18.5 0 0 0 16 3c-.2.4-.5 1-.6 1.4-1.7-.3-3.4-.3-5.1 0-.2-.5-.4-1-.6-1.4-1.6.4-3.1 1-4.5 1.6-2.9 4.3-3.7 8.5-3.3 12.6 2 1.5 3.9 2.4 5.9 3 .5-.7 1-1.5 1.3-2.3-.7-.2-1.4-.5-2-.9.2-.1.3-.3.5-.4 3.7 1.7 7.8 1.7 11.4 0 .2.1.3.3.5.4-.6.4-1.3.7-2 .9.4.8.8 1.6 1.3 2.3 2-.6 3.9-1.5 5.9-3 .5-4.1-.4-8.3-3.3-12.6zM9.5 15.4c-1.1 0-2-1-2-2.2 0-1.2.9-2.2 2-2.2s2 1 2 2.2c0 1.2-.9 2.2-2 2.2zm5 0c-1.1 0-2-1-2-2.2 0-1.2.9-2.2 2-2.2s2 1 2 2.2c0 1.2-.9 2.2-2 2.2z"/>
      </svg>
    </a>
  </div>
</header>

<main>
  <div class="row" id="filterRow" style="margin-bottom:10px;display:none">
    <div class="filter-chip">Artist: <span id="filterName">-</span> <button id="filterClear" aria-label="Clear filter">x</button></div>
  </div>
  <div class="grid" id="grid"></div>
</main>

<div class="modal" id="artistModal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal-card">
    <div class="artist-focus">
      <h2 id="artistName">Artist</h2>
      <button class="artist-filter" id="artistFilterBtn">View all works</button>
    </div>
    <div class="modal-links" id="artistLinks"></div>
    <button class="modal-close" id="artistClose">Close</button>
  </div>
</div>
<div class="image-modal" id="imageModal" aria-hidden="true">
  <div class="info" id="imageInfo"></div>
  <button class="close" id="imageClose" aria-label="Close">X</button>
  <img id="imageModalImg" alt="">
</div>

<script>
  const grid = document.getElementById("grid");
  const artistModal = document.getElementById("artistModal");
  const artistName = document.getElementById("artistName");
  const artistLinks = document.getElementById("artistLinks");
  const artistFilterBtn = document.getElementById("artistFilterBtn");
  const filterRow = document.getElementById("filterRow");
  const filterName = document.getElementById("filterName");
  const filterClear = document.getElementById("filterClear");
  const imageModal = document.getElementById("imageModal");
  const imageModalImg = document.getElementById("imageModalImg");
  const imageInfo = document.getElementById("imageInfo");
  let imageInfoTimer = null;
  let galleryItems = [];
  let galleryRenderItems = [];
  let virtualCardHeight = 0;
  let virtualCols = 0;
  let virtualFrame = null;
  let virtualListening = false;
  const CARD_MIN_WIDTH = 220;
  const VIRTUAL_BUFFER_ROWS = 2;
  const PAGE_SIZE = 120;
  let gallerySeed = null;
  let galleryTotal = 0;
  let galleryLoading = false;
  let activeArtistFilter = null;
  const REACTIONS = [
    {id:"appreciation", label:"Appreciation"},
    {id:"inspired", label:"Inspired"},
    {id:"gratitude", label:"Gratitude"},
    {id:"craft", label:"Craft"}
  ];

  function link(label, url){
    if (!url) return "";
    return `<a href="${url}" target="_blank" rel="noreferrer">${label}</a>`;
  }

  function openArtistModal(name, links){
    artistName.textContent = name || "Forest";
    if (artistFilterBtn){
      artistFilterBtn.dataset.artist = name || "Forest";
    }
    const linkItems = Object.entries(links || {})
      .filter(([, url]) => url)
      .map(([label, url]) => `<a href="${url}" target="_blank" rel="noreferrer">${label}</a>`);
    artistLinks.innerHTML = linkItems.length ? linkItems.join("") : "<span class='muted'>No external links shared.</span>";
    artistModal.classList.add("show");
    artistModal.setAttribute("aria-hidden", "false");
  }

  function closeArtistModal(){
    artistModal.classList.remove("show");
    artistModal.setAttribute("aria-hidden", "true");
  }

  function showImageInfo(){
    imageModal.classList.add("show-info");
    if (imageInfoTimer) clearTimeout(imageInfoTimer);
    imageInfoTimer = setTimeout(() => {
      imageModal.classList.remove("show-info");
    }, 2000);
  }

  function openImageModal(data){
    imageModalImg.onerror = null;
    imageModalImg.src = data.url;
    imageModalImg.alt = data.title || "";
    if (data.fallback_url){
      imageModalImg.dataset.fallback = data.fallback_url;
      imageModalImg.onerror = () => {
        if (imageModalImg.dataset.fallback && imageModalImg.src !== imageModalImg.dataset.fallback){
          imageModalImg.src = imageModalImg.dataset.fallback;
        }
      };
    }else{
      imageModalImg.dataset.fallback = "";
    }
    imageInfo.textContent = data.info || "";
    imageModal.classList.add("show");
    imageModal.setAttribute("aria-hidden", "false");
    showImageInfo();
  }

  function closeImageModal(){
    imageModal.classList.remove("show");
    imageModal.setAttribute("aria-hidden", "true");
    imageModalImg.src = "";
    imageInfo.textContent = "";
  }

  async function loadBatch(offset){
    if (galleryLoading) return;
    galleryLoading = true;
    try{
      const seedParam = gallerySeed !== null ? `&seed=${gallerySeed}` : "";
      const res = await fetch(`/api/gallery/images?limit=${PAGE_SIZE}&offset=${offset}${seedParam}`);
      const data = await res.json();
      if (!data.ok){
        if (!galleryItems.length){
          grid.innerHTML = "<div class='muted'>Gallery unavailable.</div>";
        }
        return;
      }
      if (gallerySeed === null && Number.isFinite(data.seed)){
        gallerySeed = data.seed;
      }
      galleryTotal = Number(data.total) || 0;
      const batch = data.items || [];
      if (offset === 0){
        galleryItems = batch;
      }else{
        galleryItems = galleryItems.concat(batch);
      }
      renderGrid();
      if (galleryItems.length < galleryTotal){
        const nextOffset = galleryItems.length;
        if ("requestIdleCallback" in window){
          requestIdleCallback(() => loadBatch(nextOffset));
        }else{
          setTimeout(() => loadBatch(nextOffset), 60);
        }
      }
    }catch(err){
      if (!galleryItems.length){
        grid.innerHTML = "<div class='muted'>Gallery unavailable.</div>";
      }
    }finally{
      galleryLoading = false;
    }
  }

  async function load(){
    grid.innerHTML = Array.from({length: 8}).map(() => `<div class="skeleton-card"></div>`).join("");
    galleryItems = [];
    gallerySeed = null;
    galleryTotal = 0;
    activeArtistFilter = null;
    if (filterRow) filterRow.style.display = "none";
    await loadBatch(0);
  }

  document.getElementById("artistClose").addEventListener("click", closeArtistModal);
  artistModal.addEventListener("click", (event) => {
    if (event.target === artistModal) closeArtistModal();
  });
  if (artistFilterBtn){
    artistFilterBtn.addEventListener("click", () => {
      const name = artistFilterBtn.dataset.artist || "";
      closeArtistModal();
      if (name){
        applyArtistFilter(name);
      }
    });
  }
  if (filterClear){
    filterClear.addEventListener("click", () => applyArtistFilter(null));
  }
  document.getElementById("imageClose").addEventListener("click", closeImageModal);
  imageModal.addEventListener("click", (event) => {
    if (event.target === imageModal) closeImageModal();
  });
  imageModal.addEventListener("mousemove", showImageInfo);
  grid.addEventListener("click", (event) => {
    const target = event.target;
    if (target.tagName === "IMG" && target.getAttribute("data-full")){
      event.preventDefault();
      const payload = target.getAttribute("data-full");
      if (!payload) return;
      try{
        const parsed = JSON.parse(decodeURIComponent(payload));
        openImageModal(parsed);
      }catch (err){}
      return;
    }
    if (target.classList && target.classList.contains("view-btn")){
      event.preventDefault();
      const payload = target.getAttribute("data-full");
      if (!payload) return;
      try{
        const parsed = JSON.parse(decodeURIComponent(payload));
        openImageModal(parsed);
      }catch (err){}
      return;
    }
    if (target.classList && target.classList.contains("reaction")){
      event.preventDefault();
      const reactionId = target.getAttribute("data-reaction");
      const itemKey = target.getAttribute("data-item");
      if (!reactionId || !itemKey) return;
      const decodedKey = decodeURIComponent(itemKey);
      postReaction(decodedKey, reactionId);
      return;
    }
    if (!target.classList || !target.classList.contains("artist-link")) return;
    event.preventDefault();
    const payload = target.getAttribute("data-artist");
    if (!payload) return;
    try{
      const parsed = JSON.parse(decodeURIComponent(payload));
      openArtistModal(parsed.name, parsed.links);
    }catch (err){
      openArtistModal("Forest", {});
    }
  });
  window.addEventListener("keydown", (event) => {
    if (event.key === "Escape" && imageModal.classList.contains("show")){
      closeImageModal();
    }
  });
  load();

  async function postReaction(itemId, reactionId){
    try{
      const res = await fetch("/api/gallery/reactions", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({item_id: itemId, reaction: reactionId})
      });
      const data = await res.json();
      if (!data.ok) return;
      const match = galleryItems.find(item => getItemKey(item) === itemId);
      if (match){
        match.reactions = data.reactions || {};
      }
      renderGrid();
    }catch(err){}
  }
  function getItemKey(item){
    return item.item_id || item.id || item.image_id || item.url || `${item.title || "offering"}-${item.artist && item.artist.name ? item.artist.name : "forest"}`;
  }

  function getYear(item){
    if (item.year) return item.year;
    const ts = item.created_at || item.timestamp || item.created || null;
    if (!ts) return "";
    const value = Number(ts);
    if (!Number.isFinite(value)) return "";
    const ms = value > 1000000000000 ? value : value * 1000;
    const year = new Date(ms).getFullYear();
    return Number.isFinite(year) ? year : "";
  }

  function getOrigin(item){
    const eventName = item.event_name || item.event || item.rite || item.contest || item.origin || "";
    const year = getYear(item);
    const base = eventName ? `Offered during ${eventName}` : "Offered during the Forest rites";
    return year ? `${base} - ${year}` : base;
  }

  function getTypeBadge(item){
    const raw = item.type || item.origin_type || item.kind || item.category || "";
    if (raw) return raw;
    if (item.contest) return "Contest";
    if (item.rite) return "Rite";
    if (item.tarot || item.deck_id) return "Tarot";
    if (item.artifact) return "Artifact";
    return "";
  }

  function getTags(item){
    if (Array.isArray(item.tags)) return item.tags;
    if (Array.isArray(item.tag_list)) return item.tag_list;
    return [];
  }

  function applyArtistFilter(name){
    activeArtistFilter = name;
    if (filterRow){
      filterRow.style.display = name ? "flex" : "none";
    }
    if (filterName){
      filterName.textContent = name || "-";
    }
    renderGrid();
  }

  function buildCardHtml(item){
    const artist = item.artist || {};
    const artistName = artist.name || "Forest";
    const title = item.title || "Untitled Offering";
    const artistLinks = artist.links || {};
    const origin = (item.origin || "").trim() || getOrigin(item);
    const type = getTypeBadge(item);
    const tags = getTags(item);
    const infoText = [title, artistName, origin].filter(Boolean).join(" - ");
    const artistPayload = encodeURIComponent(JSON.stringify({
      name: artistName,
      links: artistLinks
    }));
    const itemKey = getItemKey(item);
    const baseCounts = item.reactions || {};
    const reactionRow = REACTIONS.map(reaction => {
      const count = Number(baseCounts[reaction.id] || 0);
      return `
          <button class="reaction" data-reaction="${reaction.id}" data-item="${encodeURIComponent(itemKey)}" aria-label="${reaction.label}">
            <span>${reaction.label}</span> ${count}
          </button>
        `;
    }).join("");
    const imgUrl = item.thumb_url || item.url;
    const fallbackUrl = item.thumb_url ? (item.url || "") : (item.fallback_url || "");
    const fallbackAttr = fallbackUrl ? ` data-fallback="${fallbackUrl}"` : "";
    const fullPayload = encodeURIComponent(JSON.stringify({
      url: item.url,
      fallback_url: item.fallback_url || "",
      info: infoText,
      title: title
    }));
    const media = imgUrl
      ? `<img src="${imgUrl}" alt="${title}" loading="lazy" decoding="async"${fallbackAttr} data-full="${fullPayload}" onerror="if(this.dataset.fallback&&this.src!==this.dataset.fallback){this.src=this.dataset.fallback;}" />`
      : `<div class="muted" style="padding:18px;text-align:center">Offering image not available.</div>`;
    const viewButton = item.url
      ? `<button class="view-btn" data-full="${fullPayload}">View</button>`
      : `<button class="view-btn" disabled>View</button>`;
    const isActive = !activeArtistFilter || activeArtistFilter === artistName;
    return `
        <div class="card ${isActive ? "active" : ""}" data-artist="${artistName}">
          <div class="card-media">
            ${media}
          </div>
          <div class="card-body">
            <div class="artist-name">${artistName}</div>
            <div class="work-title">${title}</div>
            <div class="origin">${origin}</div>
            ${type ? `<div class="pill-row"><span class="type-pill">${type}</span></div>` : ""}
            ${tags.length ? `<div class="pill-row">${tags.map(t => `<span class="tag-pill">${t}</span>`).join("")}</div>` : ""}
            <a class="artist-link" href="#" data-artist="${artistPayload}">Artist details</a>
            <div class="reaction-row">${reactionRow}</div>
            <div class="card-actions">
              ${viewButton}
            </div>
          </div>
        </div>
      `;
  }

  function scheduleVirtualRender(){
    if (virtualFrame) return;
    virtualFrame = requestAnimationFrame(() => {
      virtualFrame = null;
      renderVirtualGrid();
    });
  }

  function computeVirtualMetrics(){
    const style = getComputedStyle(grid);
    const colGap = parseFloat(style.columnGap) || 14;
    const rowGap = parseFloat(style.rowGap) || 20;
    const width = grid.clientWidth || grid.offsetWidth || 0;
    const cols = Math.max(1, Math.floor((width + colGap) / (CARD_MIN_WIDTH + colGap)));
    const colWidth = Math.max(CARD_MIN_WIDTH, Math.floor((width - colGap * (cols - 1)) / cols));
    return {cols, colWidth, colGap, rowGap};
  }

  function measureCardHeight(colWidth){
    if (!galleryRenderItems.length) return 420;
    const html = buildCardHtml(galleryRenderItems[0]);
    const temp = document.createElement("div");
    temp.innerHTML = html;
    const card = temp.firstElementChild;
    if (!card) return 420;
    card.style.visibility = "hidden";
    card.style.position = "absolute";
    card.style.pointerEvents = "none";
    card.style.width = `${colWidth}px`;
    grid.appendChild(card);
    const height = card.offsetHeight || 420;
    grid.removeChild(card);
    return height;
  }

  function renderVirtualGrid(){
    const items = galleryRenderItems;
    if (!items.length){
      grid.innerHTML = "<div class='muted'>The Forest awaits its next contribution.</div>";
      grid.style.height = "";
      return;
    }
    grid.classList.add("virtualized");
    const {cols, colWidth, colGap, rowGap} = computeVirtualMetrics();
    if (cols !== virtualCols || !virtualCardHeight){
      virtualCols = cols;
      virtualCardHeight = measureCardHeight(colWidth);
      grid.style.setProperty("--card-width", `${colWidth}px`);
      grid.style.setProperty("--card-height", `${virtualCardHeight}px`);
    }
    const rowHeight = virtualCardHeight + rowGap;
    const totalRows = Math.ceil(items.length / cols);
    const totalHeight = Math.max(0, totalRows * rowHeight - rowGap);
    grid.style.height = `${totalHeight}px`;

    const scrollTop = window.scrollY;
    const gridTop = grid.getBoundingClientRect().top + scrollTop;
    const viewTop = Math.max(0, scrollTop - gridTop);
    const viewBottom = viewTop + window.innerHeight;
    const startRow = Math.max(0, Math.floor(viewTop / rowHeight) - VIRTUAL_BUFFER_ROWS);
    const endRow = Math.min(totalRows - 1, Math.ceil(viewBottom / rowHeight) + VIRTUAL_BUFFER_ROWS);
    const startIndex = startRow * cols;
    const endIndex = Math.min(items.length, (endRow + 1) * cols);

    grid.innerHTML = "";
    for (let i = startIndex; i < endIndex; i += 1){
      const item = items[i];
      const html = buildCardHtml(item);
      const temp = document.createElement("div");
      temp.innerHTML = html;
      const card = temp.firstElementChild;
      if (!card) continue;
      const row = Math.floor(i / cols);
      const col = i % cols;
      card.style.top = `${row * rowHeight}px`;
      card.style.left = `${col * (colWidth + colGap)}px`;
      card.style.width = `${colWidth}px`;
      card.style.height = `${virtualCardHeight}px`;
      grid.appendChild(card);
    }
  }

  function renderGrid(){
    const items = Array.isArray(galleryItems) ? galleryItems : [];
    if (!items.length){
      grid.innerHTML = "<div class='muted'>The Forest awaits its next contribution.</div>";
      grid.style.height = "";
      return;
    }
    galleryRenderItems = items;
    grid.classList.toggle("filtering", !!activeArtistFilter);
    scheduleVirtualRender();
    if (!virtualListening){
      virtualListening = true;
      window.addEventListener("scroll", scheduleVirtualRender, {passive: true});
      window.addEventListener("resize", scheduleVirtualRender);
    }
  }
</script>
</body>
</html>
