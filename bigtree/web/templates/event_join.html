<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Forest Event</title>
  <link rel="icon" href="/icon.png" type="image/png">
  <link rel="stylesheet" href="/static/gallery/gallery.css">
  <style>
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,sans-serif;
      background:linear-gradient(180deg,#07100c,#030906);
      background-repeat: no-repeat;
      color:#e7f2ea;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:28px;
    }
    .card{
      width:min(760px, 100%);
      background:rgba(12,18,15,.92);
      border:1px solid rgba(214,178,110,.18);
      border-radius:18px;
      padding:22px;
      box-shadow:0 18px 50px rgba(0,0,0,.45);
    }
    h1{margin:0 0 6px 0;font-size:28px;}
    .muted{opacity:.8}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:14px;}
    button,a.btn{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 14px; border-radius:12px;
      border:1px solid rgba(214,178,110,.25);
      background:rgba(255,255,255,.04);
      color:#e7f2ea; text-decoration:none;
      cursor:pointer;
    }
    button:hover,a.btn:hover{background:rgba(255,255,255,.07)}
    code{background:rgba(0,0,0,.35); padding:2px 6px; border-radius:8px}
    .status{margin-top:12px; padding:12px 14px; border-radius:12px; background:rgba(255,255,255,.03); border:1px solid rgba(231,242,234,.10)}
    .game-list{margin-top:16px; display:flex; flex-direction:column; gap:8px;}
    .game-card{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(214,178,110,.2);
      background:rgba(12,18,15,.7);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .game-card a{color:#e7f2ea;text-decoration:none}
    .game-meta{font-size:12px; color:rgba(231,242,234,.75)}
  </style>
</head>
<body>
  <div class="card">
  <div id="joinedHeader" style="display:none;">
    <h1 id="joinedTitle"></h1>
    <div class="status" id="joinedBalance" style="margin-bottom:12px;"></div>
    <div class="row" style="margin-bottom:18px;">
      <a class="btn" href="/user-area">Back to Wallet Area</a>
    </div>
  </div>
  <h1 id="eventTitle">Forest Event</h1>
  <div class="muted" id="eventMeta">Loading event <code>{event_code}</code>...</div>
  <div class="status" id="eventWalletBalance" style="display:none;">Wallet balance: -</div>

  <div class="status" id="eventStatus">Loading...</div>

  <div class="row">
    <a class="btn" href="/user-area">Open Forest Wallet / Login</a>
    <button id="joinBtn" type="button">Join event</button>
    <button id="guestBtn" type="button" style="display:none;">Continue as guest</button>
  </div>
  <div class="muted" id="createGameStatus" style="margin-top:6px; font-size:12px;"></div>
  <div class="game-list" id="eventGames"></div>
</div>

<script>
    // NOTE: bigtree templates are python .format() (not Jinja). {event_code} is sanitized server-side.
    const EVENT_CODE = "{event_code}";

    const TOKEN_KEY = "bigtree_user_token";
    function getToken(){
      try{ return window.localStorage.getItem(TOKEN_KEY); }catch(e){ return null; }
    }
    function authHeaders(){
      const token = getToken();
      if (!token) return {};
      return {"Authorization": `Bearer ${token}`};
    }

    async function jsonFetch(url, opts){
      const res = await fetch(url, {
        credentials: "include",
        headers: {"Content-Type":"application/json", ...authHeaders()},
        ...opts,
      });
      const text = await res.text();
      let data;
      try{ data = JSON.parse(text); }catch(e){ data = {ok:false, error:text || res.statusText}; }
      if (!res.ok && data && data.ok === undefined) data.ok = false;
      return data;
    }

    function setStatus(msg){
      const el = document.getElementById("eventStatus");
      if (el) el.textContent = msg;
    }

    function setWalletBalance(balance, currency, visible){
      const el = document.getElementById("eventWalletBalance");
      if (!el) return;
      if (!visible){
        el.style.display = "none";
        return;
      }
      if (balance === null || balance === undefined){
        el.textContent = "Wallet balance: -";
        el.style.display = "none";
        return;
      }
      const suffix = currency ? ` ${currency}` : "";
      el.textContent = `Wallet balance: ${balance}${suffix}`;
      el.style.display = "block";
    }

    const guestBtn = document.getElementById("guestBtn");

    function renderGames(games, enabledGames, canCreate){
      const list = document.getElementById("eventGames");
      if (!list) return;
      const open = Array.isArray(games) ? games : [];
      const enabled = Array.isArray(enabledGames) ? enabledGames : [];

      // If the host configured a filter, show those games even when no table exists yet.
      if (enabled.length){
        const byType = {};
        open.forEach(g => {
          const key = String(g.type || g.game_id || g.module || "").toLowerCase();
          if (!byType[key]) byType[key] = g;
        });
        const cards = enabled.map(key => {
          const k = String(key || "").trim().toLowerCase();
          const game = byType[k] || null;
          const title = game ? (game.title || game.type || "Game") : k;
          const join = game ? game.join_url : "";
          const meta = game
            ? [game.module, game.currency].filter(Boolean).join(" \u25b8 ")
            : "Waiting for a host to open a table";
          const joinBtn = join
            ? `<a class="btn" href="${join}">Open table</a>`
            : (canCreate
              ? `<button class="btn" data-create="${k}" type="button">Create table</button>`
              : "<span class=\"muted\">Not available yet</span>");
          return `
            <div class="game-card">
              <div>
                <div>${title}</div>
                <div class="game-meta">${meta}</div>
              </div>
              ${joinBtn}
            </div>
          `;
        }).join("");
        list.innerHTML = cards || "<div class=\"muted\">No games configured.</div>";
        attachCreateHandlers(list);
        return;
      }

        if (!open.length){
          if (canCreate){
            const defaults = ["blackjack", "slots"];
            list.innerHTML = defaults.map(key => {
              const title = key.charAt(0).toUpperCase() + key.slice(1);
              return `
                <div class="game-card">
                  <div>
                    <div>${title}</div>
                    <div class="game-meta">No open tables yet</div>
                  </div>
                  <button class="btn" data-create="${key}" type="button">Create table</button>
                </div>
              `;
            }).join("");
            attachCreateHandlers(list);
            return;
          }
          list.innerHTML = "<div class=\"muted\">No open tables yet.</div>";
          return;
        }

      list.innerHTML = open.map(game => {
        const title = game.title || game.type || "Game";
        const join = game.join_url;
        const meta = [game.module, game.currency].filter(Boolean).join(" \u25b8 ");
        const joinBtn = join ? `<a class="btn" href="${join}">Open table</a>` : "<span class=\"muted\">No link</span>";
        return `
          <div class="game-card">
            <div>
              <div>${title}</div>
              <div class="game-meta">${meta}</div>
            </div>
            ${joinBtn}
          </div>
        `;
      }).join("");
      attachCreateHandlers(list);
    }

    function attachCreateHandlers(list){
      list.querySelectorAll("button[data-create]").forEach(btn => {
        btn.addEventListener("click", () => createGame(btn.dataset.create || ""));
      });
    }

    async function load(){
      try{
        const data = await jsonFetch(`/api/events/${encodeURIComponent(EVENT_CODE)}`, {method:"GET"});
        if (!data.ok) throw new Error(data.error || "event not found");
        const ev = data.event || {};
        const enabledGames = (ev && ev.metadata && (ev.metadata.enabled_games || ev.metadata.enabledGames)) || [];
        const bg = (ev && ev.metadata && (ev.metadata.background_url || ev.metadata.background)) || "";
        if (bg){
          document.body.style.backgroundImage = `url('${bg}')`;
        }
        document.getElementById("eventTitle").textContent = ev.title ? ev.title : `Event ${ev.event_code}`;
        const meta = [];
        if (ev.venue_name) meta.push(`Venue: ${ev.venue_name}`);
        if (ev.currency_name) meta.push(`Currency: ${ev.currency_name}`);
        if (ev.wallet_enabled) meta.push("Wallet enabled");
        meta.push(`Status: ${ev.status || "active"}`);
        document.getElementById("eventMeta").textContent = meta.join(" Â· ");

        // Hide joined header by default
        document.getElementById("joinedHeader").style.display = "none";

        if (data.requires_login){
          setStatus("Please login with XIVAuth, or continue as guest for this event.");
          setWalletBalance(null, ev.currency_name, false);
          document.getElementById("joinBtn").disabled = false;
          if (guestBtn) guestBtn.style.display = "inline-flex";
        }else if (data.joined){
            // Show joined header
            document.getElementById("joinedHeader").style.display = "block";
            // Compose "VENUE presents: TITLE"
            let venue = ev.venue_name ? ev.venue_name : "Venue";
            let title = ev.title ? ev.title : `Event ${ev.event_code}`;
            document.getElementById("joinedTitle").textContent = `${venue} presents: ${title}`;
            // Show balance
            let bal = (data.wallet_balance !== undefined && data.wallet_balance !== null) ? data.wallet_balance : "-";
            let cur = ev.currency_name ? ev.currency_name : "";
            document.getElementById("joinedBalance").textContent = `Wallet balance: ${bal}${cur ? ' ' + cur : ''}`;

            // Hide default event title/meta/balance/status/buttons
            document.getElementById("eventTitle").style.display = "none";
            document.getElementById("eventMeta").style.display = "none";
            document.getElementById("eventWalletBalance").style.display = "none";
            document.getElementById("eventStatus").style.display = "none";
            document.querySelectorAll(".row").forEach(r => r.style.display = "none");

            try{
              const games = await jsonFetch(`/api/events/${encodeURIComponent(EVENT_CODE)}/games`, {method:"GET"});
              renderGames((games && games.games) || [], enabledGames, true);
            }catch(err){
              renderGames([], enabledGames, true);
            }
        }else if ((ev.status || "") === "ended"){
          setStatus("This event has ended. You can no longer join.");
          setWalletBalance(data.wallet_balance, ev.currency_name, !!ev.wallet_enabled);
          document.getElementById("joinBtn").disabled = true;
          if (guestBtn) guestBtn.style.display = "none";
        }else{
          setStatus("Ready to join.");
          setWalletBalance(data.wallet_balance, ev.currency_name, false);
          document.getElementById("joinBtn").disabled = false;
          if (guestBtn) guestBtn.style.display = "none";
        }
      }catch(err){
        setStatus(err.message || "Unable to load event.");
      }
    }

    document.getElementById("joinBtn").addEventListener("click", async () => {
      try{
        setStatus("Joining...");
        const data = await jsonFetch(`/api/events/${encodeURIComponent(EVENT_CODE)}/join`, {method:"POST", body:"{}"});
        if (!data.ok) throw new Error(data.error || "unable to join");
        await load();
      }catch(err){
        setStatus(err.message || "Unable to join.");
      }
    });

    if (guestBtn){
      guestBtn.addEventListener("click", async () => {
        try{
          setStatus("Setting up guest access...");
          const data = await jsonFetch(`/api/events/${encodeURIComponent(EVENT_CODE)}/guest`, {method:"POST", body:"{}"});
          if (!data.ok) throw new Error(data.error || "unable to start guest session");
          await load();
        }catch(err){
          setStatus(err.message || "Unable to start guest session.");
        }
      });
    }

    async function createGame(gameId){
      const statusEl = document.getElementById("createGameStatus");
      if (statusEl) statusEl.textContent = `Creating ${gameId} table...`;
      try{
        const data = await jsonFetch(`/api/events/${encodeURIComponent(EVENT_CODE)}/games/create`, {
          method:"POST",
          body: JSON.stringify({game_id: gameId}),
        });
        if (!data.ok) throw new Error(data.error || "unable to create");
        if (data.join_url){
          window.location.assign(data.join_url);
          return;
        }
        if (statusEl) statusEl.textContent = "Table created.";
        await load();
      }catch(err){
        if (statusEl) statusEl.textContent = err.message || "Unable to create table.";
      }
    }

    load();
  </script>
</body>
</html>

