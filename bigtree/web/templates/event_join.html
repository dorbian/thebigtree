<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Forest Event</title>
  <link rel="icon" href="/icon.png" type="image/png">
  <link rel="stylesheet" href="/static/gallery/gallery.css">
  <style>
    body{
      margin:0;
      font-family:"Spectral","Georgia",serif;
      background:linear-gradient(180deg,#07100c,#030906);
      color:#e7f2ea;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:28px;
    }
    .card{
      width:min(760px, 100%);
      background:rgba(12,18,15,.92);
      border:1px solid rgba(214,178,110,.18);
      border-radius:18px;
      padding:22px;
      box-shadow:0 18px 50px rgba(0,0,0,.45);
    }
    h1{margin:0 0 6px 0;font-size:28px;}
    .muted{opacity:.8}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:14px;}
    button,a.btn{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 14px; border-radius:12px;
      border:1px solid rgba(214,178,110,.25);
      background:rgba(255,255,255,.04);
      color:#e7f2ea; text-decoration:none;
      cursor:pointer;
    }
    button:hover,a.btn:hover{background:rgba(255,255,255,.07)}
    code{background:rgba(0,0,0,.35); padding:2px 6px; border-radius:8px}
    .status{margin-top:12px; padding:12px 14px; border-radius:12px; background:rgba(255,255,255,.03); border:1px solid rgba(231,242,234,.10)}
    .game-list{margin-top:16px; display:flex; flex-direction:column; gap:8px;}
    .game-card{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(214,178,110,.2);
      background:rgba(12,18,15,.7);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .game-card a{color:#e7f2ea;text-decoration:none}
    .game-meta{font-size:12px; color:rgba(231,242,234,.75)}
  </style>
</head>
<body>
  <div class="card">
  <h1 id="eventTitle">Forest Event</h1>
  <div class="muted" id="eventMeta">Loading event <code>{event_code}</code>...</div>
  <div class="status" id="eventWalletBalance">Wallet balance: -</div>

  <div class="status" id="eventStatus">Loading...</div>

  <div class="row">
    <a class="btn" href="/user-area">Open Forest Wallet / Login</a>
    <button id="joinBtn" type="button">Join event</button>
  </div>

  <div class="muted" style="margin-top:12px; font-size:13px;">
    Tip: if you just logged in, come back here and press "Join event".
  </div>
  <div class="game-list" id="eventGames"></div>
</div>

<script>
    // NOTE: bigtree templates are python .format() (not Jinja). {event_code} is sanitized server-side.
    const EVENT_CODE = "{event_code}";

    const TOKEN_KEY = "bigtree_user_token";
    function getToken(){
      try{ return window.localStorage.getItem(TOKEN_KEY); }catch(e){ return null; }
    }
    function authHeaders(){
      const token = getToken();
      if (!token) return {};
      return {"Authorization": `Bearer ${token}`};
    }

    async function jsonFetch(url, opts){
      const res = await fetch(url, {
        credentials: "include",
        headers: {"Content-Type":"application/json", ...authHeaders()},
        ...opts,
      });
      const text = await res.text();
      let data;
      try{ data = JSON.parse(text); }catch(e){ data = {ok:false, error:text || res.statusText}; }
      if (!res.ok && data && data.ok === undefined) data.ok = false;
      return data;
    }

    function setStatus(msg){
      const el = document.getElementById("eventStatus");
      if (el) el.textContent = msg;
    }

    function setWalletBalance(balance, currency){
      const el = document.getElementById("eventWalletBalance");
      if (!el) return;
      if (balance === null || balance === undefined){
        el.textContent = "Wallet balance: -";
        return;
      }
      const suffix = currency ? ` ${currency}` : "";
      el.textContent = `Wallet balance: ${balance}${suffix}`;
    }

    function renderGames(games, enabledGames){
      const list = document.getElementById("eventGames");
      if (!list) return;
      const open = Array.isArray(games) ? games : [];
      const enabled = Array.isArray(enabledGames) ? enabledGames : [];

      // If the host configured a filter, show those games even when no table exists yet.
      if (enabled.length){
        const byType = {};
        open.forEach(g => {
          const key = String(g.type || g.game_id || g.module || "").toLowerCase();
          if (!byType[key]) byType[key] = g;
        });
        const cards = enabled.map(key => {
          const k = String(key || "").trim().toLowerCase();
          const game = byType[k] || null;
          const title = game ? (game.title || game.type || "Game") : k;
          const join = game ? game.join_url : "";
          const meta = game
            ? [game.module, game.currency].filter(Boolean).join(" • ")
            : "Waiting for a host to open a table";
          const joinBtn = join
            ? `<a class="btn" href="${join}">Open table</a>`
            : "<span class='muted'>Not available yet</span>";
          return `
            <div class="game-card">
              <div>
                <div>${title}</div>
                <div class="game-meta">${meta}</div>
              </div>
              ${joinBtn}
            </div>
          `;
        }).join("");
        list.innerHTML = cards || "<div class='muted'>No games configured.</div>";
        return;
      }

      if (!open.length){
        list.innerHTML = "<div class='muted'>No open tables yet.</div>";
        return;
      }

      list.innerHTML = open.map(game => {
        const title = game.title || game.type || "Game";
        const join = game.join_url;
        const meta = [game.module, game.currency].filter(Boolean).join(" • ");
        const joinBtn = join ? `<a class="btn" href="${join}">Open table</a>` : "<span class='muted'>No link</span>";
        return `
          <div class="game-card">
            <div>
              <div>${title}</div>
              <div class="game-meta">${meta}</div>
            </div>
            ${joinBtn}
          </div>
        `;
      }).join("");
    }

    async function load(){
      try{
        const data = await jsonFetch(`/api/events/${encodeURIComponent(EVENT_CODE)}`, {method:"GET"});
        if (!data.ok) throw new Error(data.error || "event not found");
        const ev = data.event || {};
        const enabledGames = (ev && ev.metadata && (ev.metadata.enabled_games || ev.metadata.enabledGames)) || [];
        const bg = (ev && ev.metadata && (ev.metadata.background_url || ev.metadata.background)) || "";
        if (bg){
          document.body.style.backgroundImage = `url('${bg}')`;
        }
        document.getElementById("eventTitle").textContent = ev.title ? ev.title : `Event ${ev.event_code}`;
        const meta = [];
        if (ev.venue_name) meta.push(`Venue: ${ev.venue_name}`);
        if (ev.currency_name) meta.push(`Currency: ${ev.currency_name}`);
        if (ev.wallet_enabled) meta.push("Wallet enabled");
        meta.push(`Status: ${ev.status || "active"}`);
        document.getElementById("eventMeta").textContent = meta.join(" · ");

        if (data.requires_login){
          setStatus("Please login first (XIVAuth) using the Wallet button, then come back and join.");
          setWalletBalance(null, ev.currency_name);
          document.getElementById("joinBtn").disabled = false;
        }else if (data.joined){
          let msg = "You are already joined.";
          if (ev.wallet_enabled && data.wallet_balance !== null && data.wallet_balance !== undefined){
            msg += ` Wallet balance: ${data.wallet_balance}`;
          }
          setWalletBalance(data.wallet_balance, ev.currency_name);
          setStatus(msg);
          document.getElementById("joinBtn").textContent = "Joined";
          document.getElementById("joinBtn").disabled = true;
          try{
            const games = await jsonFetch(`/api/events/${encodeURIComponent(EVENT_CODE)}/games`, {method:"GET"});
            renderGames((games && games.games) || [], enabledGames);
          }catch(err){
            renderGames([], enabledGames);
          }
        }else if ((ev.status || "") === "ended"){
          setStatus("This event has ended. You can no longer join.");
          setWalletBalance(data.wallet_balance, ev.currency_name);
          document.getElementById("joinBtn").disabled = true;
        }else{
          setStatus("Ready to join.");
          setWalletBalance(data.wallet_balance, ev.currency_name);
          document.getElementById("joinBtn").disabled = false;
        }
      }catch(err){
        setStatus(err.message || "Unable to load event.");
      }
    }

    document.getElementById("joinBtn").addEventListener("click", async () => {
      try{
        setStatus("Joining...");
        const data = await jsonFetch(`/api/events/${encodeURIComponent(EVENT_CODE)}/join`, {method:"POST", body:"{}"});
        if (!data.ok) throw new Error(data.error || "unable to join");
        await load();
      }catch(err){
        setStatus(err.message || "Unable to join.");
      }
    });

    load();
  </script>
</body>
</html>

