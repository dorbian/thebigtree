<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Poker Session</title>
  <link rel="icon" href="/icon.png" type="image/png">
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,sans-serif;background:#0b1310;color:#e7f2ea;min-height:100vh;position:relative;overflow-x:hidden}
    body::before{content:"";position:fixed;inset:0;background:var(--bg-image) center/cover no-repeat;opacity:0;pointer-events:none;transition:opacity .6s ease}
    body.has-bg::before{opacity:.25}
    header{padding:18px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap}
    .user-box{display:none;align-items:center;gap:10px;font-size:13px}
    .user-box button{padding:6px 12px;border-radius:999px;border:1px solid rgba(107,212,162,.4);background:#122019;color:#e7f2ea;cursor:pointer}
    .user-box span{background:rgba(107,212,162,.15);border:1px solid rgba(107,212,162,.4);padding:4px 10px;border-radius:999px}
    main{padding:18px;display:grid;gap:16px;justify-items:center}
    .panel{background:#101a15;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:14px;width:100%;max-width:980px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:center}
    .hand-grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit, minmax(240px, 1fr))}
    .hand-col{text-align:center}
    .hand{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
    .card{padding:6px 10px;border-radius:10px;background:#0c1511;border:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;min-width:80px;min-height:120px}
    .card img{max-width:120px;max-height:170px;border-radius:8px;display:block}
    .card.placeholder{opacity:.4;letter-spacing:.12em}
    .card.hidden{color:#9fb4a6;letter-spacing:.12em;text-transform:uppercase;background:linear-gradient(135deg, rgba(20,32,26,.7), rgba(10,18,14,.9));background-size:cover;background-position:center}
    .actions{display:flex;justify-content:center;gap:12px;flex-wrap:wrap}
    .actions button{padding:8px 12px;border-radius:999px;border:1px solid rgba(107,212,162,.4);background:#122019;color:#e7f2ea;cursor:pointer}
    .actions button[disabled]{opacity:.45;cursor:not-allowed}
    .muted{color:#9fb4a6}
    .house-rules{color:#d6b26e;font-size:13px;letter-spacing:.02em}
    .stepper{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
    .step{padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.1);font-size:12px;color:#9fb4a6}
    .step.active{border-color:rgba(214,178,110,.6);color:#f2e2bf;background:rgba(214,178,110,.08)}
    .status-line{color:#9fb4a6;text-align:center}
    .bg-credit{position:fixed;right:18px;bottom:16px;background:rgba(10,16,12,.72);border:1px solid rgba(107,212,162,.35);color:#d6b26e;padding:6px 12px;border-radius:999px;font-size:12px;cursor:pointer;display:none;z-index:5}
    .bg-credit.show{display:inline-flex;align-items:center;gap:6px}
    .modal{position:fixed;inset:0;background:rgba(6,10,8,.6);display:none;align-items:center;justify-content:center;z-index:10}
    .modal.show{display:flex}
    .modal-card{background:#101a15;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:16px;min-width:280px;max-width:420px}
    .modal-card h3{margin:0 0 8px 0}
    .modal-links{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .modal-links a{color:#6bd4a2;text-decoration:none}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Poker</h1>
      <div class="muted" id="statusLine">Waiting for session...</div>
    </div>
    <div class="user-box" id="userBox">
      <span id="userName"></span>
      <button id="assignBtn" type="button">Assign to me</button>
    </div>
  </header>
  <main>
    <div class="panel">
      <div class="row">
        <div>Pot: <strong id="potValue">0</strong> <span id="currencyLabel">gil</span></div>
        <div>Your committed: <strong id="commitValue">0</strong> <span id="currencyLabelCommit">gil</span></div>
        <div>Possible win: <strong id="winValue">0</strong> <span id="currencyLabelWin">gil</span></div>
      </div>
      <div class="row house-rules">Forest Hold'em - Dealer always calls. No re-raises.</div>
    </div>
    <div class="panel">
      <div class="stepper" id="roundStepper">
        <span class="step" data-stage="preflop">Pre-Flop</span>
        <span class="step" data-stage="flop">Flop</span>
        <span class="step" data-stage="turn">Turn</span>
        <span class="step" data-stage="river">River</span>
        <span class="step" data-stage="showdown">Showdown</span>
      </div>
      <div class="status-line" id="roundStatus">Waiting for round.</div>
    </div>
    <div class="panel">
      <div class="hand-grid">
        <div class="hand-col">
          <div class="muted">Your hand</div>
          <div class="hand" id="playerHand"></div>
        </div>
        <div class="hand-col">
          <div class="muted">Dealer hand</div>
          <div class="hand" id="dealerHand"></div>
        </div>
      </div>
    </div>
    <div class="panel">
      <div class="muted">Community</div>
      <div class="hand" id="communityCards"></div>
    </div>
    <div class="panel">
      <div class="muted">Betting panel</div>
      <div class="row">Current round: <strong id="roundLabel">--</strong></div>
      <div class="actions" id="betActions">
        <button id="betCheck">Check / Call</button>
        <button id="bet50">Bet 50</button>
        <button id="bet100">Bet 100</button>
        <button id="bet200">Bet 200</button>
        <button id="betFold">Fold</button>
      </div>
      <div class="status-line" id="betStatus">Choose your action.</div>
    </div>
    <div class="panel">
      <div class="muted" id="resultLine">Result: --</div>
    </div>
    <div class="panel" id="artistPanel">
      <div class="muted">Artist credits</div>
      <div id="artistCredits" class="muted">No artist credits.</div>
    </div>
  </main>
  <div class="bg-credit" id="bgCredit" role="button" tabindex="0">Art by <span id="bgCreditName"></span></div>
  <div class="modal" id="bgArtistModal" aria-hidden="true">
    <div class="modal-card">
      <h3 id="bgArtistName">Artist</h3>
      <div class="modal-links" id="bgArtistLinks"></div>
      <button id="bgArtistClose">Close</button>
    </div>
  </div>
<script>
  const joinCode = "{JOIN}";
  const gameId = "poker";
  const statusLine = document.getElementById("statusLine");
  const potValue = document.getElementById("potValue");
  const commitValue = document.getElementById("commitValue");
  const winValue = document.getElementById("winValue");
  const playerHand = document.getElementById("playerHand");
  const dealerHand = document.getElementById("dealerHand");
  const communityCards = document.getElementById("communityCards");
  const resultLine = document.getElementById("resultLine");
  const artistPanel = document.getElementById("artistPanel");
  const artistCredits = document.getElementById("artistCredits");
  const roundStepper = document.getElementById("roundStepper");
  const roundStatus = document.getElementById("roundStatus");
  const roundLabel = document.getElementById("roundLabel");
  const betStatus = document.getElementById("betStatus");
  const betCheck = document.getElementById("betCheck");
  const bet50 = document.getElementById("bet50");
  const bet100 = document.getElementById("bet100");
  const bet200 = document.getElementById("bet200");
  const betFold = document.getElementById("betFold");
  const bgCredit = document.getElementById("bgCredit");
  const bgCreditName = document.getElementById("bgCreditName");
  const bgArtistModal = document.getElementById("bgArtistModal");
  const bgArtistName = document.getElementById("bgArtistName");
  const bgArtistLinks = document.getElementById("bgArtistLinks");
  const bgArtistClose = document.getElementById("bgArtistClose");
  const userBox = document.getElementById("userBox");
  const userName = document.getElementById("userName");
  const assignBtn = document.getElementById("assignBtn");
  const tokenKey = `cardgame_${gameId}_token_${joinCode}`;
  const userTokenKey = "bigtree_user_token";
  let playerToken = "";
  let sessionId = "";

  function getUserToken(){
    return window.localStorage.getItem(userTokenKey);
  }

  async function loadUser(){
    const token = getUserToken();
    if(!token){
      userBox.style.display = "none";
      return;
    }
    try{
      const res = await fetch("/user-area/me", {headers:{Authorization:`Bearer ${token}`}});
      const data = await res.json();
      if(!res.ok || !data.ok){
        throw new Error("not logged in");
      }
      userName.textContent = data.user?.xiv_username || "Player";
      userBox.style.display = "flex";
    }catch(err){
      userBox.style.display = "none";
    }
  }

  async function assignSession(){
    const token = getUserToken();
    if(!token){
      statusLine.textContent = "Login to assign this game.";
      return;
    }
    try{
      const res = await fetch("/user-area/claim-join", {
        method:"POST",
        headers:{"Content-Type":"application/json", Authorization:`Bearer ${token}`},
        body:JSON.stringify({join_code: joinCode})
      });
      const data = await res.json();
      if(!res.ok || !data.ok){
        // 409 means the session is already claimed (either by you or someone else)
        if(res.status === 409 && data.game && data.game.claimed_username){
          setAssignClaimed();
          throw new Error(`Already claimed by ${data.game.claimed_username}.`);
        }
        throw new Error(data.error || "Assign failed");
      }
      setAssignClaimed();
      statusLine.textContent = "Assigned to your wallet.";
    }catch(err){
      statusLine.textContent = err.message || "Assign failed.";
    }
  }

  function setAssignClaimed(){
    if(!assignBtn) return;
    assignBtn.textContent = "Claimed";
    assignBtn.disabled = true;
  }

  async function refreshAssignStatus(){
    try{
      const res = await fetch(`/user-area/join-status?join_code=${encodeURIComponent(joinCode)}`);
      const data = await res.json();
      if(res.ok && data.ok && data.game && data.game.claimed_username){
        setAssignClaimed();
      }
    }catch(err){
      // non-fatal
    }
  }

  const STAGE_LABELS = {
    preflop: "Pre-Flop",
    flop: "Flop",
    turn: "Turn",
    river: "River",
    showdown: "Showdown"
  };

  function cardLabel(card){
    if (!card) return "?";
    const suitMap = {spades:"S", hearts:"H", diamonds:"D", clubs:"C"};
    return `${card.rank || "?"}${suitMap[card.suit] || ""}`;
  }

  function applyBackground(url){
    if (!url){
      document.body.classList.remove("has-bg");
      document.body.style.removeProperty("--bg-image");
      return;
    }
    document.body.style.setProperty("--bg-image", `url('${url}')`);
    document.body.classList.add("has-bg");
  }

  function updateBackgroundArtist(backgroundUrl, artist){
    if (!bgCredit || !bgCreditName) return;
    const name = artist && artist.name ? artist.name : "";
    if (!backgroundUrl || !name){
      bgCredit.classList.remove("show");
      return;
    }
    bgCreditName.textContent = name;
    bgCredit.classList.add("show");
    const links = (artist && artist.links) ? artist.links : {};
    bgCredit.dataset.links = JSON.stringify(links || {});
  }

  function openBackgroundModal(){
    if (!bgArtistModal || !bgArtistName || !bgArtistLinks) return;
    const name = bgCreditName ? bgCreditName.textContent : "";
    bgArtistName.textContent = name || "Artist";
    let links = {};
    try{
      links = JSON.parse(bgCredit.dataset.links || "{}");
    }catch(err){
      links = {};
    }
    const entries = Object.entries(links || {}).filter(([, url]) => url);
    bgArtistLinks.innerHTML = entries.length
      ? entries.map(([label, url]) => `<a href="${url}" target="_blank" rel="noreferrer">${label}</a>`).join("")
      : "<span class='muted'>No links shared.</span>";
    bgArtistModal.classList.add("show");
    bgArtistModal.setAttribute("aria-hidden", "false");
  }

  function closeBackgroundModal(){
    if (!bgArtistModal) return;
    bgArtistModal.classList.remove("show");
    bgArtistModal.setAttribute("aria-hidden", "true");
  }

  function renderHand(el, hand){
    el.innerHTML = (hand || []).map(card => {
      if (card && card.image){
        return `<div class="card"><img src="${card.image}" alt="${cardLabel(card)}"></div>`;
      }
      return `<div class="card">${cardLabel(card)}</div>`;
    }).join("");
  }

  function renderHiddenHand(el, count, backUrl){
    const total = Math.max(2, count || 0);
    el.innerHTML = Array.from({length: total}).map(() => {
      if (backUrl){
        return `<div class="card hidden" style="background-image:linear-gradient(135deg, rgba(12,18,32,.4), rgba(12,18,32,.6)), url('${backUrl}')"></div>`;
      }
      return `<div class="card hidden">Hidden</div>`;
    }).join("");
  }

  function renderCommunity(hand, stage){
    const revealCount = stage === "flop" ? 3 : stage === "turn" ? 4 : stage === "river" || stage === "showdown" ? 5 : 0;
    const slots = [];
    for (let i = 0; i < 5; i++){
      const card = hand[i];
      if (i < revealCount && card){
        if (card.image){
          slots.push(`<div class="card"><img src="${card.image}" alt="${cardLabel(card)}"></div>`);
        }else{
          slots.push(`<div class="card">${cardLabel(card)}</div>`);
        }
      }else{
        slots.push(`<div class="card placeholder">?</div>`);
      }
    }
    communityCards.innerHTML = slots.join("");
  }

  function collectArtists(cards){
    const artists = [];
    (cards || []).forEach(card => {
      if (!card) return;
      const name = card.artist_name || card.artist || card.artist_id || "";
      if (name && !artists.includes(name)){
        artists.push(name);
      }
    });
    return artists;
  }

  function renderArtists(cards){
    const names = collectArtists(cards);
    if (!names.length){
      artistCredits.textContent = "No artist credits.";
      if (artistPanel) artistPanel.style.display = "none";
      return;
    }
    if (artistPanel) artistPanel.style.display = "";
    artistCredits.innerHTML = names.map(n => `<div>${n}</div>`).join("");
  }

  function renderStepper(stage){
    const steps = roundStepper.querySelectorAll(".step");
    steps.forEach(step => {
      const key = step.dataset.stage;
      step.classList.toggle("active", key === stage);
    });
  }

  function resultCopy(state){
    if (!state) return "Result: --";
    const reason = state.ended_reason;
    if (reason === "fold"){
      return "You folded. Dealer wins the pot.";
    }
    const result = state.result;
    const playerRank = state.player_rank ? state.player_rank.replace(/_/g, " ") : "";
    const dealerRank = state.dealer_rank ? state.dealer_rank.replace(/_/g, " ") : "";
    if (result === "player") return `You win with a ${playerRank}.`;
    if (result === "dealer") return `Dealer wins with a ${dealerRank}.`;
    if (result === "push") return "Push. The pot is split.";
    return "Result: --";
  }

  async function ensureToken(){
    playerToken = localStorage.getItem(tokenKey) || "";
    if (playerToken) return;
    const res = await fetch(`/api/cardgames/${gameId}/sessions/${joinCode}/join`, {method:"POST"});
    const data = await res.json();
    if (data && data.redirect){
      window.location.assign(data.redirect);
      return;
    }
    if (data && data.player_token){
      playerToken = data.player_token;
      localStorage.setItem(tokenKey, playerToken);
    }
  }

  function setBetButtons(enabled){
    [betCheck, bet50, bet100, bet200, betFold].forEach(btn => {
      btn.disabled = !enabled;
    });
  }

  async function postAction(action, amount){
    await ensureToken();
    if (!sessionId) return;
    setBetButtons(false);
    betStatus.textContent = "Waiting for dealer...";
    const userToken = getUserToken();
    const res = await fetch(`/api/cardgames/${gameId}/sessions/${sessionId}/action`, {
      method:"POST",
      headers: {
        "Content-Type":"application/json",
        ...(userToken ? {"Authorization": `Bearer ${userToken}`} : {}),
      },
      body: JSON.stringify({token: playerToken, action, payload: amount ? {amount} : {}})
    });
    if (res){
      const data = await res.json().catch(() => ({}));
      if (data && data.redirect){
        window.location.assign(data.redirect);
        return;
      }
      if (data && data.ok === false){
        betStatus.textContent = data.error || "Action failed.";
        setBetButtons(true);
        return;
      }
    }
    loadState();
  }

  function render(state){
    if (!state || !state.session) return;
    sessionId = state.session.session_id || "";
    const pot = state.state && typeof state.state.pot === "number" ? state.state.pot : (state.session.pot || 0);
    const committed = state.state && typeof state.state.player_commit === "number" ? state.state.player_commit : 0;
    const stage = (state.state && state.state.stage) || "preflop";
    const live = state.session.status === "live" && (state.state && state.state.status) !== "finished";

    const currency = (state.session.currency || "gil").trim() || "gil";
    potValue.textContent = pot;
    commitValue.textContent = committed;
    winValue.textContent = pot;
    const currencyLabel = document.getElementById("currencyLabel");
    const currencyLabelCommit = document.getElementById("currencyLabelCommit");
    const currencyLabelWin = document.getElementById("currencyLabelWin");
    if (currencyLabel) currencyLabel.textContent = currency;
    if (currencyLabelCommit) currencyLabelCommit.textContent = currency;
    if (currencyLabelWin) currencyLabelWin.textContent = currency;
    statusLine.textContent = `Status: ${state.session.status}`;
    applyBackground(state.session.background_url || "");
    updateBackgroundArtist(state.session.background_url || "", state.session.background_artist || {});

    renderHand(playerHand, (state.state && state.state.player_hand) || []);
    const dealer = (state.state && state.state.dealer_hand) || [];
    if (dealer && dealer.length){
      renderHand(dealerHand, dealer);
    }else{
      const count = state.state ? state.state.dealer_hand_count : 0;
      const backUrl = state.state ? state.state.dealer_hand_back : "";
      renderHiddenHand(dealerHand, count, backUrl);
    }
    renderCommunity((state.state && state.state.community) || [], stage);
    renderArtists(((state.state && state.state.player_hand) || [])
      .concat((state.state && state.state.dealer_hand) || [])
      .concat((state.state && state.state.community) || []));
    renderStepper(stage);
    roundLabel.textContent = STAGE_LABELS[stage] || stage;
    roundStatus.textContent = live ? `Current round: ${STAGE_LABELS[stage] || stage}` : "Waiting for round.";

    const canAct = live && ["preflop", "flop", "turn", "river"].includes(stage);
    setBetButtons(canAct);
    betStatus.textContent = canAct ? "Choose your action." : "Waiting for dealer...";

    resultLine.textContent = resultCopy(state.state || {});
    if ((state.state && state.state.status) === "finished"){
      statusLine.textContent = "Status: finished";
      setBetButtons(false);
      betStatus.textContent = "Hand finished.";
    }
  }

  betCheck.addEventListener("click", () => postAction("check"));
  bet50.addEventListener("click", () => postAction("bet", 50));
  bet100.addEventListener("click", () => postAction("bet", 100));
  bet200.addEventListener("click", () => postAction("bet", 200));
  betFold.addEventListener("click", () => postAction("fold"));
  assignBtn?.addEventListener("click", assignSession);
  // If the session is already assigned, reflect that immediately.
  refreshAssignStatus();
  loadUser();
  if (bgCredit){
    bgCredit.addEventListener("click", openBackgroundModal);
    bgCredit.addEventListener("keypress", (ev) => {
      if (ev.key === "Enter" || ev.key === " "){
        ev.preventDefault();
        openBackgroundModal();
      }
    });
  }
  if (bgArtistModal){
    bgArtistModal.addEventListener("click", (ev) => {
      if (ev.target === bgArtistModal) closeBackgroundModal();
    });
  }
  if (bgArtistClose){
    bgArtistClose.addEventListener("click", closeBackgroundModal);
  }

  async function loadState(){
    const res = await fetch(`/api/cardgames/${gameId}/sessions/${joinCode}/state?view=player`);
    const data = await res.json();
    if (data && data.ok && data.state){
      render(data.state);
    }else if (data && data.redirect){
      window.location.assign(data.redirect);
    }
  }

  let ws = null;
  let wsBackoff = 1000;
  let wsPing = null;

  function wsUrl(){
    const proto = window.location.protocol === "https:" ? "wss" : "ws";
    const params = new URLSearchParams({view: "player"});
    if (playerToken) params.set("token", playerToken);
    return `${proto}://${window.location.host}/ws/cardgames/${gameId}/sessions/${joinCode}?${params.toString()}`;
  }

  function schedulePing(){
    if (wsPing) clearInterval(wsPing);
    wsPing = setInterval(() => {
      if (!ws || ws.readyState !== 1) return;
      if (document.hidden) return;
      ws.send(JSON.stringify({type: "ping"}));
    }, 30000);
  }

  function connectWs(){
    if (ws) ws.close();
    ws = new WebSocket(wsUrl());
    ws.onopen = () => {
      wsBackoff = 1000;
      if (playerToken){
        ws.send(JSON.stringify({type: "auth", token: playerToken}));
      }
      ws.send(JSON.stringify({type: "resume"}));
    };
    ws.onmessage = (ev) => {
      try{
        const payload = JSON.parse(ev.data);
        if (payload.type === "STATE" && payload.state){
          render(payload.state);
        }else if (payload.type === "SESSION_GONE" && payload.redirect){
          window.location.assign(payload.redirect);
        }else{
          loadState();
        }
      }catch(err){}
    };
    ws.onclose = () => {
      if (document.hidden) return;
      setTimeout(connectWs, wsBackoff);
      wsBackoff = Math.min(wsBackoff * 2, 10000);
    };
  }

  document.addEventListener("visibilitychange", () => {
    if (!document.hidden){
      if (!ws || ws.readyState > 1){
        connectWs();
      }else{
        ws.send(JSON.stringify({type: "resume"}));
      }
    }
  });
  window.addEventListener("focus", () => {
    if (!ws || ws.readyState > 1){
      connectWs();
    }else{
      ws.send(JSON.stringify({type: "resume"}));
    }
  });

  schedulePing();
  connectWs();
  loadState();
</script>
</body>
</html>
