<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Blackjack</title>
  <link rel="icon" href="/icon.png" type="image/png">
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,sans-serif;background:#0b1310;color:#e7f2ea;min-height:100vh;position:relative;overflow-x:hidden}
    body::before{content:"";position:fixed;inset:0;background:var(--bg-image) center/cover no-repeat;opacity:0;pointer-events:none;transition:opacity .6s ease}
    body.has-bg::before{opacity:.25}
    header{padding:18px;border-bottom:1px solid rgba(255,255,255,.08)}
    main{padding:18px;display:grid;gap:16px;justify-items:center}
    .panel{background:#101a15;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:14px;width:100%;max-width:960px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:center}
    .hand{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .hands{display:grid;gap:12px;width:100%}
    .hand-block{background:#0e1813;border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:10px}
    .hand-block.active{border-color:rgba(107,212,162,.6);box-shadow:0 0 0 1px rgba(107,212,162,.25)}
    .hand-title{display:flex;gap:8px;align-items:center;justify-content:center;font-size:14px;margin-bottom:6px}
    .card{padding:6px 10px;border-radius:10px;background:#0c1511;border:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;min-width:80px;min-height:120px}
    .card img{max-width:120px;max-height:170px;border-radius:8px;display:block}
    .actions{display:flex;justify-content:center;gap:12px;flex-wrap:wrap}
    .actions button{padding:8px 12px;border-radius:999px;border:1px solid rgba(107,212,162,.4);background:#122019;color:#e7f2ea;cursor:pointer}
    .bg-credit{position:fixed;right:18px;bottom:16px;background:rgba(10,16,12,.72);border:1px solid rgba(107,212,162,.35);color:#d6b26e;padding:6px 12px;border-radius:999px;font-size:12px;cursor:pointer;display:none;z-index:5}
    .bg-credit.show{display:inline-flex;align-items:center;gap:6px}
    .modal{position:fixed;inset:0;background:rgba(6,10,8,.6);display:none;align-items:center;justify-content:center;z-index:10}
    .modal.show{display:flex}
    .modal-card{background:#101a15;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:16px;min-width:280px;max-width:420px}
    .modal-card h3{margin:0 0 8px 0}
    .modal-links{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .modal-links a{color:#6bd4a2;text-decoration:none}
    .muted{color:#9fb4a6}
  </style>
</head>
<body>
  <header>
    <h1>Blackjack</h1>
    <div class="muted" id="statusLine">Waiting for session...</div>
  </header>
  <main>
    <div class="panel">
      <div class="row">
        <div>Pot: <strong id="potValue">0</strong> <span id="currencyLabel">gil</span></div>
        <div>Winnings: <strong id="winValue">0</strong> <span id="currencyLabelWin">gil</span></div>
        <div>Player: <strong id="playerTotal">0</strong></div>
        <div>Dealer: <strong id="dealerTotal">0</strong></div>
        <div>Lead: <strong id="leadStatus">-</strong></div>
      </div>
    </div>
    <div class="panel">
      <div class="row">
        <div>Role: <strong>Host</strong></div>
        <div>Join code: <strong id="joinCode">-</strong></div>
      </div>
      <div class="row">
        <button id="copyPlayerLink">Copy player link</button>
        <button id="createNext">Create next session</button>
      </div>
      <div class="muted" id="nextSessionLinks">No new session yet.</div>
    </div>
    <div class="panel">
      <div class="muted">Dealer</div>
      <div class="hand" id="dealerHand"></div>
    </div>
    <div class="panel">
      <div class="muted">Player</div>
      <div class="hands" id="playerHands"></div>
    </div>
    <div class="panel actions">
      <button id="startBtn">Start</button>
      <button id="finishBtn">Finish</button>
    </div>
    <div class="panel">
      <div class="muted">Artist credits</div>
      <div id="artistCredits" class="muted">No artist credits.</div>
    </div>
  </main>
  <div class="bg-credit" id="bgCredit" role="button" tabindex="0">Art by <span id="bgCreditName"></span></div>
  <div class="modal" id="bgArtistModal" aria-hidden="true">
    <div class="modal-card">
      <h3 id="bgArtistName">Artist</h3>
      <div class="modal-links" id="bgArtistLinks"></div>
      <button id="bgArtistClose">Close</button>
    </div>
  </div>
<script>
  const joinCode = "{JOIN}";
  const gameId = "blackjack";
  const statusLine = document.getElementById("statusLine");
  const bgCredit = document.getElementById("bgCredit");
  const bgCreditName = document.getElementById("bgCreditName");
  const bgArtistModal = document.getElementById("bgArtistModal");
  const bgArtistName = document.getElementById("bgArtistName");
  const bgArtistLinks = document.getElementById("bgArtistLinks");
  const bgArtistClose = document.getElementById("bgArtistClose");
  const potValue = document.getElementById("potValue");
  const winValue = document.getElementById("winValue");
  const joinCodeEl = document.getElementById("joinCode");
  const copyPlayerLink = document.getElementById("copyPlayerLink");
  const createNext = document.getElementById("createNext");
  const nextSessionLinks = document.getElementById("nextSessionLinks");
  const dealerHand = document.getElementById("dealerHand");
  const playerHands = document.getElementById("playerHands");
  const artistCredits = document.getElementById("artistCredits");
  const playerTotal = document.getElementById("playerTotal");
  const dealerTotal = document.getElementById("dealerTotal");
  const leadStatus = document.getElementById("leadStatus");
  const startBtn = document.getElementById("startBtn");
  const finishBtn = document.getElementById("finishBtn");
  const token = new URLSearchParams(window.location.search).get("token") || "";
  let sessionId = "";
  let sessionState = null;

  function cardLabel(card){
    if (!card) return "?";
    const suitMap = {spades:"S", hearts:"H", diamonds:"D", clubs:"C", hidden:"?"};
    return `${card.rank || "?"}${suitMap[card.suit] || ""}`;
  }

  function renderHandHtml(hand){
    return (hand || []).map(card => {
      if (card && card.image){
        return `<div class="card"><img src="${card.image}" alt="${cardLabel(card)}"></div>`;
      }
      return `<div class="card">${cardLabel(card)}</div>`;
    }).join("");
  }

  function renderHand(el, hand){
    el.innerHTML = renderHandHtml(hand);
  }

  function renderHands(el, hands, activeHand, results, multipliers){
    const list = (hands && hands.length) ? hands : [];
    el.innerHTML = list.map((hand, idx) => {
      const active = idx === activeHand ? " active" : "";
      const result = (results && results[idx]) ? results[idx] : "";
      const mult = (multipliers && multipliers[idx] && multipliers[idx] > 1) ? `x${multipliers[idx]}` : "";
      const label = `Hand ${idx + 1}${mult ? " " + mult : ""}`;
      return `<div class="hand-block${active}">
        <div class="hand-title">${label}</div>
        <div class="hand">${renderHandHtml(hand)}</div>
        ${result ? `<div class="muted">Result: ${result}</div>` : ""}
      </div>`;
    }).join("");
  }

  function collectArtists(cards){
    const artists = [];
    (cards || []).forEach(card => {
      if (!card) return;
      const name = card.artist_name || card.artist || card.artist_id || "";
      if (name && !artists.includes(name)){
        artists.push(name);
      }
    });
    return artists;
  }

  function renderArtists(cards){
    const names = collectArtists(cards);
    if (!names.length){
      artistCredits.textContent = "No artist credits.";
      return;
    }
    artistCredits.innerHTML = names.map(n => `<div>${n}</div>`).join("");
  }

  function handValue(hand){
    let total = 0;
    let aces = 0;
    (hand || []).forEach(card => {
      const rank = card ? card.rank : null;
      if (rank === "A"){
        aces += 1;
        total += 11;
      }else if (rank === "J" || rank === "Q" || rank === "K"){
        total += 10;
      }else{
        const num = parseInt(rank || "0", 10);
        total += isNaN(num) ? 0 : num;
      }
    });
    while (total > 21 && aces > 0){
      total -= 10;
      aces -= 1;
    }
    return total;
  }

  function updateLead(player, dealer, status){
    if (status === "finished"){
      if (player > 21){
        return "Player bust";
      }
      if (dealer > 21){
        return "Dealer bust";
      }
      if (player > dealer){
        return "Player leads";
      }
      if (dealer > player){
        return "Dealer leads";
      }
      return "Push";
    }
    if (player > 21){
      return "Player bust";
    }
    if (dealer > 21){
      return "Dealer bust";
    }
    if (player > dealer){
      return "Player leads";
    }
    if (dealer > player){
      return "Dealer leads";
    }
    return "Even";
  }

  function applyBackground(url){
    if (!url){
      document.body.classList.remove("has-bg");
      document.body.style.removeProperty("--bg-image");
      return;
    }
    document.body.style.setProperty("--bg-image", `url('${url}')`);
    document.body.classList.add("has-bg");
  }

  function updateBackgroundArtist(backgroundUrl, artist){
    if (!bgCredit || !bgCreditName) return;
    const name = artist && artist.name ? artist.name : "";
    if (!backgroundUrl || !name){
      bgCredit.classList.remove("show");
      return;
    }
    bgCreditName.textContent = name;
    bgCredit.classList.add("show");
    const links = (artist && artist.links) ? artist.links : {};
    bgCredit.dataset.links = JSON.stringify(links || {});
  }

  function openBackgroundModal(){
    if (!bgArtistModal || !bgArtistName || !bgArtistLinks) return;
    const name = bgCreditName ? bgCreditName.textContent : "";
    bgArtistName.textContent = name || "Artist";
    let links = {};
    try{
      links = JSON.parse(bgCredit.dataset.links || "{}");
    }catch(err){
      links = {};
    }
    const entries = Object.entries(links || {}).filter(([, url]) => url);
    bgArtistLinks.innerHTML = entries.length
      ? entries.map(([label, url]) => `<a href="${url}" target="_blank" rel="noreferrer">${label}</a>`).join("")
      : "<span class='muted'>No links shared.</span>";
    bgArtistModal.classList.add("show");
    bgArtistModal.setAttribute("aria-hidden", "false");
  }

  function closeBackgroundModal(){
    if (!bgArtistModal) return;
    bgArtistModal.classList.remove("show");
    bgArtistModal.setAttribute("aria-hidden", "true");
  }

  async function postAdmin(path){
    if (!token){
      statusLine.textContent = "Missing priestess token.";
      return;
    }
    if (!sessionId) return;
    try{
      const res = await fetch(`/api/cardgames/${gameId}/sessions/${sessionId}/${path}`, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({token})
      });
      const data = await res.json();
      if (!data.ok){
        statusLine.textContent = data.error || "Action failed.";
      }
    }catch(err){
      statusLine.textContent = "Action failed.";
    }
    loadState();
  }

  function render(state){
    if (!state || !state.session) return;
    sessionId = state.session.session_id || "";
    sessionState = state;
    joinCodeEl.textContent = state.session.join_code || "-";
    const currency = (state.session.currency || "gil").trim() || "gil";
    potValue.textContent = state.session.pot || 0;
    winValue.textContent = state.session.winnings || 0;
    const currencyLabel = document.getElementById("currencyLabel");
    const currencyLabelWin = document.getElementById("currencyLabelWin");
    if (currencyLabel) currencyLabel.textContent = currency;
    if (currencyLabelWin) currencyLabelWin.textContent = currency;
    statusLine.textContent = `Status: ${state.session.status}`;
    applyBackground(state.session.background_url || "");
    updateBackgroundArtist(state.session.background_url || "", state.session.background_artist || {});
    const dealer = (state.state && state.state.dealer_hand) || [];
    const hands = (state.state && state.state.player_hands) || [];
    const activeHand = (state.state && typeof state.state.active_hand === "number") ? state.state.active_hand : 0;
    const results = (state.state && state.state.hand_results) || [];
    const multipliers = (state.state && state.state.hand_multipliers) || [];
    const fallbackHand = (state.state && state.state.player_hand) ? [state.state.player_hand] : [];
    const renderList = hands.length ? hands : fallbackHand;
    renderHand(dealerHand, dealer);
    renderHands(playerHands, renderList, activeHand, results, multipliers);
    renderArtists(dealer.concat(...renderList));
    const dealerVal = handValue(dealer);
    const playerVal = handValue(renderList[activeHand] || []);
    dealerTotal.textContent = dealerVal;
    playerTotal.textContent = playerVal;
    leadStatus.textContent = updateLead(playerVal, dealerVal, (state.state && state.state.status) || state.session.status);
    const status = state.session.status;
    startBtn.disabled = status !== "created" && status !== "draft";
    finishBtn.disabled = status === "finished";
  }

  startBtn.addEventListener("click", () => postAdmin("start"));
  finishBtn.addEventListener("click", () => postAdmin("finish"));
  if (bgCredit){
    bgCredit.addEventListener("click", openBackgroundModal);
    bgCredit.addEventListener("keypress", (ev) => {
      if (ev.key === "Enter" || ev.key === " "){
        ev.preventDefault();
        openBackgroundModal();
      }
    });
  }
  if (bgArtistModal){
    bgArtistModal.addEventListener("click", (ev) => {
      if (ev.target === bgArtistModal) closeBackgroundModal();
    });
  }
  if (bgArtistClose){
    bgArtistClose.addEventListener("click", closeBackgroundModal);
  }
  copyPlayerLink.addEventListener("click", async () => {
    const url = `${window.location.origin}/cardgames/${gameId}/session/${joinCode}`;
    try{
      await navigator.clipboard.writeText(url);
      nextSessionLinks.textContent = "Player link copied.";
    }catch(err){
      nextSessionLinks.textContent = url;
    }
  });
  createNext.addEventListener("click", async () => {
    if (!sessionState || !sessionState.session){
      nextSessionLinks.textContent = "Session not ready yet.";
      return;
    }
    try{
      const res = await fetch(`/api/cardgames/${gameId}/sessions/${sessionId}/clone`, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({token})
      });
      const data = await res.json();
      if (!data || !data.session){
        nextSessionLinks.textContent = (data && data.error) ? data.error : "Failed to create session.";
        return;
      }
      const newJoin = data.session.join_code || "";
      const hostToken = data.session.priestess_token || "";
      const playerUrl = `${window.location.origin}/cardgames/${gameId}/session/${newJoin}`;
      const hostUrl = `${window.location.origin}/cardgames/${gameId}/session/${newJoin}?view=priestess&token=${encodeURIComponent(hostToken)}`;
      nextSessionLinks.innerHTML = `Next session: <a href="${playerUrl}" target="_blank" rel="noreferrer">Player</a> | <a href="${hostUrl}" target="_blank" rel="noreferrer">Host</a>`;
      window.open(hostUrl, "_blank");
    }catch(err){
      nextSessionLinks.textContent = "Failed to create session.";
    }
  });

  async function loadState(){
    const res = await fetch(`/api/cardgames/${gameId}/sessions/${joinCode}/state?view=priestess`);
    const data = await res.json();
    if (data && data.ok && data.state){
      render(data.state);
    }else if (data && data.redirect){
      statusLine.textContent = "Session closed.";
      startBtn.disabled = true;
      finishBtn.disabled = true;
    }
  }

  let ws = null;
  let wsBackoff = 1000;
  let wsPing = null;

  function wsUrl(){
    const proto = window.location.protocol === "https:" ? "wss" : "ws";
    const params = new URLSearchParams({view: "priestess"});
    return `${proto}://${window.location.host}/ws/cardgames/${gameId}/sessions/${joinCode}?${params.toString()}`;
  }

  function schedulePing(){
    if (wsPing) clearInterval(wsPing);
    wsPing = setInterval(() => {
      if (!ws || ws.readyState !== 1) return;
      if (document.hidden) return;
      ws.send(JSON.stringify({type: "ping"}));
    }, 30000);
  }

  function connectWs(){
    if (ws) ws.close();
    ws = new WebSocket(wsUrl());
    ws.onopen = () => {
      wsBackoff = 1000;
      ws.send(JSON.stringify({type: "resume"}));
    };
    ws.onmessage = (ev) => {
      try{
        const payload = JSON.parse(ev.data);
        if (payload.type === "STATE" && payload.state){
          render(payload.state);
        }else if (payload.type === "SESSION_GONE"){
          statusLine.textContent = "Session closed.";
          startBtn.disabled = true;
          finishBtn.disabled = true;
        }else{
          loadState();
        }
      }catch(err){}
    };
    ws.onclose = () => {
      if (document.hidden) return;
      setTimeout(connectWs, wsBackoff);
      wsBackoff = Math.min(wsBackoff * 2, 10000);
    };
  }

  document.addEventListener("visibilitychange", () => {
    if (!document.hidden){
      if (!ws || ws.readyState > 1){
        connectWs();
      }else{
        ws.send(JSON.stringify({type: "resume"}));
      }
    }
  });
  window.addEventListener("focus", () => {
    if (!ws || ws.readyState > 1){
      connectWs();
    }else{
      ws.send(JSON.stringify({type: "resume"}));
    }
  });

  schedulePing();
  connectWs();
  loadState();
</script>
</body>
</html>
