<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tarot Overlay</title>
<style>
  :root{
    --bg:rgba(6,10,8,.7);
    --text:#e7f2ea;
    --muted:#9fb4a6;
    --accent:#6bd4a2;
    --line:rgba(255,255,255,.08);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:"Cinzel","Garamond","Georgia",serif;
    color:var(--text);
    background:transparent;
  }
  .frame{
    margin:14px;
    padding:12px;
    border-radius:14px;
    background:var(--bg);
    border:1px solid var(--line);
  }
  .title{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:10px;
  }
  .title h1{margin:0;font-size:16px;letter-spacing:.06em}
  .chip{font-size:10px;color:var(--muted);border:1px solid var(--line);border-radius:999px;padding:2px 8px}
  .grid{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(160px, 1fr));
    gap:10px;
  }
  .slot{
    padding:8px;
    border-radius:12px;
    border:1px solid var(--line);
    background:rgba(0,0,0,.2);
  }
  .label{font-size:10px;color:var(--muted);margin-bottom:6px}
  .card{
    width:100%;
    aspect-ratio:3/4.2;
    perspective:1000px;
  }
  .card .inner{
    width:100%;height:100%;
    position:relative;
    transform-style:preserve-3d;
    transition:transform .7s ease;
  }
  .card.revealed .inner.reversed{
    transform:rotateY(180deg) rotateZ(180deg);
  }
  .card.revealed .inner{transform:rotateY(180deg)}
  .face{
    position:absolute;inset:0;
    backface-visibility:hidden;
    border-radius:10px;
    overflow:hidden;
    border:1px solid var(--line);
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .back{
    background:
      radial-gradient(circle at 20% 20%, rgba(214,178,110,.2), transparent 40%),
      linear-gradient(135deg, #1b2d26, #132018);
  }
  .front{
    transform:rotateY(180deg);
    background:#0d1411;
    position:relative;
    isolation:isolate;
  }
  .front::before{
    content:"";
    position:absolute;
    inset:0;
    background:var(--card-overlay, transparent);
    opacity:var(--card-overlay-opacity, .35);
    mix-blend-mode:screen;
    pointer-events:none;
    z-index:1;
  }
  .front::after{
    content:"";
    position:absolute;
    inset:10px;
    border-radius:10px;
    border:1px solid var(--card-frame, rgba(255,255,255,.16));
    box-shadow:var(--card-frame-shadow, none);
    pointer-events:none;
    z-index:1;
  }
  .front img{width:100%;height:100%;object-fit:cover;position:relative;z-index:0}
  .card-title{
    position:absolute;
    left:50%;
    right:auto;
    bottom:10px;
    transform:translateX(-50%);
    padding:6px 12px;
    font-size:var(--card-title-size, 12px);
    letter-spacing:var(--card-title-letter, .04em);
    text-transform:var(--card-title-transform, uppercase);
    color:var(--card-title-color, var(--text));
    background:var(--card-title-bg, rgba(6,10,8,.65));
    font-family:var(--card-title-font, inherit);
    text-shadow:var(--card-title-shadow, none);
    border:1px solid var(--card-title-border, rgba(255,255,255,.2));
    border-radius:999px;
    min-width:60%;
    text-align:center;
    z-index:2;
  }
  .card-number{
    position:absolute;
    top:8px;
    left:50%;
    transform:translateX(-50%);
    padding:4px 10px;
    border-radius:999px;
    font-size:var(--card-number-size, 11px);
    letter-spacing:var(--card-number-letter, .08em);
    text-transform:var(--card-number-transform, uppercase);
    color:var(--card-number-color, var(--text));
    background:var(--card-number-bg, rgba(6,10,8,.7));
    border:1px solid var(--card-number-border, rgba(255,255,255,.2));
    z-index:2;
  }
  body[data-card-theme="classic"]{
    --card-overlay:radial-gradient(circle at 20% 10%, rgba(214,178,110,.35), transparent 55%),
      linear-gradient(180deg, rgba(10,12,12,.2), rgba(8,8,8,.65));
    --card-overlay-opacity:.45;
    --card-frame:rgba(214,178,110,.65);
    --card-frame-shadow:0 0 0 1px rgba(214,178,110,.25), inset 0 0 12px rgba(0,0,0,.35);
    --card-title-bg:linear-gradient(180deg, rgba(10,10,10,0), rgba(10,10,10,.85));
    --card-title-font:"Cinzel","Garamond","Georgia",serif;
    --card-title-shadow:0 2px 6px rgba(0,0,0,.6);
    --card-title-letter:.12em;
    --card-title-transform:uppercase;
    --card-title-border:rgba(214,178,110,.6);
    --card-number-letter:.16em;
    --card-number-transform:uppercase;
    --card-number-bg:rgba(18,12,6,.78);
    --card-number-border:rgba(214,178,110,.6);
  }
  body[data-card-theme="wood"]{
    --card-overlay:repeating-linear-gradient(45deg, rgba(104,68,36,.28) 0 8px, rgba(74,49,27,.28) 8px 16px),
      radial-gradient(circle at 50% 20%, rgba(162,111,58,.25), transparent 60%);
    --card-overlay-opacity:.5;
    --card-frame:rgba(141,99,58,.9);
    --card-frame-shadow:inset 0 0 0 2px rgba(63,41,24,.5), inset 0 8px 18px rgba(0,0,0,.35);
    --card-title-bg:linear-gradient(180deg, rgba(40,26,16,0), rgba(40,26,16,.85));
    --card-title-font:"Cormorant Garamond","Garamond","Georgia",serif;
    --card-title-color:#f0e6d6;
    --card-title-letter:.04em;
    --card-title-transform:none;
    --card-title-border:rgba(141,99,58,.85);
    --card-number-letter:.08em;
    --card-number-transform:none;
    --card-number-bg:rgba(52,34,20,.85);
    --card-number-border:rgba(141,99,58,.85);
  }
  body[data-card-theme="wood"] .card-title{
    text-transform:none;
    letter-spacing:.02em;
  }
  body[data-card-theme="neon"]{
    --card-overlay:radial-gradient(circle at 20% 20%, rgba(55,226,255,.25), transparent 45%),
      radial-gradient(circle at 80% 0%, rgba(255,82,205,.18), transparent 45%);
    --card-overlay-opacity:.65;
    --card-frame:rgba(70,240,255,.9);
    --card-frame-shadow:0 0 14px rgba(70,240,255,.45), inset 0 0 12px rgba(255,82,205,.25);
    --card-title-bg:linear-gradient(90deg, rgba(7,7,18,.7), rgba(7,7,18,.2));
    --card-title-font:"Orbitron","Trebuchet MS",sans-serif;
    --card-title-color:#e6fbff;
    --card-title-shadow:0 0 10px rgba(70,240,255,.65);
    --card-title-letter:.22em;
    --card-title-transform:uppercase;
    --card-title-border:rgba(70,240,255,.8);
    --card-number-letter:.22em;
    --card-number-transform:uppercase;
    --card-number-bg:rgba(6,8,20,.85);
    --card-number-border:rgba(70,240,255,.8);
  }
  body[data-card-theme="neon"] .card-title{
    letter-spacing:.18em;
  }
  .caption{font-size:12px;margin-top:8px;color:var(--muted)}
</style>

<div class="frame">
  <div class="title">
    <h1>Tarot Reading</h1>
    <span class="chip" id="sessionStatus">waiting</span>
  </div>
  <div class="grid" id="grid"></div>
  <div class="caption" id="caption"></div>
</div>

<script>
  const joinCode = "{JOIN}";
  const params = new URLSearchParams(location.search);
  const themeParam = params.get("card_theme");
  const themeLocked = params.has("card_theme");
  document.body.dataset.cardTheme = themeParam || "classic";

  function parseRoman(value){
    const roman = String(value || "").trim().toUpperCase();
    if (!roman) return NaN;
    const map = {I:1, V:5, X:10, L:50, C:100, D:500, M:1000};
    let total = 0;
    let prev = 0;
    for (let i = roman.length - 1; i >= 0; i -= 1){
      const num = map[roman[i]];
      if (!num) return NaN;
      if (num < prev){
        total -= num;
      } else {
        total += num;
        prev = num;
      }
    }
    return total;
  }

  function parseCardNumber(value){
    const text = String(value).trim();
    if (!text) return NaN;
    if (/^\d+$/.test(text)) return parseInt(text, 10);
    return parseRoman(text);
  }

  function toRoman(num){
    const n = Number(num);
    if (!Number.isFinite(n) || n <= 0) return "";
    const map = [
      [1000, "M"], [900, "CM"], [500, "D"], [400, "CD"],
      [100, "C"], [90, "XC"], [50, "L"], [40, "XL"],
      [10, "X"], [9, "IX"], [5, "V"], [4, "IV"], [1, "I"]
    ];
    let out = "";
    let remaining = Math.floor(n);
    map.forEach(([val, sym]) => {
      while (remaining >= val){
        out += sym;
        remaining -= val;
      }
    });
    return out;
  }

  function formatCardNumber(value){
    if (String(value || "").trim() === "0") return "0";
    const num = parseCardNumber(value);
    if (num === 0) return "0";
    return num ? toRoman(num) || String(value || "") : "";
  }
  const statusEl = document.getElementById("sessionStatus");
  const grid = document.getElementById("grid");
  const caption = document.getElementById("caption");
  let currentState = null;

  async function fetchState(){
    const res = await fetch(`/api/tarot/sessions/${joinCode}/state?view=overlay`);
    const data = await res.json();
    if (!data.ok) return;
    currentState = data.state;
    render();
  }

  function render(){
    if (!currentState) return;
    if (!themeLocked){
      const deckTheme = currentState.deck ? currentState.deck.theme : "";
      document.body.dataset.cardTheme = deckTheme || "classic";
    }
    statusEl.textContent = currentState.session.status || "created";
    grid.innerHTML = "";
    const backUrl = currentState.deck && currentState.deck.back_image ? currentState.deck.back_image : "";
    currentState.spread.positions.forEach(pos => {
      const draw = currentState.draw.find(d => d.position_id === pos.id);
      const slot = document.createElement("div");
      slot.className = "slot";
      const label = document.createElement("div");
      label.className = "label";
      label.textContent = pos.label;
      slot.appendChild(label);

      const cardWrap = document.createElement("div");
      cardWrap.className = "card" + (draw && draw.revealed ? " revealed" : "");
      const inner = document.createElement("div");
      inner.className = "inner";
      if (draw && draw.reversed){
        inner.classList.add("reversed");
      }
      const back = document.createElement("div");
      back.className = "face back";
      if (backUrl){
        back.style.backgroundImage = `linear-gradient(135deg, rgba(12,18,32,.4), rgba(12,18,32,.6)), url('${backUrl}')`;
        back.style.backgroundSize = "cover";
        back.style.backgroundPosition = "center";
      }
      const front = document.createElement("div");
      front.className = "face front";
      if (draw && draw.card && draw.card.image){
        const img = document.createElement("img");
        img.src = draw.card.image;
        front.appendChild(img);
      }
      if (draw && draw.card && draw.card.number !== undefined && draw.card.number !== null){
        const number = document.createElement("div");
        number.className = "card-number";
        number.textContent = formatCardNumber(draw.card.number);
        front.appendChild(number);
      }
      if (draw && draw.card && draw.card.name){
        const title = document.createElement("div");
        title.className = "card-title";
        title.textContent = draw.card.name;
        front.appendChild(title);
      }
      inner.appendChild(back);
      inner.appendChild(front);
      cardWrap.appendChild(inner);
      slot.appendChild(cardWrap);
      grid.appendChild(slot);
    });

    const lastLine = (currentState.narration || []).slice(-1)[0];
    caption.textContent = lastLine ? lastLine.text : "";
  }

  function connectSSE(){
    const src = new EventSource(`/api/tarot/sessions/${joinCode}/stream?view=overlay`);
    src.onmessage = () => fetchState();
  }

  fetchState();
  connectSSE();
</script>
