<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Forest Game Management</title>
  <link rel="icon" href="/icon.png" type="image/png">
  <link rel="stylesheet" href="/static/gallery/gallery.css">
  <style>
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,sans-serif;
      background:#030906;
      color:#e7f2ea;
    }
    header{
      padding:32px;
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:16px;
    }
    header h1{margin:0;font-size:32px;}
    .panel{
      margin:0 auto 32px;
      padding:24px;
      max-width:1100px;
      background:rgba(12,18,15,.95);
      border:1px solid rgba(214,178,110,.2);
      border-radius:18px;
    }
    table{width:100%;border-collapse:collapse;font-size:13px;}
    th,td{padding:8px 10px;border-bottom:1px solid rgba(231,242,234,.1);vertical-align:top;}
    th{text-transform:uppercase;letter-spacing:.08em;font-size:11px;color:#9fb4a6;}
    .muted{color:rgba(231,242,234,.65);}
    button{
      border:none;
      border-radius:8px;
      padding:8px 14px;
      font-family:inherit;
      letter-spacing:.04em;
      cursor:pointer;
      background:#6bd4a2;
      color:#06100b;
    }
    .err{color:#ffb3b3;}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Game Management</h1>
      <p class="muted">Registered Characters (XIVAuth claims) and game history.</p>
    </div>
    <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap; justify-content:flex-end;">
      <label style="display:flex; flex-direction:column; gap:6px;">
        <span class="muted" style="font-size:12px;">Admin API Key</span>
        <input id="apiKeyInput" placeholder="paste API key" style="min-width:280px; padding:8px 10px; border-radius:8px; border:1px solid rgba(214,178,110,.25); background:rgba(0,0,0,.18); color:#e7f2ea;" />
      </label>
      <button id="refreshBtn">Refresh</button>
    </div>
  </header>

  <section class="panel">
    <div id="errorMessage" class="muted"></div>

    <h2 style="margin:18px 0 8px; font-size:18px;">Registered Characters</h2>
    <p class="muted" style="margin-top:0;">All characters registered via XIVAuth (with server/world when known).</p>
    <div id="claimsContainer"></div>

    <h2 style="margin:24px 0 8px; font-size:18px;">Games</h2>
    <p class="muted" style="margin-top:0;">Most recent games recorded by the forest.</p>
    <div id="gamesContainer"></div>
  </section>

  <script>
    const refreshBtn = document.getElementById("refreshBtn");
    const apiKeyInput = document.getElementById("apiKeyInput");

    function getApiKey(){
      const key = (
        apiKeyInput?.value ||
        localStorage.getItem("forest_api_key") ||
        localStorage.getItem("bt_api_key") ||
        ""
      ).trim();
      if (apiKeyInput && key && apiKeyInput.value.trim() !== key){
        apiKeyInput.value = key;
      }
      return key;
    }

    function saveApiKey(){
      const key = (apiKeyInput?.value || "").trim();
      if (key){
        localStorage.setItem("forest_api_key", key);
        localStorage.setItem("bt_api_key", key);
      }
    }

    if (apiKeyInput){
      apiKeyInput.value = (
        localStorage.getItem("forest_api_key") ||
        localStorage.getItem("bt_api_key") ||
        ""
      ).trim();
      apiKeyInput.addEventListener("change", saveApiKey);
      apiKeyInput.addEventListener("blur", saveApiKey);
    }
    const gamesContainer = document.getElementById("gamesContainer");
    const claimsContainer = document.getElementById("claimsContainer");
    const errorMessage = document.getElementById("errorMessage");

    async function loadGames(){
      errorMessage.textContent = "Loading...";
      try{
        const key = getApiKey();
        const res = await fetch("/user-area/manage/games", {headers: key ? {"X-API-Key": key} : {}});
        const data = await res.json();
        if(!res.ok || !data.ok){
          throw new Error(data.error || "Unable to load games");
        }
        renderGames(data.games || []);
        errorMessage.textContent = "";
      }catch(err){
        errorMessage.textContent = err.message;
        errorMessage.classList.add("err");
        gamesContainer.innerHTML = "";
      }
    }

    async function loadClaims(){
      try{
        const key = getApiKey();
        const res = await fetch("/user-area/manage/claims?limit=2000", {headers: key ? {"X-API-Key": key} : {}});
        const data = await res.json();
        if(!res.ok || !data.ok){
          throw new Error(data.error || "Unable to load claims");
        }
        renderClaims(data.users || []);
      }catch(err){
        claimsContainer.innerHTML = `<div class='muted'>${err.message || "Unable to load claims"}</div>`;
      }
    }

    function renderClaims(users){
      if(!users.length){
        claimsContainer.innerHTML = "<div class='muted'>No characters registered yet.</div>";
        return;
      }
      claimsContainer.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Character</th>
              <th>Server</th>
              <th>XIV ID</th>
              <th>Last seen</th>
            </tr>
          </thead>
          <tbody>
            ${users.map((u, idx) => `
              <tr>
                <td>${idx + 1}</td>
                <td>${u.xiv_username || "-"}</td>
                <td>${u.world || "-"}</td>
                <td>${u.xiv_id || "-"}</td>
                <td>${u.last_seen || u.updated_at || "-"}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    function renderGames(games){
      if(!games.length){
        gamesContainer.innerHTML = "<div class='muted'>No games to show.</div>";
        return;
      }
      gamesContainer.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Game ID</th>
              <th>Module</th>
              <th>Status</th>
              <th>Active</th>
              <th>Claimed by</th>
              <th>Created</th>
            </tr>
          </thead>
          <tbody>
            ${games.map((g, idx) => `
              <tr>
                <td>${idx + 1}</td>
                <td>${g.game_id || g.id || "-"}</td>
                <td>${g.module || "-"}</td>
                <td>${g.status || "-"}</td>
                <td>${g.active ? "Yes" : "No"}</td>
                <td>${g.claimed_by || "-"}</td>
                <td>${g.created_at || "-"}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    async function refreshAll(){
      await Promise.all([loadClaims(), loadGames()]);
    }

    refreshBtn.addEventListener("click", refreshAll);
    refreshAll();
  </script>
</body>
</html>
