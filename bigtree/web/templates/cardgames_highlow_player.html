<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>High/Low Session</title>
  <link rel="icon" href="/icon.png" type="image/png">
  <style>
    body{margin:0;font-family:"Spectral","Georgia",serif;background:#0b1310;color:#e7f2ea;min-height:100vh;position:relative;overflow-x:hidden}
    body::before{content:"";position:fixed;inset:0;background:var(--bg-image) center/cover no-repeat;opacity:0;pointer-events:none;transition:opacity .6s ease}
    body.has-bg::before{opacity:.25}
    header{padding:18px;border-bottom:1px solid rgba(255,255,255,.08)}
    main{padding:18px;display:grid;gap:16px;justify-items:center}
    .panel{background:#101a15;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:14px;width:100%;max-width:960px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:center}
    .card{padding:10px 12px;border-radius:14px;background:#0c1511;border:1px solid rgba(255,255,255,.08);font-weight:600;display:flex;align-items:center;justify-content:center;min-width:120px;min-height:180px;margin:0 auto}
    .card img{max-width:180px;max-height:260px;border-radius:10px;display:block}
    .decision-grid{display:grid;grid-template-columns:repeat(2,minmax(120px,1fr));gap:12px;width:100%}
    .decision-row{display:grid;grid-template-columns:repeat(2,minmax(120px,1fr));gap:12px;width:100%}
    .actions button{padding:10px 14px;border-radius:999px;border:1px solid rgba(107,212,162,.4);background:#122019;color:#e7f2ea;cursor:pointer;font-weight:600}
    .actions button[disabled]{opacity:.45;cursor:not-allowed}
    .hint{margin-top:10px;color:#9fb4a6;font-size:14px}
    .muted{color:#9fb4a6}
    .risk{display:flex;gap:8px;align-items:center;justify-content:center;color:#e8d1a4}
    .risk strong{color:#f2e2bf}
    .pulse{box-shadow:0 0 18px rgba(214,178,110,.35)}
  </style>
</head>
<body>
  <header>
    <h1>High/Low</h1>
    <div class="muted" id="statusLine">Waiting for session...</div>
  </header>
  <main>
    <div class="panel">
      <div class="row">
        <div>Pot: <strong id="potValue">0</strong> gil</div>
        <div>Winnings: <strong id="winValue">0</strong> gil</div>
      </div>
      <div class="row muted" id="phaseLine">Phase: --</div>
    </div>
    <div class="panel">
      <div class="muted">Current card</div>
      <div class="card" id="currentCard">--</div>
    </div>
    <div class="panel actions" id="decisionPanel">
      <div class="muted">Decision</div>
      <div class="decision-grid">
        <button id="higherBtn">Higher</button>
        <button id="lowerBtn">Lower</button>
      </div>
      <div class="decision-row">
        <button id="doubleBtn">Double</button>
        <button id="stopBtn">Stop</button>
      </div>
      <div class="hint" id="decisionHint">Choose your next move.</div>
      <div class="risk" id="riskPreview"></div>
    </div>
    <div class="panel">
      <div class="muted" id="resultLine">Result: --</div>
    </div>
    <div class="panel">
      <div class="muted">Artist credits</div>
      <div id="artistCredits" class="muted">No artist credits.</div>
    </div>
  </main>
<script>
  const joinCode = "{JOIN}";
  const gameId = "highlow";
  const statusLine = document.getElementById("statusLine");
  const potValue = document.getElementById("potValue");
  const winValue = document.getElementById("winValue");
  const phaseLine = document.getElementById("phaseLine");
  const currentCard = document.getElementById("currentCard");
  const resultLine = document.getElementById("resultLine");
  const artistCredits = document.getElementById("artistCredits");
  const higherBtn = document.getElementById("higherBtn");
  const lowerBtn = document.getElementById("lowerBtn");
  const doubleBtn = document.getElementById("doubleBtn");
  const stopBtn = document.getElementById("stopBtn");
  const decisionHint = document.getElementById("decisionHint");
  const riskPreview = document.getElementById("riskPreview");
  const tokenKey = `cardgame_${gameId}_token_${joinCode}`;
  let playerToken = "";
  let sessionId = "";
  let pendingAction = false;

  function cardLabel(card){
    if (!card) return "--";
    const suitMap = {spades:"S", hearts:"H", diamonds:"D", clubs:"C"};
    return `${card.rank || "?"}${suitMap[card.suit] || ""}`;
  }

  function collectArtists(cards){
    const artists = [];
    (cards || []).forEach(card => {
      if (!card) return;
      const name = card.artist_name || card.artist || card.artist_id || "";
      if (name && !artists.includes(name)){
        artists.push(name);
      }
    });
    return artists;
  }

  function renderArtists(cards){
    const names = collectArtists(cards);
    if (!names.length){
      artistCredits.textContent = "No artist credits.";
      return;
    }
    artistCredits.innerHTML = names.map(n => `<div>${n}</div>`).join("");
  }

  function applyBackground(url){
    if (!url){
      document.body.classList.remove("has-bg");
      document.body.style.removeProperty("--bg-image");
      return;
    }
    document.body.style.setProperty("--bg-image", `url('${url}')`);
    document.body.classList.add("has-bg");
  }

  async function ensureToken(){
    playerToken = localStorage.getItem(tokenKey) || "";
    if (playerToken) return;
    const res = await fetch(`/api/cardgames/${gameId}/sessions/${joinCode}/join`, {method:"POST"});
    const data = await res.json();
    if (data && data.redirect){
      window.location.assign(data.redirect);
      return;
    }
    if (data && data.player_token){
      playerToken = data.player_token;
      localStorage.setItem(tokenKey, playerToken);
    }
  }

  async function postAction(action){
    await ensureToken();
    if (!sessionId) return;
    pendingAction = true;
    setButtonsState(false);
    decisionHint.textContent = "Waiting for the dealer...";
    await fetch(`/api/cardgames/${gameId}/sessions/${sessionId}/action`, {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({token: playerToken, action, payload: {}})
    });
    loadState();
  }

  function resultCopy(result, winnings){
    if (result === "win") return `The risk paid off. Winnings now ${winnings} gil.`;
    if (result === "lose") return "The forest was not kind. You lost everything.";
    if (result === "stopped") return `You leave the table richer with ${winnings} gil.`;
    return "Awaiting decision.";
  }

  function setButtonsState(enabled){
    const controls = [higherBtn, lowerBtn, doubleBtn, stopBtn];
    controls.forEach(btn => { btn.disabled = !enabled; });
  }

  function updatePreview(basePot, winnings, pendingMultiplier){
    const base = winnings > 0 ? winnings : basePot;
    const nextWin = Math.max(base, 0) * pendingMultiplier;
    riskPreview.innerHTML = `<span>Potential payout:</span> <strong>${nextWin}</strong> gil`;
  }

  function hintFor(action, pot, winnings, pendingMultiplier){
    const base = winnings > 0 ? winnings : pot;
    const nextWin = Math.max(base, 0) * pendingMultiplier;
    if (action === "double") return `If you win, winnings become ${nextWin} gil. If you lose, you lose everything.`;
    if (action === "stop") return `Dealer pays out ${winnings} gil.`;
    if (action === "higher") return `Choose higher. If you win, winnings become ${nextWin} gil.`;
    if (action === "lower") return `Choose lower. If you win, winnings become ${nextWin} gil.`;
    return "Choose your next move.";
  }

  function render(state){
    if (!state || !state.session) return;
    sessionId = state.session.session_id || "";
    const pot = state.session.pot || 0;
    const winnings = state.session.winnings || 0;
    const phase = (state.state && state.state.phase) || "--";
    const pendingMultiplier = (state.state && state.state.pending_multiplier) || 1;
    const doublesUsed = (state.state && state.state.doubles_used) || 0;
    const maxDoubles = (state.state && state.state.max_doubles) || 0;
    const basePot = (state.state && state.state.base_pot) || pot;

    pendingAction = false;
    potValue.textContent = pot;
    winValue.textContent = winnings;
    phaseLine.textContent = `Phase: ${phase}`;
    statusLine.textContent = `Status: ${state.session.status}`;
    applyBackground(state.session.background_url || "");

    const current = state.state && state.state.current;
    currentCard.innerHTML = current && current.image ? `<img src="${current.image}" alt="${cardLabel(current)}">` : cardLabel(current);
    renderArtists([current]);

    const result = state.state && (state.state.last_result || state.state.result) ? (state.state.last_result || state.state.result) : null;
    resultLine.textContent = resultCopy(result, winnings);

    const live = state.session.status === "live";
    const inDecision = phase === "decision" && live;
    const canDouble = inDecision && winnings > 0 && (!maxDoubles || doublesUsed < maxDoubles) && pendingMultiplier < 2;
    const canStop = inDecision && winnings > 0;
    const canGuess = inDecision;

    higherBtn.disabled = !canGuess;
    lowerBtn.disabled = !canGuess;
    doubleBtn.disabled = !canDouble;
    stopBtn.disabled = !canStop;

    decisionHint.textContent = inDecision ? "Choose your next move." : "Waiting for the dealer...";
    updatePreview(basePot, winnings, pendingMultiplier);

    if (pendingMultiplier > 1){
      document.getElementById("decisionPanel").classList.add("pulse");
    }else{
      document.getElementById("decisionPanel").classList.remove("pulse");
    }

    if (!live){
      decisionHint.textContent = "Session is not live yet.";
    }
  }

  higherBtn.addEventListener("click", () => postAction("higher"));
  lowerBtn.addEventListener("click", () => postAction("lower"));
  doubleBtn.addEventListener("click", () => postAction("double"));
  stopBtn.addEventListener("click", () => postAction("stop"));

  [higherBtn, lowerBtn, doubleBtn, stopBtn].forEach((btn) => {
    btn.addEventListener("mouseenter", () => {
      if (btn.disabled || !sessionId) return;
      const pot = Number(potValue.textContent || 0);
      const winnings = Number(winValue.textContent || 0);
      const multiplier = btn === doubleBtn ? 2 : 1;
      const action = btn === higherBtn ? "higher" : btn === lowerBtn ? "lower" : btn === doubleBtn ? "double" : "stop";
      decisionHint.textContent = hintFor(action, pot, winnings, multiplier);
    });
    btn.addEventListener("mouseleave", () => {
      decisionHint.textContent = "Choose your next move.";
    });
  });

  async function loadState(){
    const res = await fetch(`/api/cardgames/${gameId}/sessions/${joinCode}/state?view=player`);
    const data = await res.json();
    if (data && data.ok && data.state){
      render(data.state);
    }else if (data && data.redirect){
      window.location.assign(data.redirect);
    }
  }

  const src = new EventSource(`/api/cardgames/${gameId}/sessions/${joinCode}/stream?view=player`);
  src.onmessage = (ev) => {
    try{
      const payload = JSON.parse(ev.data);
      if (payload.type === "STATE" && payload.state){
        render(payload.state);
      }else{
        loadState();
      }
    }catch(err){}
  };
  loadState();
  setInterval(() => {
    if (!document.hidden) loadState();
  }, 3000);
</script>
</body>
</html>
