<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Forest Management</title>
    <style>
      :root{
        --bg-1:#0b1611;
        --bg-2:#0e2419;
        --bg-3:#102c1d;
        --panel:#0f1e16;
        --panel-2:#0a1510;
        --ink:#e8f7ef;
        --muted:#9bb6a7;
        --accent:#9de07d;
        --accent-2:#3ccf8e;
        --line:#1f3a2b;
        --shadow:0 18px 40px rgba(0,0,0,.35);
        --radius:18px;
      }
      *{box-sizing:border-box}
      body{
        margin:0;
        min-height:100vh;
        font-family:"Palatino Linotype","Book Antiqua",serif;
        color:var(--ink);
        background:
          radial-gradient(1200px 600px at 15% -10%, rgba(157,224,125,.18), transparent 60%),
          radial-gradient(900px 700px at 120% 20%, rgba(60,207,142,.18), transparent 60%),
          linear-gradient(160deg, var(--bg-1), var(--bg-2) 55%, var(--bg-3));
        background-repeat:no-repeat;
        background-size:cover;
        background-attachment:fixed;
      }
      body.overlay{
        background:transparent;
      }
      body.overlay .sidebar{
        display:none;
      }
      body.overlay .top{
        display:none;
      }
      body.overlay .app-shell{
        grid-template-columns:1fr;
      }
      body.overlay .content{
        padding:12px;
      }
      .overlay-exit{
        position:fixed;
        top:12px;
        right:12px;
        z-index:9999;
        padding:6px 10px;
        border-radius:10px;
        border:1px solid rgba(255,255,255,.2);
        background:rgba(10,20,16,.8);
        color:var(--ink);
        cursor:pointer;
        display:none;
      }
      body.overlay .overlay-exit{
        display:inline-flex;
        align-items:center;
        gap:6px;
      }
      .hidden{display:none !important}
      .login-screen{
        min-height:100vh;
        display:flex;
        align-items:center;
        justify-content:center;
        padding:24px;
      }
      .login-card{
        width:min(480px,92vw);
        background:rgba(10,16,28,.86);
        border:1px solid var(--line);
        border-radius:var(--radius);
        padding:24px;
        box-shadow:var(--shadow);
        text-align:center;
      }
      .login-title{
        font-family:"Copperplate Gothic","Palatino Linotype",serif;
        font-size:22px;
        letter-spacing:.1em;
        text-transform:uppercase;
        color:var(--accent);
        margin-bottom:6px;
      }
      .login-sub{color:var(--muted);margin-bottom:16px}
      .login-card input{margin:8px 0 16px}
      .app-shell{
        display:grid;
        grid-template-columns:260px 1fr;
        min-height:100vh;
      }
      .sidebar{
        background:rgba(9,14,20,.9);
        border-right:1px solid var(--line);
        padding:20px 16px;
      }
      .sidebar .status{
        margin-top:12px;
      }
      .sidebar h3{
        margin:16px 0 8px;
        font-size:12px;
        text-transform:uppercase;
        letter-spacing:.12em;
        color:var(--muted);
      }
      .menu-item{
        padding:8px 10px;
        border-radius:10px;
        cursor:pointer;
        color:var(--ink);
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:10px;
      }
      .menu-item.active{
        background:rgba(60,207,142,.18);
        border:1px solid rgba(60,207,142,.4);
      }
      .sidebar{
        display:flex;
        flex-direction:column;
        gap:12px;
      }
      .sidebar-body{
        display:flex;
        flex-direction:column;
        gap:10px;
        flex:1;
      }
      .menu-icons{
        display:flex;
        gap:10px;
        align-items:center;
        margin-top:6px;
      }
      .menu-icon{
        width:44px;
        height:44px;
        border-radius:12px;
        border:1px solid var(--line);
        background:rgba(15,30,22,.9);
        color:var(--ink);
        display:inline-flex;
        align-items:center;
        justify-content:center;
        cursor:pointer;
      }
      .menu-icon.active{
        border-color:rgba(157,224,125,.6);
        background:rgba(60,207,142,.18);
        color:var(--accent);
      }
      .menu-icon svg{
        width:20px;
        height:20px;
        fill:currentColor;
      }
      .icon-btn{
        width:44px;
        height:44px;
        padding:6px;
        border-radius:12px;
        display:inline-flex;
        align-items:center;
        justify-content:center;
      }
      .icon-btn svg{
        width:20px;
        height:20px;
        fill:currentColor;
      }
      .menu-sub{
        margin-left:12px;
        border-left:1px dashed rgba(255,255,255,.08);
        padding-left:10px;
      }
      .menu-refresh{
        width:auto;
        padding:4px 8px;
        font-size:12px;
        background:transparent;
        border:1px solid rgba(255,255,255,.12);
        color:var(--muted);
        border-radius:8px;
      }
      .menu-refresh svg{
        width:14px;
        height:14px;
        display:block;
        fill:currentColor;
      }
      .menu-refresh:hover{
        border-color:rgba(255,255,255,.25);
        color:var(--ink);
      }
      .menu-selected{
        margin:8px 0 12px 12px;
        font-size:12px;
        color:var(--muted);
      }
      .menu-game{
        font-size:13px;
        color:var(--muted);
        padding:6px 8px;
        border-radius:8px;
        cursor:pointer;
      }
      .menu-game:hover{background:rgba(255,255,255,.04)}
      .content{
        padding:24px;
        display:flex;
        flex-direction:column;
        gap:18px;
        animation:fadeup .6s ease both;
      }
      .top{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:16px;
      }
      .brand{
        font-family:"Copperplate Gothic","Palatino Linotype",serif;
        font-size:20px;
        letter-spacing:.08em;
        text-transform:uppercase;
        color:var(--accent);
      }
      .brand-user{
        display:flex;
        align-items:center;
        gap:6px;
        font-size:12px;
        letter-spacing:.08em;
        text-transform:uppercase;
        color:var(--muted);
        margin-top:-6px;
      }
      .brand-user svg{
        width:20px;
        height:20px;
        fill:currentColor;
      }
      .brand-user img{
        width:20px;
        height:20px;
        border-radius:50%;
        object-fit:cover;
        border:1px solid var(--line);
      }
      .toggle{
        display:flex;
        align-items:center;
        gap:8px;
        font-size:14px;
        color:var(--muted);
      }
      .grid{
        display:grid;
        grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
        gap:18px;
      }
      .panel{
        background:rgba(10,16,28,.86);
        border:1px solid var(--line);
        border-radius:var(--radius);
        padding:18px 18px 16px;
        box-shadow:var(--shadow);
        position:relative;
        overflow:hidden;
        animation:rise .6s ease both;
      }
      .panel:before{
        content:"";
        position:absolute;
        inset:0;
        background:linear-gradient(120deg, rgba(157,224,125,.12), transparent 45%);
        pointer-events:none;
      }
      .panel h2{
        margin:0 0 10px;
        font-size:18px;
        text-transform:uppercase;
        letter-spacing:.08em;
        color:var(--accent-2);
      }
      .panel h3{
        margin:14px 0 8px;
        font-size:14px;
        text-transform:uppercase;
        letter-spacing:.08em;
        color:var(--muted);
      }
      #tarotDecksPanel{
        padding:12px;
        font-size:12px;
      }
      #tarotDecksPanel h2{
        font-size:16px;
        margin-bottom:8px;
      }
      #tarotDecksPanel h3{
        font-size:12px;
        margin:10px 0 6px;
      }
      #tarotDecksPanel .row{
        gap:6px;
        margin-bottom:6px;
      }
      #tarotDecksPanel input,
      #tarotDecksPanel select,
      #tarotDecksPanel textarea,
      #tarotDecksPanel button{
        padding:6px 8px;
        font-size:12px;
      }
      #tarotDecksPanel textarea{
        min-height:52px;
      }
      #tarotDecksPanel .list{
        max-height:140px;
      }
      #tarotDecksPanel .preview-card{
        max-height:180px;
      }
      .muted{color:var(--muted)}
      .owner-meta{
        display:flex;
        align-items:center;
        gap:10px;
        font-size:12px;
        color:var(--muted);
        flex-wrap:nowrap;
        white-space:nowrap;
      }
      .owner-meta .owner-cards{font-weight:500}
      .owner-meta .owner-link{
        color:var(--accent);
        text-decoration:none;
        font-weight:500;
      }
      .owner-meta .owner-link:hover{text-decoration:underline}
      .owner-meta .owner-copy{
        max-width:110px;
        padding:4px 8px;
        font-size:12px;
        font-weight:500;
      }
      .owner-meta .owner-copy-icon{
        width:28px;
        height:28px;
        padding:4px;
        border-radius:8px;
        display:inline-flex;
        align-items:center;
        justify-content:center;
        background:transparent;
        border:1px solid rgba(255,255,255,.18);
        color:var(--muted);
      }
      .owner-meta .owner-copy-icon:hover{
        color:var(--ink);
        border-color:rgba(255,255,255,.3);
      }
      .owner-meta .owner-copy-icon svg{
        width:14px;
        height:14px;
        fill:currentColor;
      }
      #bOwners{
        max-height:140px;
        padding:6px;
      }
      .owner-row{
        padding:2px 6px;
        border-bottom:1px solid rgba(255,255,255,0.06);
      }
      .owner-row strong{
        font-size:11px;
        font-weight:600;
        line-height:1.1;
      }
      .owner-row .owner-meta{
        gap:4px;
        font-size:10px;
        line-height:1.1;
      }
      .row{
        display:grid;
        grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
        gap:10px;
        margin-bottom:10px;
      }
      label{
        display:block;
        font-size:12px;
        text-transform:uppercase;
        letter-spacing:.08em;
        color:var(--muted);
        margin-bottom:4px;
      }
      input, select, textarea, button{
        width:100%;
        border-radius:10px;
        border:1px solid var(--line);
        background:var(--panel-2);
        color:var(--ink);
        padding:8px 10px;
        font-family:"Palatino Linotype","Book Antiqua",serif;
        font-size:14px;
      }
      textarea{min-height:70px;resize:vertical}
      button{
        cursor:pointer;
        background:linear-gradient(135deg, rgba(157,224,125,.9), rgba(60,207,142,.75));
        color:#0a1510;
        border:none;
        font-weight:700;
        letter-spacing:.04em;
        transition:transform .12s ease, box-shadow .12s ease;
      }
      button:hover{transform:translateY(-1px);box-shadow:0 8px 18px rgba(0,0,0,.25)}
      .btn-ghost{
        background:transparent;
        border:1px solid var(--line);
        color:var(--ink);
      }
      #bingoPanel input,
      #bingoPanel select,
      #bingoPanel button{
        font-size:12px;
        padding:6px 8px;
      }
      #bingoPanel .btn-ghost{
        font-weight:600;
      }
      .pill{
        display:inline-block;
        padding:4px 10px;
        border-radius:999px;
        background:rgba(60,207,142,.18);
        color:var(--accent-2);
        font-size:12px;
        letter-spacing:.06em;
        text-transform:uppercase;
      }
      .status{
        font-size:13px;
        color:var(--muted);
        padding:10px 12px;
        border-radius:12px;
        border:1px solid var(--line);
        background:rgba(6,10,18,.6);
      }
      .status.ok{color:#b8ffce;border-color:rgba(160,255,196,.3)}
      .status.err{color:#ff9f9f;border-color:rgba(255,159,159,.3)}
      .list{
        max-height:180px;
        overflow:auto;
        border-radius:12px;
        border:1px solid var(--line);
        padding:10px;
        background:rgba(6,10,18,.6);
        font-size:13px;
        color:var(--muted);
        white-space:pre-wrap;
      }
      .list-header{
        font-size:12px;
        text-transform:uppercase;
        letter-spacing:.08em;
        color:var(--accent-2);
        margin-bottom:8px;
      }
      .list-card{
        padding:8px 6px;
        border-bottom:1px solid rgba(255,255,255,0.06);
      }
      .list-card:last-child{border-bottom:none}
      .list-card.clickable{cursor:pointer}
      .list-card.active{
        background:rgba(60,207,142,.12);
        border-radius:10px;
      }
      .list-warn{
        color:#ff9f9f;
      }
      .preview-grid{
        display:grid;
        grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
        gap:12px;
      }
      .preview-card{
        aspect-ratio:3/4.2;
        border-radius:12px;
        border:1px solid var(--line);
        background:rgba(10,16,28,.6);
        overflow:hidden;
        display:flex;
        align-items:center;
        justify-content:center;
        position:relative;
      }
      .preview-card.library-card{
        aspect-ratio:auto;
        align-items:stretch;
        justify-content:flex-start;
        padding:8px 0;
        gap:4px;
      }
      .preview-card.library-card .preview-label{
        font-size:12px;
        text-transform:uppercase;
        letter-spacing:.06em;
        color:var(--accent);
      }
      .preview-card.library-card .muted{
        font-size:11px;
      }
      .preview-card.library-card img{
        width:calc(100% - 16px);
        height:180px;
        object-fit:cover;
        border-radius:10px;
        margin:0 8px;
      }
      .preview-card.library-card .btn-ghost{
        margin:0 8px 8px;
      }
      .preview-card img{
        width:100%;
        height:100%;
        object-fit:cover;
      }
      .preview-label{
        position:absolute;
        bottom:8px;
        left:8px;
        padding:2px 8px;
        border-radius:999px;
        background:rgba(0,0,0,.5);
        font-size:11px;
        letter-spacing:.06em;
        text-transform:uppercase;
      }
      .subgrid{
        display:grid;
        grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
        gap:10px;
      }
      .links a{
        color:var(--accent);
        text-decoration:none;
      }
      .links a:hover{text-decoration:underline}
      .modal{
        position:fixed;
        inset:0;
        background:rgba(6,12,9,.7);
        display:none;
        align-items:center;
        justify-content:center;
        z-index:20;
      }
      #uploadLibraryModal{
        z-index:30;
      }
      .modal.show{display:flex}
      .modal-card{
        width:min(720px,92vw);
        background:var(--panel);
        border:1px solid var(--line);
        border-radius:20px;
        padding:18px;
        box-shadow:var(--shadow);
      }
      .modal-card--wide{
        width:min(1400px,92vw);
        height:90vh;
        display:flex;
        flex-direction:column;
      }
      .modal-card--wide .list{
        flex:1;
        max-height:none;
        overflow:auto;
      }
      .modal-header{
        display:flex;
        justify-content:space-between;
        align-items:center;
        margin-bottom:10px;
      }
      .modal-title{
        font-size:16px;
        letter-spacing:.08em;
        text-transform:uppercase;
        color:var(--accent-2);
      }
      .bingo-summary{
        display:grid;
        grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
        gap:10px;
        font-size:13px;
        color:var(--muted);
      }
      .bingo-card{
        margin-top:12px;
        border:1px solid var(--line);
        border-radius:14px;
        background:rgba(9,13,22,.7);
        padding:10px;
      }
      .bingo-header, .bingo-grid{
        display:grid;
        grid-template-columns:repeat(4,1fr);
        gap:6px;
        text-align:center;
      }
      .bingo-header div{
        font-weight:700;
        text-transform:uppercase;
        letter-spacing:.08em;
        color:var(--accent);
        padding:6px 0;
      }
      .bingo-cell{
        padding:10px 0;
        border-radius:8px;
        background:rgba(12,18,32,.9);
        border:1px solid rgba(255,255,255,.05);
        color:var(--ink);
      }
      .bingo-cell.marked{
        background:rgba(60,207,142,.2);
        border-color:rgba(60,207,142,.7);
        color:#d6ffe9;
      }
      .bingo-called{
        font-size:12px;
        color:var(--muted);
        max-height:90px;
        overflow:auto;
        border:1px dashed rgba(255,255,255,.12);
        border-radius:10px;
        padding:8px;
      }
      .bingo-called-grid{
        display:grid;
        grid-template-columns:repeat(auto-fit,minmax(34px,1fr));
        gap:6px;
        margin-top:8px;
      }
      .bingo-call-btn{
        border-radius:8px;
        padding:6px 0;
        background:rgba(12,18,32,.9);
        border:1px solid rgba(255,255,255,.08);
        color:var(--ink);
        font-size:12px;
        cursor:pointer;
      }
      .bingo-call-btn.active{
        background:rgba(157,224,125,.2);
        border-color:rgba(157,224,125,.6);
        color:#dcffcf;
      }
      .bingo-callout{
        position:fixed;
        right:24px;
        bottom:24px;
        background:rgba(8,12,20,.9);
        border:1px solid rgba(157,224,125,.55);
        border-radius:14px;
        padding:12px 16px;
        font-weight:700;
        letter-spacing:.06em;
        color:#dcffcf;
        box-shadow:var(--shadow);
        opacity:0;
        transform:translateY(10px);
        transition:opacity .2s ease, transform .2s ease;
        pointer-events:none;
      }
      .bingo-callout.show{
        opacity:1;
        transform:translateY(0);
      }
      .bingo-card{
        background-size:cover;
        background-position:center;
      }
      @keyframes fadeup{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
      @keyframes rise{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
      @media (max-width:900px){
        .app-shell{grid-template-columns:1fr}
        .sidebar{border-right:none;border-bottom:1px solid var(--line)}
      }
    </style>
  </head>
  <body>
    <button class="overlay-exit" id="overlayExit">Exit overlay</button>
    <div class="login-screen" id="loginView">
      <div class="login-card">
        <div class="login-title">Forest Management</div>
        <div class="login-sub">Enter your API key to manage the forest.</div>
        <label for="apiKeyLogin">API key</label>
        <input id="apiKeyLogin" placeholder="Paste /auth token">
        <button id="loginBtn">Login</button>
        <div class="status" id="loginStatus">Ready.</div>
      </div>
    </div>

    <div class="app-shell hidden" id="appView">
      <aside class="sidebar">
        <div class="sidebar-body">
          <div class="brand">Forest Management</div>
          <div class="brand-user hidden" id="brandUser">
            <img id="brandUserIcon" alt="" class="hidden">
            <svg viewBox="0 0 24 24" aria-hidden="true" id="brandUserFallback">
              <path d="M12 4a4 4 0 1 1-4 4 4 4 0 0 1 4-4zm0 10c3.31 0 6 1.34 6 3v3H6v-3c0-1.66 2.69-3 6-3z"/>
            </svg>
            <span id="brandUserName"></span>
          </div>
        <h3>Bingo</h3>
        <div class="menu-item active" id="menuBingo">
          <span>Manager</span>
          <div style="display:flex;gap:6px;align-items:center">
              <button class="menu-refresh" id="menuBingoRefresh" title="Refresh games" aria-label="Refresh games">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M12 5a7 7 0 1 1-6.65 9H3a9 9 0 1 0 2.64-6.36L3 6v6h6l-2.55-2.55A7 7 0 0 1 12 5z"/>
                </svg>
              </button>
              <button class="menu-refresh" id="menuCreateGame" title="Create game" aria-label="Create game">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M11 5h2v14h-2zM5 11h14v2H5z"/>
                </svg>
              </button>
            </div>
          </div>
        <div class="menu-sub" id="menuGames"></div>
        <div class="hidden" id="menuCreateGamePlaceholder"></div>
        <h3>Tarot</h3>
        <div class="menu-item" id="menuTarotLinks">Session Manager</div>
        <div class="menu-item" id="menuTarotDecks">Deck Editor</div>
        <h3>Contests</h3>
        <div class="menu-item" id="menuContests">Management</div>
          <div class="menu-icons">
            <button class="menu-icon" id="menuMedia" title="Media management" aria-label="Media management">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 5h16a1 1 0 0 1 1 1v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a1 1 0 0 1 1-1zm0 2v10h15a0 0 0 0 0 0 0V7H4zm3 8 3-4 3 3 2-2 4 5H7z"/>
              </svg>
            </button>
            <button class="menu-icon" id="menuArtists" title="Artist index" aria-label="Artist index">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 4a4 4 0 1 1-4 4 4 4 0 0 1 4-4zm0 10c3.31 0 6 1.34 6 3v3H6v-3c0-1.66 2.69-3 6-3z"/>
              </svg>
            </button>
            <button class="menu-icon" id="menuOverlayToggle" title="Toggle overlay mode" aria-label="Toggle overlay mode">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h10v2H4z"/>
              </svg>
            </button>
            <input type="checkbox" id="overlayMode" class="hidden">
          </div>
          <div class="status" id="status">Ready.</div>
        </div>
      </aside>
      <main class="content">
      <div class="grid">
        <section class="panel" style="animation-delay:.05s" id="bingoPanel">
          <h2>Manager</h2>
        <h3>Players</h3>
        <div class="list" id="bOwners">No players loaded.</div>

        <h3>Claims</h3>
      <div class="row">
        <div>
          <label>&nbsp;</label>
          <button class="btn-ghost" id="bAdvanceStage">Advance stage</button>
        </div>
        <div>
          <label>
            <input type="checkbox" id="bAnnounceToggle">
            Announce calls
          </label>
        </div>
      </div>
        <div class="list" id="bClaims">No claims yet.</div>

          <h3>Active game</h3>
          <div class="row">
            <div>
              <label for="bGameId">Game ID</label>
              <div id="bGameId" class="status">No game selected.</div>
            </div>
          </div>

          <div class="row">
            <div>
              <label>&nbsp;</label>
              <button class="btn-ghost" id="bStart">Start game</button>
            </div>
            <div>
              <label>&nbsp;</label>
              <button id="bRoll">Pull random number</button>
            </div>
            <div>
              <label>&nbsp;</label>
              <button class="btn-ghost" id="bRefresh">Refresh</button>
            </div>
            <div>
              <label>&nbsp;</label>
              <button class="btn-ghost" id="bCloseGame">Close game</button>
            </div>
          </div>


          <div class="row">
            <div>
              <label>&nbsp;</label>
              <button class="btn-ghost" id="bViewOwner">View tickets</button>
            </div>
          </div>

          <h3>Buy cards</h3>
          <div class="row">
            <div>
              <label for="bOwner">Owner name</label>
              <input id="bOwner" placeholder="Player name">
            </div>
            <div>
            <label for="bOwnerId">Discord ID</label>
              <input id="bOwnerId" placeholder="optional">
            </div>
            <div>
              <label for="bQty">Quantity</label>
              <input id="bQty" type="number" value="1">
            </div>
            <div>
              <label>&nbsp;</label>
              <button id="bBuy">Buy</button>
            </div>
          </div>

          <div class="row">
            <div>
              <span class="pill">Game state</span>
            </div>
          </div>
          <div class="bingo-summary" id="bSummary">
            <div>Title: <span id="bTitleVal">-</span></div>
            <div>Header: <span id="bHeaderVal">-</span></div>
            <div>Stage: <span id="bStageVal">-</span></div>
            <div>Pot: <span id="bPotVal">-</span></div>
          </div>
          <div class="bingo-called" id="bCalled">Called numbers: -</div>
          <div class="bingo-called-grid" id="bCalledGrid"></div>
          <div class="bingo-card" id="bCard">
            <div class="bingo-header" id="bCardHeader"></div>
            <div class="bingo-grid" id="bCardGrid"></div>
          </div>
        </section>

        <section class="panel" style="animation-delay:.1s" id="tarotLinksPanel">
          <h2>Session Manager</h2>
          <p>Open the player, priestess, or overlay view.</p>
          <div class="row">
            <div>
              <label for="tSessionSelect">Existing sessions</label>
              <select id="tSessionSelect"></select>
            </div>
            <div>
              <label>&nbsp;</label>
              <button id="tSessionRefresh" class="menu-refresh" title="Refresh sessions" aria-label="Refresh sessions">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M12 5a7 7 0 1 1-6.65 9H3a9 9 0 1 0 2.64-6.36L3 6v6h6l-2.55-2.55A7 7 0 0 1 12 5z"/>
                </svg>
              </button>
            </div>
            <div>
              <label>&nbsp;</label>
              <button id="tCreateSession">New session</button>
            </div>
          </div>
          <div class="row">
            <div>
              <label for="tJoinCode">Join code</label>
              <input id="tJoinCode" placeholder="e.g. AB12CD">
            </div>
            <div>
              <label for="tPriestessToken">Priestess token</label>
              <input id="tPriestessToken" placeholder="token (for priestess)">
            </div>
          </div>
          <div class="row">
            <div>
              <label>&nbsp;</label>
              <button id="tOpenPlayer">Open player</button>
            </div>
            <div>
              <label>&nbsp;</label>
              <button id="tOpenPriestess">Open priestess</button>
            </div>
            <div>
              <label>&nbsp;</label>
              <button id="tOpenOverlay">Open overlay</button>
            </div>
          </div>
          <div class="row links">
            <div>
              <span class="pill">Links</span>
              <div id="tLink">No join code entered.</div>
            </div>
          </div>
          <h3>Tarot Games</h3>
          <p>Create and manage tarot sessions.</p>
          <div class="status hidden" id="tSpreadNote">
            Spread = the card layout for the reading. Single: one card. Tree: Root/Trunk/Canopy. Cross: Past/Present/Future.
          </div>
        </section>

        <section class="panel hidden" style="animation-delay:.1s" id="tarotDecksPanel">
          <h2>Deck Editor</h2>
          <div class="row">
            <div>
              <label for="taDeck">Deck</label>
              <select id="taDeck"></select>
            </div>
            <div>
              <label>&nbsp;</label>
              <button id="taLoadDeck">Load deck</button>
            </div>
            <div>
              <label>&nbsp;</label>
              <button id="taAddDeck">Add deck</button>
            </div>
          </div>
          <div class="list" id="taDeckList">No deck loaded.</div>

          <h3>Add / Update Card</h3>
          <div class="row">
            <div>
              <label for="taCardId">Card ID</label>
              <input id="taCardId" placeholder="candlecap_sprite">
            </div>
            <div>
              <label for="taCardName">Name</label>
              <input id="taCardName" placeholder="Candlecap Sprite">
            </div>
            <div>
              <label for="taCardHouse">House</label>
              <select id="taCardHouse"></select>
            </div>
          </div>
          <div class="row">
            <div>
              <label for="taCardTags">Tags</label>
              <input id="taCardTags" placeholder="mischief,curiosity">
            </div>
          </div>
          <div class="row">
            <div>
              <label>Card image</label>
              <button class="btn-ghost icon-btn" id="taCardLibrary" title="Choose from library">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M4 5h16a1 1 0 0 1 1 1v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a1 1 0 0 1 1-1zm0 2v10h15a0 0 0 0 0 0 0V7H4zm3 8 3-4 3 3 2-2 4 5H7z"/>
                </svg>
              </button>
            </div>
            <div>
              <label>House info</label>
              <div class="list" id="taHouseInfo">Pick a house to see details.</div>
            </div>
          </div>
          <input id="taCardArtist" type="hidden">
          <div class="row">
            <div>
              <label>Card preview</label>
              <div class="preview-grid">
                <div class="preview-card" id="taFrontPreview"><span class="preview-label">Front</span></div>
                <div class="preview-card" id="taBackPreview"><span class="preview-label">Back</span></div>
              </div>
            </div>
          </div>
          <div class="row">
            <div>
              <label for="taCardUpright">Upright</label>
              <textarea id="taCardUpright"></textarea>
            </div>
            <div>
              <label for="taCardReversed">Reversed</label>
              <textarea id="taCardReversed"></textarea>
            </div>
          </div>

          <div class="row">
            <div>
              <label>&nbsp;</label>
              <button id="taSaveCard">Save card</button>
            </div>
          </div>
        </section>

        <section class="panel hidden" style="animation-delay:.1s" id="contestPanel">
          <h2>Contest Management</h2>
          <div class="row">
            <div>
              <label>&nbsp;</label>
              <button class="btn-ghost" id="contestRefresh">Refresh contests</button>
            </div>
          </div>
          <h3>All contests</h3>
          <div class="list" id="contestAllList">No contests loaded.</div>
          <h3>Ended contests</h3>
          <div class="list" id="contestEndedList">No ended contests yet.</div>
        </section>

      </div>
      </main>
    </div>
    <div class="modal" id="bCreateModal">
      <div class="modal-card">
        <div class="modal-header">
          <div class="modal-title">Create Bingo Game</div>
          <button class="btn-ghost" id="bCloseCreate">Close</button>
        </div>
        <div class="row">
          <div>
            <label for="bTitle">Title</label>
            <input id="bTitle" placeholder="Bingo Night">
          </div>
          <div>
            <label for="bHeader">Header</label>
            <input id="bHeader" placeholder="BING" maxlength="4">
          </div>
          <div>
            <label for="bPrice">Price</label>
            <input id="bPrice" type="number" value="10000">
          </div>
          <div>
            <label for="bCurrency">Currency</label>
            <input id="bCurrency" value="gil">
          </div>
          <div>
            <label for="bMaxCards">Max cards</label>
            <input id="bMaxCards" type="number" value="10">
          </div>
        </div>
        <div class="row">
          <div>
            <label for="bChannelSelect">Channel list</label>
            <select id="bChannelSelect"></select>
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="menu-refresh" id="bChannelRefresh" title="Refresh channels" aria-label="Refresh channels">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 5a7 7 0 1 1-6.65 9H3a9 9 0 1 0 2.64-6.36L3 6v6h6l-2.55-2.55A7 7 0 0 1 12 5z"/>
              </svg>
            </button>
          </div>
        </div>
        <input id="bChannel" type="hidden">
        <input id="bCreatedBy" type="hidden">
        <div class="row">
          <div>
            <label for="bAnnounceCalls">
              <input type="checkbox" id="bAnnounceCalls">
              Announce calls in Discord
            </label>
          </div>
          <div>
            <label for="bTheme">Theme color</label>
            <input id="bTheme" type="color" value="#9de07d">
          </div>
          <div>
            <label>Background image</label>
            <button class="btn-ghost icon-btn" id="bCreateBgLibrary" title="Choose from library">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 5h16a1 1 0 0 1 1 1v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a1 1 0 0 1 1-1zm0 2v10h15a0 0 0 0 0 0 0V7H4zm3 8 3-4 3 3 2-2 4 5H7z"/>
              </svg>
            </button>
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="bCreate">Create</button>
          </div>
        </div>
        <div class="status" id="bCreatePayload">Payload preview: channel_id=?, created_by=?</div>
      </div>
    </div>
    <div class="modal" id="bOwnerModal">
      <div class="modal-card modal-card--wide">
        <div class="modal-header">
          <div class="modal-title">Player Cards</div>
          <button class="btn-ghost" id="bOwnerClose">Close</button>
        </div>
        <div class="list" id="bOwnerCards">No tickets loaded.</div>
      </div>
    </div>
    <div class="modal" id="bPurchaseModal">
      <div class="modal-card">
        <div class="modal-header">
          <div class="modal-title">Player Link</div>
          <button class="btn-ghost" id="bPurchaseClose">Close</button>
        </div>
        <div class="row">
          <div>
            <label for="bPurchaseLink">Player link</label>
            <input id="bPurchaseLink" readonly>
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="btn-ghost" id="bPurchaseCopy">Copy link</button>
          </div>
        </div>
        <div class="status" id="bPurchaseStatus">Ready.</div>
      </div>
    </div>
    <div class="modal" id="uploadLibraryModal">
      <div class="modal-card">
        <div class="modal-header">
          <div class="modal-title" id="uploadLibraryTitle">Image Library</div>
          <button class="btn-ghost" id="uploadLibraryClose">Close</button>
        </div>
        <div class="row">
          <div>
            <label for="uploadLibraryFile">Upload image</label>
            <input id="uploadLibraryFile" type="file" accept="image/*">
          </div>
          <div>
            <label for="uploadLibraryTitle">Title</label>
            <input id="uploadLibraryTitle" placeholder="Image title">
          </div>
          <div>
            <label for="uploadLibraryArtist">Artist</label>
            <select id="uploadLibraryArtist"></select>
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="uploadLibraryUpload">Upload</button>
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="btn-ghost" id="uploadLibraryRefresh">Refresh</button>
          </div>
        </div>
        <div class="preview-grid" id="uploadLibraryGrid"></div>
        <div class="status" id="uploadLibraryStatus">Ready.</div>
      </div>
    </div>
    <div class="modal" id="deckCreateModal">
      <div class="modal-card">
        <div class="modal-header">
          <div class="modal-title">Create Deck</div>
          <button class="btn-ghost" id="deckCreateClose">Close</button>
        </div>
        <div class="row">
          <div>
            <label for="deckCreateId">Deck ID</label>
            <input id="deckCreateId" placeholder="elf-classic">
          </div>
          <div>
            <label for="deckCreateName">Name</label>
            <input id="deckCreateName" placeholder="Elf Classic">
          </div>
        </div>
        <div class="row">
          <div>
            <label>Deck back</label>
            <button class="btn-ghost icon-btn" id="deckCreateBackPick" title="Choose back image">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 5h16a1 1 0 0 1 1 1v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a1 1 0 0 1 1-1zm0 2v10h15a0 0 0 0 0 0 0V7H4zm3 8 3-4 3 3 2-2 4 5H7z"/>
              </svg>
            </button>
          </div>
          <div>
            <label for="deckCreateSeed">Seed dummy cards</label>
            <select id="deckCreateSeed">
              <option value="no">No</option>
              <option value="yes">Yes</option>
            </select>
          </div>
          <div>
            <label for="deckCreatePerHouse">Per house</label>
            <input id="deckCreatePerHouse" type="number" value="4" min="0">
          </div>
          <div>
            <label for="deckCreateCrown">Crown</label>
            <input id="deckCreateCrown" type="number" value="1" min="0">
          </div>
        </div>
        <div class="row">
          <div>
            <label>&nbsp;</label>
            <button id="deckCreateSubmit">Create deck</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal" id="sessionCreateModal">
      <div class="modal-card">
        <div class="modal-header">
          <div class="modal-title">Create Session</div>
          <button class="btn-ghost" id="sessionCreateClose">Close</button>
        </div>
        <div class="row">
          <div>
            <label for="sessionCreateDeck">Deck</label>
            <select id="sessionCreateDeck"></select>
          </div>
          <div>
            <label for="sessionCreateSpread">Spread</label>
            <select id="sessionCreateSpread">
              <option value="single">Single</option>
              <option value="tree">Tree</option>
              <option value="cross">Cross</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label>&nbsp;</label>
            <button id="sessionCreateSubmit">Create session</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal" id="mediaModal">
      <div class="modal-card">
        <div class="modal-header">
          <div class="modal-title">Media Management</div>
          <button class="btn-ghost" id="mediaClose">Close</button>
        </div>
        <div class="row">
          <div>
            <label>&nbsp;</label>
            <button class="btn-ghost icon-btn" id="mediaLibraryOpen" title="Open library">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 5h16a1 1 0 0 1 1 1v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a1 1 0 0 1 1-1zm0 2v10h15a0 0 0 0 0 0 0V7H4zm3 8 3-4 3 3 2-2 4 5H7z"/>
              </svg>
            </button>
          </div>
          <div class="muted" style="align-self:center">Upload and select images from the library.</div>
        </div>
      </div>
    </div>
    <div class="modal" id="artistModal">
      <div class="modal-card">
        <div class="modal-header">
          <div class="modal-title">Artist Index</div>
          <button class="btn-ghost" id="artistClose">Close</button>
        </div>
        <div class="row">
          <div>
            <label for="artistIndexSelect">Artist list</label>
            <select id="artistIndexSelect"></select>
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="btn-ghost" id="artistIndexRefresh">Refresh</button>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="artistIndexId">Artist ID (optional)</label>
            <input id="artistIndexId" placeholder="artist_id">
          </div>
          <div>
            <label for="artistIndexName">Name</label>
            <input id="artistIndexName" placeholder="Artist name">
          </div>
        </div>
        <div class="row">
          <div>
            <label for="artistIndexInstagram">Instagram</label>
            <input id="artistIndexInstagram" placeholder="https://instagram.com/...">
          </div>
          <div>
            <label for="artistIndexBluesky">Bluesky</label>
            <input id="artistIndexBluesky" placeholder="https://bsky.app/profile/...">
          </div>
          <div>
            <label for="artistIndexX">X / Twitter</label>
            <input id="artistIndexX" placeholder="https://x.com/...">
          </div>
          <div>
            <label for="artistIndexArtstation">ArtStation</label>
            <input id="artistIndexArtstation" placeholder="https://artstation.com/...">
          </div>
        </div>
        <div class="row">
          <div>
            <label for="artistIndexWebsite">Website</label>
            <input id="artistIndexWebsite" placeholder="https://...">
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="artistIndexSave">Save artist</button>
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="btn-ghost" id="artistIndexDelete">Delete artist</button>
          </div>
        </div>
      </div>
    </div>
    <script>
      const $ = (id) => document.getElementById(id);
      const statusEl = $("status");
      const loginStatusEl = $("loginStatus");
      const apiKeyEl = $("apiKeyLogin");
      const overlayToggle = $("overlayMode");
      const overlayToggleBtn = $("menuOverlayToggle");
      const storage = window.localStorage;
      let currentCard = null;
      let currentGame = null;
      let taSelectedCardId = "";
      let lastCalledCount = 0;
      let lastCalloutNumber = null;
      let activeGameId = "";
      let currentOwner = "";
      window.taArtists = [];

      function getBase(){
        return window.location.origin;
      }

      let librarySelectHandler = null;
      let libraryKind = "";

      function setLibraryStatus(msg, kind){
        const el = $("uploadLibraryStatus");
        el.textContent = msg;
        el.className = "status" + (kind ? " " + kind : "");
      }

      function showLibraryModal(show){
        $("uploadLibraryModal").classList.toggle("show", !!show);
        if (show){
          $("mediaModal").classList.remove("show");
          $("artistModal").classList.remove("show");
        }
      }

      async function loadLibrary(kind){
        libraryKind = kind;
        const grid = $("uploadLibraryGrid");
        const title = $("uploadLibraryTitle");
        title.textContent = "Media Library";
        setLibraryStatus("Loading...", "");
        grid.innerHTML = "";
        const path = "/api/media/list";
        try{
          const res = await fetch(path, {headers: {"X-API-Key": apiKeyEl.value.trim()}});
          if (res.status === 401){
            handleUnauthorized();
            throw new Error("Unauthorized");
          }
          const data = await res.json();
          if (!data.ok) throw new Error(data.error || "Failed");
          const items = data.items || [];
          if (!items.length){
            setLibraryStatus("No images found.", "err");
            return;
          }
          items.forEach(item => {
            const card = document.createElement("div");
            card.className = "preview-card library-card";

            const titleText = document.createElement("div");
            titleText.className = "preview-label";
            titleText.style.position = "static";
            titleText.style.margin = "8px 8px 2px";
            titleText.style.background = "transparent";
            titleText.style.padding = "0";
            titleText.textContent = item.title || item.name || "Untitled";

            const meta = document.createElement("div");
            meta.className = "muted";
            meta.style.padding = "0 8px 6px";
            meta.textContent = item.artist_name ? `Artist: ${item.artist_name}` : "";

            const img = document.createElement("img");
            img.src = item.url;
            img.alt = item.name || "image";

            const btn = document.createElement("button");
            btn.className = "btn-ghost";
            btn.style.margin = "0 8px 8px";
            btn.textContent = "Use";
            btn.addEventListener("click", () => {
              if (librarySelectHandler){
                librarySelectHandler(item);
              }
              showLibraryModal(false);
            });

            const del = document.createElement("button");
            del.className = "btn-ghost";
            del.style.margin = "0 8px 8px";
            del.textContent = "Delete";
            del.addEventListener("click", async () => {
              if (!confirm("Delete this file? This cannot be undone.")) return;
              try{
                const delUrl = item.delete_url || "";
                if (!delUrl){
                  throw new Error("Delete not available");
                }
                const res = await fetch(delUrl, {method: "DELETE", headers: {"X-API-Key": apiKeyEl.value.trim()}});
                const data = await res.json().catch(() => ({}));
                if (!res.ok || data.ok === false){
                  throw new Error(data.error || "Delete failed");
                }
                await loadLibrary(libraryKind);
              }catch(err){
                setLibraryStatus(err.message, "err");
              }
            });

            card.appendChild(titleText);
            if (meta.textContent){
              card.appendChild(meta);
            }
            card.appendChild(img);
            card.appendChild(btn);
            card.appendChild(del);
            grid.appendChild(card);
          });
          setLibraryStatus("Pick an image.", "ok");
        }catch(err){
          setLibraryStatus(err.message, "err");
        }
      }

      function getGameId(){
        return ($("bGameId").dataset.gameId || "").trim();
      }

      function setGameId(id){
        const gid = (id || "").trim();
        $("bGameId").dataset.gameId = gid;
        $("bGameId").textContent = gid ? gid : "No game selected.";
      }

      function setStatus(msg, kind){
        statusEl.textContent = msg;
        statusEl.className = "status" + (kind ? " " + kind : "");
      }

      function applyTheme(color){
        const panel = $("bingoPanel");
        if (!panel){
          return;
        }
        if (!color){
          panel.style.removeProperty("--accent");
          panel.style.removeProperty("--accent-2");
          panel.style.removeProperty("--line");
          panel.style.removeProperty("--panel");
          return;
        }
        const hex = color.startsWith("#") ? color.slice(1) : color;
        if (hex.length !== 6) return;
        const r = parseInt(hex.slice(0,2), 16);
        const g = parseInt(hex.slice(2,4), 16);
        const b = parseInt(hex.slice(4,6), 16);
        const mix = (c, t, p) => Math.round(c + (t - c) * p);
        const toHex = (v) => v.toString(16).padStart(2, "0");
        const dark = `#${toHex(mix(r, 0, 0.6))}${toHex(mix(g, 0, 0.6))}${toHex(mix(b, 0, 0.6))}`;
        const darker = `#${toHex(mix(r, 0, 0.8))}${toHex(mix(g, 0, 0.8))}${toHex(mix(b, 0, 0.8))}`;
        const light = `#${toHex(mix(r, 255, 0.35))}${toHex(mix(g, 255, 0.35))}${toHex(mix(b, 255, 0.35))}`;
        panel.style.setProperty("--accent", light);
        panel.style.setProperty("--accent-2", `#${hex}`);
        panel.style.setProperty("--line", dark);
        panel.style.setProperty("--panel", darker);
      }

      function loadSettings(){
        apiKeyEl.value = storage.getItem("bt_api_key") || "";
        overlayToggle.checked = storage.getItem("bt_overlay") === "1";
        if (overlayToggle.checked) document.body.classList.add("overlay");
        overlayToggleBtn.classList.toggle("active", overlayToggle.checked);
      }

      function saveSettings(){
        storage.setItem("bt_api_key", apiKeyEl.value.trim());
        storage.setItem("bt_overlay", overlayToggle.checked ? "1" : "0");
      }

      function apiFetch(path, opts, withKey = true){
        const base = getBase();
        const url = new URL(path, base).toString();
        const options = opts || {};
        options.headers = options.headers || {};
        if (withKey){
          const key = apiKeyEl.value.trim();
          if (key) options.headers["X-API-Key"] = key;
        }
        return fetch(url, options);
      }

      async function jsonFetch(path, opts, withKey = true){
        const res = await apiFetch(path, opts, withKey);
        if (res.status === 401){
          handleUnauthorized();
          throw new Error("Unauthorized");
        }
        const data = await res.json().catch(() => ({}));
        if (!res.ok){
          throw new Error(data.error || "Request failed");
        }
        return data;
      }

      function handleUnauthorized(){
        apiKeyEl.value = "";
        document.getElementById("appView").classList.add("hidden");
        document.getElementById("loginView").classList.remove("hidden");
        loginStatusEl.textContent = "Unauthorized. Please log in again.";
        loginStatusEl.className = "status err";
        overlayToggle.checked = false;
        document.body.classList.remove("overlay");
        saveSettings();
        const brandUser = $("brandUser");
        const brandUserName = $("brandUserName");
        const brandUserIcon = $("brandUserIcon");
        const brandUserFallback = $("brandUserFallback");
        if (brandUser){
          if (brandUserName){
            brandUserName.textContent = "";
          }
          if (brandUserIcon){
            brandUserIcon.src = "";
            brandUserIcon.classList.add("hidden");
          }
          if (brandUserFallback){
            brandUserFallback.classList.remove("hidden");
          }
          brandUser.classList.add("hidden");
        }
      }

      async function loadAuthUser(){
        const brandUser = $("brandUser");
        const brandUserName = $("brandUserName");
        const brandUserIcon = $("brandUserIcon");
        const brandUserFallback = $("brandUserFallback");
        if (!brandUser || !brandUserName || !brandUserIcon || !brandUserFallback){
          return;
        }
        try{
          const data = await jsonFetch("/api/auth/me", {method:"GET"}, true);
          const name = data.user_name || data.user_id || "";
          const icon = data.user_icon || "";
          const userId = data.user_id || "";
          const createdBy = $("bCreatedBy");
          if (createdBy){
            createdBy.value = userId ? String(userId) : "";
          }
          updateBingoCreatePayload();
          if (name){
            brandUserName.textContent = name;
            brandUser.classList.remove("hidden");
            if (icon){
              brandUserIcon.src = icon;
              brandUserIcon.classList.remove("hidden");
              brandUserFallback.classList.add("hidden");
            }else{
              brandUserIcon.src = "";
              brandUserIcon.classList.add("hidden");
              brandUserFallback.classList.remove("hidden");
            }
          }else{
            brandUserName.textContent = "";
            brandUser.classList.add("hidden");
          }
        }catch(err){
          brandUserName.textContent = "";
          brandUserIcon.src = "";
          brandUserIcon.classList.add("hidden");
          brandUserFallback.classList.remove("hidden");
          brandUser.classList.add("hidden");
          const createdBy = $("bCreatedBy");
          if (createdBy){
            createdBy.value = "";
          }
          updateBingoCreatePayload();
        }
      }

      function showList(el, data){
        if (data && Array.isArray(data.cards)){
          if (!data.cards.length){
            el.textContent = "No cards loaded.";
            return;
          }
          const deckLabel = (data.deck && (data.deck.name || data.deck.deck_id)) || "";
          const header = deckLabel ? `<div class="list-header">Deck: ${deckLabel}</div>` : "";
          const items = data.cards.map(c => {
            const name = c.name || c.card_id || "Untitled";
            const id = c.card_id ? ` (${c.card_id})` : "";
            const house = c.house ? `<div class="muted">${c.house}</div>` : "";
            return `<div class="list-card clickable" data-card-id="${c.card_id || ""}"><strong>${name}</strong><span class="muted">${id}</span>${house}</div>`;
          }).join("");
          el.innerHTML = header + items;
          if (el.id === "taDeckList"){
            window.taDeckData = data;
            taSyncCardSelection();
          }
          return;
        }
        el.textContent = JSON.stringify(data, null, 2);
      }

      function renderBingoState(data){
        const game = (data && data.game) || {};
        currentGame = game;
        applyTheme(game.theme_color || null);
        const gid = getGameId();
        if (gid !== activeGameId){
          activeGameId = gid;
          lastCalledCount = 0;
          lastCalloutNumber = null;
        }
        $("bTitleVal").textContent = game.title || "-";
        $("bHeaderVal").textContent = game.header_text || game.header || "BING";
        $("bStageVal").textContent = game.stage || "-";
        $("bPotVal").textContent = (game.pot != null ? `${formatGil(game.pot)} ${game.currency || ""}` : "-");
        const announceToggle = $("bAnnounceToggle");
        if (announceToggle){
          announceToggle.checked = !!game.announce_calls;
        }
        const called = Array.isArray(game.called) ? game.called : [];
        $("bCalled").textContent = called.length ? ("Called numbers: " + called.join(", ")) : "Called numbers: -";
        const buyBtn = $("bBuy");
        if (buyBtn){
          buyBtn.disabled = !(game.active !== false && !game.started && called.length === 0);
        }
        const startBtn = $("bStart");
        if (startBtn){
          startBtn.disabled = !(game.active !== false && !game.started);
        }
        renderCalledGrid(called);
        const bgPath = game.background ? new URL(game.background, getBase()).toString() : "";
        const cardWrap = $("bCard");
        cardWrap.style.backgroundImage = bgPath ? `linear-gradient(180deg, rgba(6,10,18,.85), rgba(6,10,18,.6)), url('${bgPath}')` : "";
        const last = game.last_called != null ? game.last_called : (called.length ? called[called.length - 1] : null);
        if (last != null && last !== lastCalloutNumber){
          showCallout(`Called ${last}`);
          lastCalloutNumber = last;
        }
        lastCalledCount = called.length;
        renderClaims(game);
      }

      function renderClaims(game){
        const el = $("bClaims");
        const claims = (game && Array.isArray(game.claims)) ? game.claims : [];
        if (!claims.length){
          el.textContent = "No claims yet.";
          return;
        }
        el.innerHTML = "";
        claims.slice().reverse().forEach(c => {
          const row = document.createElement("div");
          row.style.padding = "8px 6px";
          row.style.borderBottom = "1px solid rgba(255,255,255,0.06)";
          const status = c.pending ? "pending" : (c.denied ? "denied" : "approved");
          const label = `${c.owner_name || "Unknown"} - ${c.card_id || ""} - ${c.stage || ""} - ${status}`;
          const wrap = document.createElement("div");
          wrap.style.display = "flex";
          wrap.style.alignItems = "center";
          wrap.style.justifyContent = "space-between";
          wrap.style.gap = "10px";
          const text = document.createElement("div");
          text.textContent = label;
          wrap.appendChild(text);
          if (c.pending){
            const btnWrap = document.createElement("div");
            btnWrap.style.display = "flex";
            btnWrap.style.gap = "8px";
            const btn = document.createElement("button");
            btn.textContent = "Confirm + Advance";
            btn.style.maxWidth = "160px";
            btn.onclick = async () => {
              try{
                await jsonFetch("/bingo/claim-approve", {
                  method:"POST",
                  headers: {"Content-Type": "application/json"},
                  body: JSON.stringify({game_id: game.game_id, card_id: c.card_id})
                });
                const adv = await jsonFetch("/bingo/advance-stage", {
                  method:"POST",
                  headers: {"Content-Type": "application/json"},
                  body: JSON.stringify({game_id: game.game_id})
                });
                setStatus(adv.ended ? "Claim approved. Game ended." : "Claim approved. Stage advanced.", "ok");
                await refreshBingo();
              }catch(err){
                setStatus(err.message, "err");
              }
            };
            const deny = document.createElement("button");
            deny.textContent = "Deny";
            deny.className = "btn-ghost";
            deny.style.maxWidth = "90px";
            deny.onclick = async () => {
              try{
                await jsonFetch("/bingo/claim-deny", {
                  method:"POST",
                  headers: {"Content-Type": "application/json"},
                  body: JSON.stringify({game_id: game.game_id, card_id: c.card_id})
                });
                setStatus("Claim denied.", "ok");
                await refreshBingo();
              }catch(err){
                setStatus(err.message, "err");
              }
            };
            btnWrap.appendChild(btn);
            btnWrap.appendChild(deny);
            wrap.appendChild(btnWrap);
          }
          row.appendChild(wrap);
          el.appendChild(row);
        });
      }

      function formatGil(value){
        const raw = Number(value);
        if (!Number.isFinite(raw)) return String(value ?? "");
        return raw.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      }

      function renderCard(card, called, header){
        currentCard = card;
        const headerEl = $("bCardHeader");
        const gridEl = $("bCardGrid");
        headerEl.innerHTML = "";
        gridEl.innerHTML = "";
        const letters = (header || "BING").slice(0,4).split("");
        while (letters.length < 4) letters.push(" ");
        letters.forEach(l => {
          const h = document.createElement("div");
          h.textContent = l;
          headerEl.appendChild(h);
        });
        if (!card || !Array.isArray(card.numbers)){
          gridEl.innerHTML = "<div style='grid-column:1/-1;color:var(--muted)'>No card loaded.</div>";
          return;
        }
        const calledSet = new Set(Array.isArray(called) ? called : []);
        const nums = card.numbers || [];
        const marks = card.marks || [];
        for (let r = 0; r < nums.length; r++){
          for (let c = 0; c < nums[r].length; c++){
            const cell = document.createElement("div");
            cell.className = "bingo-cell";
            const value = nums[r][c];
            const marked = (marks[r] && marks[r][c]) || calledSet.has(value);
            if (marked) cell.classList.add("marked");
            cell.textContent = value;
            gridEl.appendChild(cell);
          }
        }
      }

      function renderCalledGrid(called){
        const grid = $("bCalledGrid");
        grid.innerHTML = "";
        const calledSet = new Set(Array.isArray(called) ? called : []);
        for (let i = 1; i <= 40; i++){
          const btn = document.createElement("button");
          btn.className = "bingo-call-btn" + (calledSet.has(i) ? " active" : "");
          btn.textContent = i;
          btn.disabled = !calledSet.has(i);
          btn.onclick = () => markNumber(i);
          grid.appendChild(btn);
        }
      }

      function showCallout(text){
        let el = document.getElementById("bCallout");
        if (!el){
          el = document.createElement("div");
          el.id = "bCallout";
          el.className = "bingo-callout";
          document.body.appendChild(el);
        }
        el.textContent = text;
        el.classList.add("show");
        setTimeout(() => el.classList.remove("show"), 2200);
      }

      async function markNumber(num){
        const gid = getGameId();
        if (!gid || !currentCard || !Array.isArray(currentCard.numbers)){
          setStatus("Load a card first.", "err");
          return;
        }
        const marks = [];
        for (let r = 0; r < currentCard.numbers.length; r++){
          for (let c = 0; c < currentCard.numbers[r].length; c++){
            if (currentCard.numbers[r][c] === num){
              marks.push({row: r, col: c});
            }
          }
        }
        if (marks.length === 0){
          setStatus("Number not on this card.", "err");
          return;
        }
        try{
          for (const m of marks){
            await jsonFetch("/bingo/mark", {
              method:"POST",
              headers: {"Content-Type": "application/json"},
              body: JSON.stringify({game_id: gid, card_id: currentCard.card_id, row: m.row, col: m.col})
            });
            if (currentCard.marks && currentCard.marks[m.row]){
              currentCard.marks[m.row][m.col] = true;
            }
          }
          renderCard(currentCard, currentGame && currentGame.called, currentGame && currentGame.header);
          setStatus("Marked card.", "ok");
        }catch(err){
          setStatus(err.message, "err");
        }
      }

      function renderGamesList(games){
        const el = $("bGames");
        if (!el){
          return;
        }
        if (!Array.isArray(games) || games.length === 0){
          el.textContent = "No active games. Create one in Discord.";
          return;
        }
        el.innerHTML = "";
        games.forEach(g => {
          const item = document.createElement("div");
          item.style.padding = "8px 6px";
          item.style.borderBottom = "1px solid rgba(255,255,255,0.06)";
          const title = g.title || "Bingo";
          const created = g.created_at ? new Date(g.created_at * 1000).toLocaleString() : "Unknown date";
          const status = g.active ? "active" : "ended";
          const deleteBtn = !g.active ? `<button data-delete="${g.game_id}" class="btn-ghost" style="max-width:90px">Delete</button>` : "";
          item.innerHTML = `\n            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">\n              <div><strong>${title}</strong> - ${created} <span class="muted">(${status})</span></div>\n              ${deleteBtn}\n            </div>`;
          item.style.cursor = "pointer";
          item.onclick = () => {
            setGameId(g.game_id || "");
            refreshBingo();
            loadOwnersForGame();
          };
          const del = item.querySelector("button[data-delete]");
          if (del){
            del.addEventListener("click", async (ev) => {
              ev.stopPropagation();
              if (!confirm("Delete this game? This cannot be undone.")){
                return;
              }
              try{
                await jsonFetch("/bingo/" + encodeURIComponent(g.game_id), {method:"DELETE"});
                setStatus("Game deleted.", "ok");
                await loadGamesMenu();
              }catch(err){
                setStatus(err.message, "err");
              }
            });
          }
          el.appendChild(item);
        });
      }

      function loadGamesMenu(){
        jsonFetch("/bingo/games", {method:"GET"})
          .then(data => {
            const list = (data.games || []).filter(g => g.active !== false);
            renderGamesList(data.games || []);
            const menu = $("menuGames");
            menu.innerHTML = "";
            list.forEach(g => {
              const row = document.createElement("div");
              row.className = "menu-game";
              const created = g.created_at ? new Date(g.created_at * 1000).toLocaleString() : "Unknown date";
              row.textContent = g.title ? `${g.title} - ${created}` : created;
              row.onclick = () => {
                setGameId(g.game_id || "");
                showPanel("bingo");
                refreshBingo();
                loadOwnersForGame();
              // Selected game is indicated by menu highlight.
              };
              menu.appendChild(row);
              if (g.game_id && g.game_id === getGameId()){
                row.classList.add("active");
              }
            });
            if (!list.length){
              menu.textContent = "No active games.";
            }
            // Selected game is indicated by menu highlight.
          })
          .catch(() => {});
      }

      async function loadDiscordChannels(){
        const select = $("bChannelSelect");
        if (!select){
          return;
        }
        select.innerHTML = `<option value="">Loading...</option>`;
        try{
          const data = await jsonFetch("/discord/channels", {method:"GET"}, true);
          const channels = data.channels || [];
          select.innerHTML = "";
          if (!channels.length){
            select.innerHTML = `<option value="">No channels available</option>`;
            return;
          }
          let botlogsId = "";
          channels.forEach(ch => {
            const opt = document.createElement("option");
            opt.value = String(ch.id || "");
            const guild = ch.guild_name || ch.guild_id || "Guild";
            const category = ch.category ? ` / ${ch.category}` : "";
            const name = ch.name ? `#${ch.name}` : String(ch.id || "");
            opt.textContent = `${guild}${category} - ${name}`;
            select.appendChild(opt);
            if (!botlogsId && String(ch.name || "").toLowerCase() === "bot-logs"){
              botlogsId = opt.value;
            }
          });
          const current = $("bChannel").value.trim();
          if (current){
            select.value = current;
          }
          if (!select.value && select.options.length){
            select.value = botlogsId || select.options[0].value;
          }
          if (select.value){
            $("bChannel").value = select.value;
          }
          updateBingoCreatePayload();
        }catch(err){
          select.innerHTML = `<option value="">Failed to load</option>`;
          setStatus(err.message, "err");
        }
      }

      function showPanel(which){
        $("menuBingo").classList.toggle("active", which === "bingo");
        $("menuTarotLinks").classList.toggle("active", which === "tarotLinks");
        $("menuTarotDecks").classList.toggle("active", which === "tarotDecks");
        $("menuContests").classList.toggle("active", which === "contests");
        $("bingoPanel").classList.toggle("hidden", which !== "bingo");
        $("tarotLinksPanel").classList.toggle("hidden", which !== "tarotLinks");
        $("tarotDecksPanel").classList.toggle("hidden", which !== "tarotDecks");
        $("contestPanel").classList.toggle("hidden", which !== "contests");
      }

      $("menuBingo").addEventListener("click", () => showPanel("bingo"));
      $("menuBingoRefresh").addEventListener("click", (ev) => {
        ev.stopPropagation();
        loadGamesMenu();
      });
      $("bChannelRefresh").addEventListener("click", () => loadDiscordChannels());
      $("bChannelSelect").addEventListener("change", (ev) => {
        const pick = ev.target.value || "";
        if (pick){
          $("bChannel").value = pick;
        }
        updateBingoCreatePayload();
      });
      $("menuCreateGame").addEventListener("click", () => {
        $("bCreateModal").classList.add("show");
        $("bTitle").focus();
        $("bChannel").value = "";
        $("bChannelSelect").value = "";
        $("bAnnounceCalls").checked = false;
        loadDiscordChannels();
        updateBingoCreatePayload();
      });
      $("menuTarotLinks").addEventListener("click", () => showPanel("tarotLinks"));
      $("menuTarotDecks").addEventListener("click", () => showPanel("tarotDecks"));
      $("menuContests").addEventListener("click", () => {
        showPanel("contests");
        loadContestManagement();
      });
      $("bAnnounceToggle").addEventListener("change", async (ev) => {
        const gid = getGameId();
        if (!gid){
          setStatus("Select a game first.", "err");
          ev.target.checked = false;
          return;
        }
        try{
          await jsonFetch("/bingo/" + encodeURIComponent(gid), {
            method:"PATCH",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({announce_calls: ev.target.checked})
          });
          setStatus("Updated announce setting.", "ok");
        }catch(err){
          setStatus(err.message, "err");
        }
      });
      $("menuMedia").addEventListener("click", () => {
        librarySelectHandler = null;
        showLibraryModal(true);
        loadLibrary("media");
        loadTarotArtists();
      });
      $("menuArtists").addEventListener("click", () => {
        $("artistModal").classList.add("show");
        loadTarotArtists();
      });
      $("contestRefresh").addEventListener("click", () => loadContestManagement());

      let bingoRefreshTimer = null;
      function ensureBingoPolling(){
        if (bingoRefreshTimer){
          return;
        }
        bingoRefreshTimer = setInterval(() => {
          const gid = getGameId();
          if (!gid){
            return;
          }
          if ($("bingoPanel").classList.contains("hidden")){
            return;
          }
          refreshBingo();
        }, 3000);
      }

      function contestStatus(meta){
        if (!meta){
          return "unknown";
        }
        const raw = (meta.status || meta.state || meta.phase || "").toString().toLowerCase();
        if (["ended","closed","finished","complete","archived"].includes(raw)){
          return "ended";
        }
        if (["active","open","running","live","ongoing"].includes(raw)){
          return "active";
        }
        if (meta.ended === true || meta.closed === true || meta.finished === true){
          return "ended";
        }
        if (meta.active === false || meta.is_active === false || meta.open === false){
          return "ended";
        }
        return "active";
      }

      async function loadContestManagement(){
        const allEl = $("contestAllList");
        const endedEl = $("contestEndedList");
        allEl.textContent = "Loading contests...";
        endedEl.textContent = "Loading contests...";
        try{
          const list = await jsonFetch("/contests", {method:"GET"}, true);
          const channels = list.channels || [];
          if (!channels.length){
            allEl.textContent = "No contests yet.";
            endedEl.textContent = "No ended contests yet.";
            return;
          }
          const details = await Promise.all(channels.map(async (id) => {
            try{
              return await jsonFetch("/contests/" + encodeURIComponent(id), {method:"GET"}, true);
            }catch(err){
              return {channel_id: id, error: err.message, exists: false};
            }
          }));
          const allCards = [];
          const endedCards = [];
          details.forEach(info => {
            const channelId = info.channel_id || info.channel || "";
            const meta = info.meta || null;
            const counts = info.counts || {};
            const status = contestStatus(meta);
            const name = meta ? (meta.name || meta.title || "") : "";
            const label = name ? `${name} (ID ${channelId})` : `Channel ${channelId}`;
            const entries = counts.entries !== undefined ? `${counts.entries} entries` : "entries unknown";
            const statusLabel = status === "ended" ? "Ended" : status === "active" ? "Active" : "Unknown";
            const error = info.exists === false ? (info.error || "contest db missing") : info.error;
            const errorLine = error ? `<div class="list-warn">${error}</div>` : "";
            const card = `<div class="list-card"><strong>${label}</strong><div class="muted">${statusLabel}  ${entries}</div>${errorLine}</div>`;
            allCards.push(card);
            if (status === "ended"){
              endedCards.push(card);
            }
          });
          allEl.innerHTML = allCards.length ? allCards.join("") : "No contests yet.";
          endedEl.innerHTML = endedCards.length ? endedCards.join("") : "No ended contests yet.";
        }catch(err){
          allEl.textContent = "Failed to load contests.";
          endedEl.textContent = "Failed to load contests.";
          setStatus(err.message, "err");
        }
      }

      function updateBingoCreatePayload(){
        const el = $("bCreatePayload");
        if (!el){
          return;
        }
        const channelId = $("bChannelSelect").value || $("bChannel").value || "?";
        const createdBy = $("bCreatedBy").value || "?";
        const channelLabel = $("bChannelSelect").selectedOptions.length
          ? $("bChannelSelect").selectedOptions[0].textContent
          : "";
        const label = channelLabel ? ` (${channelLabel})` : "";
        el.textContent = `Payload preview: channel_id=${channelId}${label}, created_by=${createdBy}`;
      }

      function renderOwnersList(owners){
        const el = $("bOwners");
        if (!Array.isArray(owners) || owners.length === 0){
          el.textContent = "No players found.";
          return;
        }
        el.innerHTML = "";
        owners.forEach(o => {
          const item = document.createElement("div");
          item.className = "owner-row";
          item.style.cursor = "pointer";
          const token = o.token || "";
          const link = token ? `${getBase()}/bingo/owner?token=${encodeURIComponent(token)}` : "";
          const linkHtml = link ? `<a href="${link}" class="owner-link" target="_blank" rel="noreferrer">Open</a>` : "";
          const copyBtn = link ? `<button data-copy="${link}" class="owner-copy-icon" title="Copy link" aria-label="Copy link"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M16 1H6a2 2 0 0 0-2 2v12h2V3h10V1zm3 4H10a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h9a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2zm0 16H10V7h9v14z"/></svg></button>` : "";
          item.innerHTML = `\n            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">\n              <div><strong>${o.owner_name}</strong></div>\n              <div class="owner-meta">\n                <span class="owner-cards">${o.cards} cards</span>\n                ${linkHtml}\n                ${copyBtn}\n              </div>\n            </div>`;
          item.onclick = () => {
            $("bOwner").value = o.owner_name || "";
            loadOwnerCards(o.owner_name || "");
            $("bOwnerModal").classList.add("show");
          };
          const linkEl = item.querySelector("a");
          if (linkEl){
            linkEl.addEventListener("click", (ev) => ev.stopPropagation());
          }
          const copy = item.querySelector("button[data-copy]");
          if (copy){
            copy.addEventListener("click", (ev) => {
              ev.stopPropagation();
              try{
                navigator.clipboard.writeText(copy.getAttribute("data-copy") || "");
                setStatus("Link copied.", "ok");
              }catch(err){
                setStatus("Copy failed.", "err");
              }
            });
          }
          el.appendChild(item);
        });
      }

      async function loadOwnersForGame(){
        const gid = getGameId();
        $("bOwnerCards").textContent = "No tickets loaded.";
        if (!gid){
          $("bOwners").textContent = "No players loaded.";
          return;
        }
        try{
          const data = await jsonFetch("/bingo/" + encodeURIComponent(gid) + "/owners", {method:"GET"});
          renderOwnersList(data.owners || []);
        }catch(err){
          setStatus(err.message, "err");
        }
      }

      function renderOwnerCards(owner, cards, called, header){
        const el = $("bOwnerCards");
        if (!Array.isArray(cards) || cards.length === 0){
          el.textContent = "No tickets for this player.";
          return;
        }
        el.innerHTML = "";
        cards.forEach(card => {
          const wrap = document.createElement("div");
          wrap.style.margin = "10px 0";
          wrap.style.padding = "8px";
          wrap.style.border = "1px solid rgba(255,255,255,0.08)";
          wrap.style.borderRadius = "10px";
          const title = document.createElement("div");
          title.style.fontSize = "12px";
          title.style.color = "var(--muted)";
          title.innerHTML = `Card <code>${card.card_id}</code>`;
          wrap.appendChild(title);
          const grid = document.createElement("div");
          grid.className = "bingo-grid";
          const calledSet = new Set(Array.isArray(called) ? called : []);
          (card.numbers || []).forEach((row, r) => {
            (row || []).forEach((value, c) => {
              const cell = document.createElement("div");
              cell.className = "bingo-cell";
              const marked = (card.marks && card.marks[r] && card.marks[r][c]) || calledSet.has(value);
              if (marked) cell.classList.add("marked");
              cell.textContent = value;
              cell.onclick = () => {
                renderCard(card, called, header);
              };
              grid.appendChild(cell);
            });
          });
          wrap.appendChild(grid);
          el.appendChild(wrap);
        });
      }

      async function loadOwnerCards(ownerName){
        const gid = getGameId();
        if (!gid || !ownerName){
          setStatus("Enter game id and owner name.", "err");
          return;
        }
        try{
          const state = await jsonFetch("/bingo/" + encodeURIComponent(gid), {method:"GET"}, false);
          const data = await jsonFetch("/bingo/" + encodeURIComponent(gid) + "/owner/" + encodeURIComponent(ownerName) + "/cards", {method:"GET"}, false);
          renderBingoState(state);
          renderOwnerCards(ownerName, data.cards || [], state.game && state.game.called, state.game && state.game.header);
          setStatus("Tickets loaded.", "ok");
        }catch(err){
          setStatus(err.message, "err");
        }
      }

      // owner list loads automatically when selecting a game

      $("bCloseCreate").addEventListener("click", () => {
        $("bCreateModal").classList.remove("show");
      });
      $("deckCreateClose").addEventListener("click", () => {
        $("deckCreateModal").classList.remove("show");
      });
      $("mediaClose").addEventListener("click", () => {
        $("mediaModal").classList.remove("show");
      });
      $("artistClose").addEventListener("click", () => {
        $("artistModal").classList.remove("show");
      });
      $("bOwnerClose").addEventListener("click", () => {
        $("bOwnerModal").classList.remove("show");
      });
      $("bPurchaseClose").addEventListener("click", () => {
        $("bPurchaseModal").classList.remove("show");
      });
      $("bPurchaseCopy").addEventListener("click", () => {
        const link = $("bPurchaseLink").value || "";
        if (!link){
          return;
        }
        try{
          navigator.clipboard.writeText(link);
          $("bPurchaseStatus").textContent = "Link copied.";
        }catch(err){
          $("bPurchaseStatus").textContent = "Copy failed.";
        }
      });

      $("loginBtn").addEventListener("click", () => {
        if (!apiKeyEl.value.trim()){
          loginStatusEl.textContent = "Enter your API key.";
          loginStatusEl.className = "status err";
          return;
        }
        saveSettings();
        document.getElementById("loginView").classList.add("hidden");
        document.getElementById("appView").classList.remove("hidden");
        setStatus("Welcome to Bingo Control.", "ok");
        loadAuthUser();
        loadGamesMenu();
        loadTarotDeckList();
        loadTarotSessionDecks();
        loadTarotSessions();
        loadTarotHouses();
        showPanel("bingo");
        ensureBingoPolling();
      });
      overlayToggle.addEventListener("change", () => {
        document.body.classList.toggle("overlay", overlayToggle.checked);
        overlayToggleBtn.classList.toggle("active", overlayToggle.checked);
        saveSettings();
      });
      overlayToggleBtn.addEventListener("click", () => {
        overlayToggle.checked = !overlayToggle.checked;
        overlayToggle.dispatchEvent(new Event("change"));
      });
      $("overlayExit").addEventListener("click", () => {
        overlayToggle.checked = false;
        document.body.classList.remove("overlay");
        saveSettings();
      });
      $("uploadLibraryClose").addEventListener("click", () => showLibraryModal(false));
      $("uploadLibraryRefresh").addEventListener("click", () => loadLibrary(libraryKind));

      $("deckCreateBackPick").addEventListener("click", () => {
        librarySelectHandler = (item) => {
          $("deckCreateBackPick").dataset.backUrl = item.url || "";
          $("deckCreateBackPick").dataset.artistId = item.artist_id || "";
          setStatus(item.url ? "Deck back selected." : "Pick a deck back.", "ok");
        };
        showLibraryModal(true);
        loadLibrary("media");
      });

      $("deckCreateSubmit").addEventListener("click", async () => {
        const id = $("deckCreateId").value.trim();
        if (!id){
          setStatus("Deck id is required.", "err");
          return;
        }
        const backUrl = $("deckCreateBackPick").dataset.backUrl || "";
        if (!backUrl){
          setStatus("Pick a deck back before creating the deck.", "err");
          return;
        }
        const name = $("deckCreateName").value.trim();
        const seed = $("deckCreateSeed").value === "yes";
        const perHouse = Number($("deckCreatePerHouse").value || 0);
        const crownCount = Number($("deckCreateCrown").value || 0);
        const artistId = $("deckCreateBackPick").dataset.artistId || "";
        try{
          await jsonFetch("/api/tarot/decks", {
            method:"POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({deck_id: id, name: name || undefined})
          }, true);
          await jsonFetch("/api/tarot/decks/" + encodeURIComponent(id) + "/back", {
            method:"PUT",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({back_image: backUrl, artist_id: artistId || undefined})
          }, true);
          if (seed){
            await jsonFetch("/api/tarot/decks/" + encodeURIComponent(id) + "/seed", {
              method: "POST",
              headers: {"Content-Type": "application/json"},
              body: JSON.stringify({per_house: perHouse, crown_count: crownCount})
            }, true);
          }
          await loadTarotDeckList(id);
          $("deckCreateModal").classList.remove("show");
          setStatus("Deck created.", "ok");
          await $("taLoadDeck").click();
        }catch(err){
          setStatus(err.message, "err");
        }
      });

      $("taCardLibrary").addEventListener("click", () => {
        librarySelectHandler = (item) => {
          window.taUploadedImageUrl = item.url || "";
          $("taCardArtist").value = item.artist_id || "";
          if (window.taDeckData && window.taDeckData.cards){
            const card = window.taDeckData.cards.find(c => c.card_id === taSelectedCardId);
            if (card){
              card.image = window.taUploadedImageUrl;
              taRenderPreviews(card);
            }
          }
          setStatus("Card image selected from library.", "ok");
        };
        showLibraryModal(true);
        loadLibrary("tarot-card");
      });

      $("bCreateBgLibrary").addEventListener("click", () => {
        librarySelectHandler = async (item) => {
          const gid = getGameId();
          if (!gid){
            setStatus("Create or select a game first.", "err");
            return;
          }
          try{
            await jsonFetch("/bingo/" + encodeURIComponent(gid) + "/background-from-media", {
              method:"POST",
              headers: {"Content-Type": "application/json"},
              body: JSON.stringify({url: item.url})
            }, true);
            setStatus("Background applied from library.", "ok");
            await refreshBingo();
          }catch(err){
            setStatus(err.message, "err");
          }
        };
        showLibraryModal(true);
        loadLibrary("bingo-bg");
      });

      $("bCreate").addEventListener("click", async () => {
        try{
          updateBingoCreatePayload();
          const body = {
            title: $("bTitle").value,
            header_text: $("bHeader").value,
            price: Number($("bPrice").value || 0),
            currency: $("bCurrency").value || "gil",
            max_cards_per_player: Number($("bMaxCards").value || 10),
            channel_id: $("bChannelSelect").value || $("bChannel").value || "",
            created_by: $("bCreatedBy").value || "",
            announce_calls: $("bAnnounceCalls").checked,
            theme_color: $("bTheme").value || ""
          };
          const data = await jsonFetch("/bingo/create", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(body)
          });
          setGameId(data.game.game_id || "");
          $("bCreateModal").classList.remove("show");
          setStatus("Bingo game created.", "ok");
          renderBingoState({game: data.game});
          loadGamesMenu();
          loadOwnersForGame();
        }catch(err){
          setStatus(err.message, "err");
        }
      });

      async function refreshBingo(){
        const gid = getGameId();
        if (!gid){
          setStatus("Enter a game id.", "err");
          return;
        }
        try{
          const data = await jsonFetch("/bingo/" + encodeURIComponent(gid), {method:"GET"}, false);
          renderBingoState(data);
          setStatus("Bingo state updated.", "ok");
        }catch(err){
          setStatus(err.message, "err");
        }
      }

      $("bRefresh").addEventListener("click", refreshBingo);

      $("bAdvanceStage").addEventListener("click", async () => {
        try{
          const data = await jsonFetch("/bingo/advance-stage", {
            method:"POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({game_id: getGameId()})
          });
          setStatus(data.ended ? "Game ended." : "Stage advanced.", "ok");
          await refreshBingo();
        }catch(err){
          setStatus(err.message, "err");
        }
      });

      $("bStart").addEventListener("click", async () => {
        try{
          const gid = getGameId();
          if (!gid){
            setStatus("Select a game first.", "err");
            return;
          }
          await jsonFetch("/bingo/start", {
            method:"POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({game_id: gid})
          });
          setStatus("Game started. Buying disabled.", "ok");
          if (currentGame && currentGame.game_id === gid){
            currentGame.started = true;
            renderBingoState({game: currentGame});
          }
          await refreshBingo();
        }catch(err){
          setStatus(err.message, "err");
        }
      });


      $("bRoll").addEventListener("click", async () => {
        try{
          await jsonFetch("/bingo/roll", {
            method:"POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({game_id: getGameId()})
          });
          setStatus("Pulled random number.", "ok");
          await refreshBingo();
        }catch(err){
          setStatus(err.message, "err");
        }
      });

      $("bCloseGame").addEventListener("click", async () => {
        const gid = getGameId();
        if (!gid){
          setStatus("Select a game first.", "err");
          return;
        }
        if (!confirm("Close and delete this game? This cannot be undone.")){
          return;
        }
        try{
          await jsonFetch("/bingo/" + encodeURIComponent(gid), {method:"DELETE"});
          setGameId("");
          currentGame = null;
          $("bOwners").textContent = "No players loaded.";
          $("bClaims").textContent = "No claims yet.";
          $("bTitleVal").textContent = "-";
          $("bHeaderVal").textContent = "-";
          $("bStageVal").textContent = "-";
          $("bPotVal").textContent = "-";
          $("bCalled").textContent = "Called numbers: -";
          $("bCalledGrid").innerHTML = "";
          $("bCardHeader").innerHTML = "";
          $("bCardGrid").innerHTML = "";
          setStatus("Game deleted.", "ok");
          await loadGamesMenu();
        }catch(err){
          setStatus(err.message, "err");
        }
      });


      $("bBuy").addEventListener("click", async () => {
        try{
          const gid = getGameId();
          const ownerName = $("bOwner").value.trim();
          const body = {
            game_id: gid,
            owner_name: ownerName,
            owner_user_id: $("bOwnerId").value.trim() || null,
            quantity: Number($("bQty").value || 1)
          };
          await jsonFetch("/bingo/buy", {
            method:"POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(body)
          });
          setStatus("Cards bought.", "ok");
          await loadOwnersForGame();
          if (gid && ownerName){
            const data = await jsonFetch("/bingo/" + encodeURIComponent(gid) + "/owner/" + encodeURIComponent(ownerName) + "/token", {method:"GET"});
            const base = getBase();
            const url = new URL("/bingo/owner?token=" + encodeURIComponent(data.token || ""), base).toString();
            $("bPurchaseLink").value = url;
            $("bPurchaseStatus").textContent = "Share this link with the player.";
            $("bPurchaseModal").classList.add("show");
          }
        }catch(err){
          setStatus(err.message, "err");
        }
      });

      $("bViewOwner").addEventListener("click", () => {
        const gid = getGameId();
        const owner = $("bOwner").value.trim();
        if (!gid || !owner){
          setStatus("Enter game id and owner name.", "err");
          return;
        }
        currentOwner = owner;
        jsonFetch("/bingo/" + encodeURIComponent(gid) + "/owner/" + encodeURIComponent(owner) + "/token", {method:"GET"})
          .then(data => {
            const base = getBase();
            const url = new URL("/bingo/owner?token=" + encodeURIComponent(data.token || ""), base).toString();
            window.open(url, "_blank");
          })
          .catch(err => setStatus(err.message, "err"));
      });

      function getOverlayUrl(code){
        const base = getBase();
        return new URL("/overlay/session/" + encodeURIComponent(code), base).toString();
      }

      function getPlayerUrl(code){
        const base = getBase();
        return new URL("/tarot/session/" + encodeURIComponent(code) + "?view=player", base).toString();
      }

      function getPriestessUrl(code, token){
        const base = getBase();
        const url = new URL("/tarot/session/" + encodeURIComponent(code), base);
        url.searchParams.set("view", "priestess");
        if (token) url.searchParams.set("token", token);
        return url.toString();
      }

      function renderLinks(code, token){
        const links = [];
        if (code){
          links.push(`<a href="${getPlayerUrl(code)}" target="_blank" rel="noreferrer">Player</a>`);
          links.push(`<a href="${getPriestessUrl(code, token)}" target="_blank" rel="noreferrer">Priestess</a>`);
          links.push(`<a href="${getOverlayUrl(code)}" target="_blank" rel="noreferrer">Overlay</a>`);
        }
        $("tLink").innerHTML = links.length ? links.join(" | ") : "No join code entered.";
      }

      async function loadTarotSessionDecks(selectValue){
        try{
          const data = await jsonFetch("/api/tarot/decks", {method:"GET"}, true);
          const decks = data.decks || [];
          const modalSelect = $("sessionCreateDeck");
          modalSelect.innerHTML = "";
          decks.forEach(d => {
            const opt2 = document.createElement("option");
            opt2.value = d.deck_id;
            opt2.textContent = d.name ? `${d.name} (${d.deck_id})` : d.deck_id;
            modalSelect.appendChild(opt2);
          });
          modalSelect.value = selectValue || (decks[0] ? decks[0].deck_id : "elf-classic");
        }catch(err){
          setStatus(err.message, "err");
        }
      }

      $("tCreateSession").addEventListener("click", () => {
        $("sessionCreateModal").classList.add("show");
      });
      $("sessionCreateClose").addEventListener("click", () => {
        $("sessionCreateModal").classList.remove("show");
      });
      $("sessionCreateSubmit").addEventListener("click", async () => {
        try{
          const deck = $("sessionCreateDeck").value.trim() || "elf-classic";
          const spread = $("sessionCreateSpread").value.trim() || "single";
          const data = await jsonFetch("/api/tarot/sessions", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({deck_id: deck, spread_id: spread})
          }, true);
          $("tJoinCode").value = data.joinCode || "";
          $("tPriestessToken").value = data.priestessToken || "";
          renderLinks(data.joinCode || "", data.priestessToken || "");
          setStatus("Session created.", "ok");
          await loadTarotSessions(data.joinCode || "");
          $("sessionCreateModal").classList.remove("show");
          if (data.joinCode){
            window.open(getPriestessUrl(data.joinCode, data.priestessToken || ""), "_blank");
          }
        }catch(err){
          setStatus(err.message, "err");
        }
      });

      async function loadTarotSessions(selectJoin){
        try{
          const data = await jsonFetch("/api/tarot/sessions", {method:"GET"}, true);
          const select = $("tSessionSelect");
          select.innerHTML = "";
          const sessions = data.sessions || [];
          sessions.forEach(s => {
            const opt = document.createElement("option");
            opt.value = s.join_code || "";
            const created = s.created_at ? new Date(s.created_at * 1000).toLocaleString() : "unknown";
            opt.textContent = `${s.join_code || "-"} | ${s.deck_id || "-"} | ${s.spread_id || "-"} | ${s.status || "-"} | ${created}`;
            opt.dataset.token = s.priestess_token || "";
            select.appendChild(opt);
          });
          if (selectJoin){
            select.value = selectJoin;
          }
        }catch(err){
          setStatus(err.message, "err");
        }
      }

      $("tSessionRefresh").addEventListener("click", () => loadTarotSessions());
      $("tSessionSelect").addEventListener("change", (ev) => {
        const join = ev.target.value || "";
        const token = ev.target.selectedOptions.length ? (ev.target.selectedOptions[0].dataset.token || "") : "";
        $("tJoinCode").value = join;
        $("tPriestessToken").value = token;
        renderLinks(join, token);
      });

      $("tOpenOverlay").addEventListener("click", () => {
        const code = $("tJoinCode").value.trim();
        if (!code){
          setStatus("Enter a join code.", "err");
          return;
        }
        const url = getOverlayUrl(code);
        renderLinks(code, $("tPriestessToken").value.trim());
        window.open(url, "_blank");
      });

      $("tOpenPlayer").addEventListener("click", () => {
        const code = $("tJoinCode").value.trim();
        if (!code){
          setStatus("Enter a join code.", "err");
          return;
        }
        const url = getPlayerUrl(code);
        renderLinks(code, $("tPriestessToken").value.trim());
        window.open(url, "_blank");
      });

      $("tOpenPriestess").addEventListener("click", () => {
        const code = $("tJoinCode").value.trim();
        if (!code){
          setStatus("Enter a join code.", "err");
          return;
        }
        const token = $("tPriestessToken").value.trim();
        const url = getPriestessUrl(code, token);
        renderLinks(code, token);
        window.open(url, "_blank");
      });

      let taHouses = [];

      function taRenderHouseInfo(id){
        const box = $("taHouseInfo");
        const house = taHouses.find(h => h.id === id);
        if (!house){
          box.textContent = "Pick a house to see details.";
          return;
        }
        const themes = Object.entries(house.themes || {}).map(([k,v]) => `${k} (${v})`).join(", ");
        const keywords = (house.keywords || []).join(", ");
        const upright = `Upright: ${keywords}.`;
        const reversed = `Reversed: blocked or twisted ${keywords}.`;
        box.innerHTML = `<strong>${house.name}</strong><br><span class="muted">${themes}</span><br><span class="muted">${keywords}</span><br>${upright}<br>${reversed}`;
      }

      function taRenderPreviews(card){
        const front = $("taFrontPreview");
        const back = $("taBackPreview");
        const backUrl = window.taDeckData && window.taDeckData.deck ? window.taDeckData.deck.back_image : "";
        front.innerHTML = '<span class="preview-label">Front</span>';
        back.innerHTML = '<span class="preview-label">Back</span>';
        if (card && card.image){
          const img = document.createElement("img");
          img.src = card.image;
          front.appendChild(img);
        } else if (card && card.name){
          const label = document.createElement("div");
          label.className = "muted";
          label.textContent = card.name;
          front.appendChild(label);
        }
        if (backUrl){
          const img = document.createElement("img");
          img.src = backUrl;
          back.appendChild(img);
        }
      }

      function taLoadCard(card){
        if (!card) return;
        taSelectedCardId = card.card_id || "";
        $("taCardId").value = card.card_id || "";
        $("taCardName").value = card.name || "";
        $("taCardHouse").value = card.house || "";
        $("taCardTags").value = (card.tags || []).join(", ");
        $("taCardUpright").value = card.upright || "";
        $("taCardReversed").value = card.reversed || "";
        $("taCardArtist").value = card.artist_id || "";
        window.taUploadedImageUrl = card.image || "";
        taRenderHouseInfo(card.house || "");
        taRenderPreviews(card);
        taSyncCardSelection();
      }

      function taSyncCardSelection(){
        const list = $("taDeckList");
        if (!list) return;
        list.querySelectorAll(".list-card").forEach(el => {
          const active = taSelectedCardId && el.dataset.cardId === taSelectedCardId;
          el.classList.toggle("active", active);
        });
        if (window.taDeckData && window.taDeckData.cards && taSelectedCardId){
          const match = window.taDeckData.cards.find(c => c.card_id === taSelectedCardId);
          if (match){
            taRenderPreviews(match);
          }
        }
      }

      async function loadTarotHouses(){
        try{
          const data = await jsonFetch("/api/tarot/houses", {method:"GET"}, true);
          taHouses = data.houses || [];
          const select = $("taCardHouse");
          select.innerHTML = "";
          const none = document.createElement("option");
          none.value = "";
          none.textContent = "(none)";
          select.appendChild(none);
          taHouses.forEach(h => {
            const opt = document.createElement("option");
            opt.value = h.id;
            opt.textContent = h.name;
            select.appendChild(opt);
          });
        }catch(err){
          setStatus("Failed to load houses.", "err");
        }
      }

      async function loadTarotArtists(){
        try{
          const data = await jsonFetch("/api/tarot/artists", {method:"GET"}, true);
          const artists = data.artists || [];
          window.taArtists = artists;
          const selects = ["uploadLibraryArtist", "artistIndexSelect"];
          selects.forEach(id => {
            const sel = $(id);
            if (!sel) return;
            sel.innerHTML = "";
            const none = document.createElement("option");
            none.value = "";
            none.textContent = "(none)";
            sel.appendChild(none);
            artists.forEach(a => {
              const opt = document.createElement("option");
              opt.value = a.artist_id || "";
              opt.textContent = a.name ? `${a.name} (${a.artist_id})` : (a.artist_id || "");
              sel.appendChild(opt);
            });
          });
        }catch(err){
          window.taArtists = [];
          setStatus("Failed to load artists.", "err");
        }
      }

      $("artistIndexRefresh").addEventListener("click", () => loadTarotArtists());
      $("artistIndexSelect").addEventListener("change", (ev) => {
        const pick = (window.taArtists || []).find(a => a.artist_id === ev.target.value);
        if (!pick){
          $("artistIndexId").value = "";
          $("artistIndexName").value = "";
          $("artistIndexInstagram").value = "";
          $("artistIndexBluesky").value = "";
          $("artistIndexX").value = "";
          $("artistIndexArtstation").value = "";
          $("artistIndexWebsite").value = "";
          return;
        }
        $("artistIndexId").value = pick.artist_id || "";
        $("artistIndexName").value = pick.name || "";
        const links = pick.links || {};
        $("artistIndexInstagram").value = links.instagram || "";
        $("artistIndexBluesky").value = links.bluesky || "";
        $("artistIndexX").value = links.x || "";
        $("artistIndexArtstation").value = links.artstation || "";
        $("artistIndexWebsite").value = links.website || "";
      });
      $("artistIndexSave").addEventListener("click", async () => {
        try{
          const body = {
            artist_id: $("artistIndexId").value.trim() || undefined,
            name: $("artistIndexName").value.trim(),
            links: {
              instagram: $("artistIndexInstagram").value.trim(),
              bluesky: $("artistIndexBluesky").value.trim(),
              x: $("artistIndexX").value.trim(),
              artstation: $("artistIndexArtstation").value.trim(),
              website: $("artistIndexWebsite").value.trim()
            }
          };
          const res = await fetch("/api/tarot/artists", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-API-Key": apiKeyEl.value.trim()
            },
            body: JSON.stringify(body)
          });
          const data = await res.json();
          if (!data.ok) throw new Error(data.error || "Failed");
          await loadTarotArtists();
          setStatus("Artist saved.", "ok");
        }catch(err){
          setStatus(err.message, "err");
        }
      });
      $("artistIndexDelete").addEventListener("click", async () => {
        const artistId = $("artistIndexId").value.trim();
        if (!artistId){
          setStatus("Select an artist to delete.", "err");
          return;
        }
        if (!confirm("Delete this artist? Cards will keep the artist_id but links will no longer resolve.")){
          return;
        }
        try{
          const res = await fetch("/api/tarot/artists/" + encodeURIComponent(artistId), {
            method: "DELETE",
            headers: {"X-API-Key": apiKeyEl.value.trim()}
          });
          const data = await res.json();
          if (!data.ok) throw new Error(data.error || "Failed");
          $("artistIndexId").value = "";
          $("artistIndexName").value = "";
          $("artistIndexInstagram").value = "";
          $("artistIndexBluesky").value = "";
          $("artistIndexX").value = "";
          $("artistIndexArtstation").value = "";
          $("artistIndexWebsite").value = "";
          await loadTarotArtists();
          setStatus("Artist deleted.", "ok");
        }catch(err){
          setStatus(err.message, "err");
        }
      });

      $("mediaLibraryOpen").addEventListener("click", () => {
        librarySelectHandler = null;
        showLibraryModal(true);
        loadLibrary("media");
        loadTarotArtists();
      });

      $("uploadLibraryUpload").addEventListener("click", async () => {
        const file = $("uploadLibraryFile").files[0];
        if (!file){
          setStatus("Select an image to upload.", "err");
          return;
        }
        try{
          const fd = new FormData();
          fd.append("file", file);
          const title = $("uploadLibraryTitle").value.trim();
          if (title) fd.append("title", title);
          const artistId = $("uploadLibraryArtist").value.trim();
          if (artistId) fd.append("artist_id", artistId);
          const res = await fetch("/api/media/upload", {
            method: "POST",
            headers: {"X-API-Key": apiKeyEl.value.trim()},
            body: fd
          });
          const data = await res.json();
          if (!data.ok) throw new Error(data.error || "Failed");
          $("uploadLibraryFile").value = "";
          $("uploadLibraryTitle").value = "";
          setStatus("Media uploaded.", "ok");
          await loadLibrary("media");
        }catch(err){
          setStatus(err.message, "err");
        }
      });

      $("taCardHouse").addEventListener("change", (ev) => {
        taRenderHouseInfo(ev.target.value);
      });
      $("taDeckList").addEventListener("click", (ev) => {
        const target = ev.target.closest(".list-card");
        if (!target || !target.dataset.cardId || !window.taDeckData) return;
        const card = (window.taDeckData.cards || []).find(c => c.card_id === target.dataset.cardId);
        if (card){
          taLoadCard(card);
        }
      });
      $("taLoadDeck").addEventListener("click", async () => {
        try{
          const deck = $("taDeck").value.trim() || "elf-classic";
          const data = await jsonFetch("/api/tarot/decks/" + encodeURIComponent(deck), {method:"GET"}, true);
          showList($("taDeckList"), data);
          taRenderPreviews(null);
          setStatus("Deck loaded.", "ok");
        }catch(err){
          setStatus(err.message, "err");
        }
      });

      $("taAddDeck").addEventListener("click", () => {
        $("deckCreateId").value = "";
        $("deckCreateName").value = "";
        $("deckCreateSeed").value = "no";
        $("deckCreatePerHouse").value = "4";
        $("deckCreateCrown").value = "1";
        $("deckCreateBackPick").dataset.backUrl = "";
        $("deckCreateBackPick").dataset.artistId = "";
        $("deckCreateModal").classList.add("show");
      });

      $("taSaveCard").addEventListener("click", async () => {
        try{
          const deck = $("taDeck").value.trim() || "elf-classic";
          const tags = $("taCardTags").value.split(",").map(t => t.trim()).filter(Boolean);
          const body = {
            card_id: $("taCardId").value.trim() || undefined,
            name: $("taCardName").value.trim(),
            house: $("taCardHouse").value.trim(),
            image: window.taUploadedImageUrl || undefined,
            artist_id: $("taCardArtist").value.trim() || undefined,
            tags,
            upright: $("taCardUpright").value.trim(),
            reversed: $("taCardReversed").value.trim(),
            artist_links: undefined
          };
          await jsonFetch("/api/tarot/decks/" + encodeURIComponent(deck) + "/cards", {
            method:"POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(body)
          });
          setStatus("Card saved.", "ok");
          $("taCardId").value = "";
          $("taCardName").value = "";
          $("taCardHouse").value = "";
          window.taUploadedImageUrl = "";
          $("taCardTags").value = "";
          $("taCardUpright").value = "";
          $("taCardReversed").value = "";
          $("taCardArtist").value = "";
          taSelectedCardId = body.card_id || "";
          await $("taLoadDeck").click();
        }catch(err){
          setStatus(err.message, "err");
        }
      });

      async function loadTarotDeckList(selectValue){
        try{
          const data = await jsonFetch("/api/tarot/decks", {method:"GET"}, true);
          const decks = data.decks || [];
          const select = $("taDeck");
          select.innerHTML = "";
          decks.forEach(d => {
            const opt = document.createElement("option");
            opt.value = d.deck_id;
            opt.textContent = d.name ? `${d.name} (${d.deck_id})` : d.deck_id;
            select.appendChild(opt);
          });
          select.value = selectValue || "elf-classic";
        }catch(err){
          setStatus(err.message, "err");
        }
      }

      loadSettings();
      if (apiKeyEl.value.trim()){
        document.getElementById("loginView").classList.add("hidden");
        document.getElementById("appView").classList.remove("hidden");
        loadAuthUser();
        loadGamesMenu();
        showPanel("bingo");
        ensureBingoPolling();
        loadTarotDeckList();
        loadTarotSessionDecks();
        loadTarotSessions();
        loadTarotHouses();
        loadTarotArtists();
      }
      renderCard(null, [], "BING");
    </script>
  </body>
</html>




















