<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Forest Wallet</title>
  <link rel="icon" href="/icon.png" type="image/png">
  <link rel="stylesheet" href="/static/gallery/gallery.css">
  <style>
    :root{
      --panel-bg:rgba(12,18,15,.9);
      --panel-border:rgba(214,178,110,.2);
      --text:var(--text);
      --muted:var(--muted);
    }
    body{
      margin:0;
      font-family:"Spectral","Georgia",serif;
      background:
        linear-gradient(180deg, rgba(7,16,12,.92), rgba(3,9,6,.92)),
        url("/static/images/walletimg.png");
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      background-attachment:fixed;
      color:#e7f2ea;
      position:relative;
      overflow-x:hidden;
    }
    body::before,
    body::after{
      content:"";
      position:fixed;
      inset:-10%;
      pointer-events:none;
      mix-blend-mode:screen;
      opacity:.38;
      z-index:0;
      background:
        radial-gradient(2px 2px at 10% 20%, rgba(255,226,150,.7), transparent 60%),
        radial-gradient(1.5px 1.5px at 30% 70%, rgba(255,236,180,.6), transparent 60%),
        radial-gradient(2px 2px at 60% 30%, rgba(255,214,120,.7), transparent 60%),
        radial-gradient(1.5px 1.5px at 80% 55%, rgba(255,240,190,.5), transparent 60%),
        radial-gradient(2px 2px at 85% 15%, rgba(255,220,140,.6), transparent 60%),
        radial-gradient(1.5px 1.5px at 45% 10%, rgba(255,235,170,.5), transparent 60%),
        radial-gradient(1.5px 1.5px at 15% 85%, rgba(255,228,150,.5), transparent 60%);
      animation: sparkleDrift 22s linear infinite;
    }
    body::after{
      opacity:.12;
      animation-duration: 30s;
      animation-direction: reverse;
      background:
        radial-gradient(1.5px 1.5px at 20% 35%, rgba(255,234,170,.6), transparent 60%),
        radial-gradient(2px 2px at 55% 65%, rgba(255,220,130,.6), transparent 60%),
        radial-gradient(1.5px 1.5px at 75% 25%, rgba(255,240,190,.5), transparent 60%),
        radial-gradient(1.5px 1.5px at 90% 80%, rgba(255,210,120,.5), transparent 60%),
        radial-gradient(2px 2px at 35% 50%, rgba(255,230,160,.6), transparent 60%);
    }
    @keyframes sparkleDrift{
      0%{transform:translate3d(0,0,0);}
      50%{transform:translate3d(-1.5%,1%,0);}
      100%{transform:translate3d(0,0,0);}
    }
    header,
    .panel,
    .modal{
      position:relative;
      z-index:1;
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:32px;
      gap:16px;
      flex-wrap:wrap;
    }
    header h1{
      margin:0;
      font-size:32px;
    }
    .header-context{
      margin:6px 0 0;
      color:rgba(231,242,234,.8);
    }
    .header-actions{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .header-claim{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .icon-btn{
      width:38px;
      height:38px;
      border-radius:10px;
      padding:0;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border:1px solid rgba(214,178,110,.35);
      background:rgba(255,255,255,.04);
      color:#e7f2ea;
    }
    .icon-btn.primary{
      background:#6bd4a2;
      color:#07100c;
      border-color:rgba(107,212,162,.6);
    }
    .icon-btn svg{
      width:18px;
      height:18px;
      display:block;
      fill:currentColor;
    }
    .header-claim input{
      width:200px;
    }
    .panel{
      margin:0 auto 32px;
      padding:24px;
      max-width:900px;
      border:1px solid var(--panel-border);
      border-radius:18px;
      background:var(--panel-bg);
      box-shadow:0 10px 40px rgba(0,0,0,.4);
    }
    .panel h2{
      margin-top:0;
      letter-spacing:.04em;
    }
    label{
      display:flex;
      flex-direction:column;
      font-size:13px;
      margin-bottom:12px;
      gap:4px;
    }
    input{
      border-radius:8px;
      padding:10px 12px;
      border:1px solid rgba(214,178,110,.4);
      background:rgba(255,255,255,.04);
      color:#fff;
    }
    .actions{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
    }
    .link-button{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      text-decoration:none;
    }
    button{
      border:none;
      border-radius:8px;
      padding:10px 18px;
      font-size:14px;
      cursor:pointer;
      font-family:inherit;
      letter-spacing:.04em;
    }
    .primary{
      background:#6bd4a2;
      color:#07100c;
    }
    .muted{
      color:rgba(231,242,234,.8);
    }
    .status-ok{
      color:#6bd4a2;
    }
    .status-error{
      color:#f2a1a1;
    }
    table{
      width:100%;
      border-collapse:collapse;
    }
    th,td{
      padding:10px 12px;
      text-align:left;
      border-bottom:1px solid rgba(231,242,234,.12);
      font-size:14px;
    }
    th{
      text-transform:uppercase;
      letter-spacing:.08em;
      font-size:12px;
      color:#9fb4a6;
    }
    tr.game-row{
      cursor:pointer;
    }
    tr.game-row:hover{
      background:rgba(255,255,255,.03);
    }
    .tag{
      font-size:12px;
      border-radius:10px;
      padding:4px 8px;
      border:1px solid rgba(107,212,162,.4);
      display:inline-flex;
      margin-right:4px;
    }
    .status-chip{
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(214,178,110,.4);
    }
    .claim-btn{
      background:#0f6a4f;
      color:#f0fff7;
    }
    .modal{
      position:fixed;
      inset:0;
      background:rgba(4,8,6,.7);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
      padding:24px;
    }
    .modal.open{
      display:flex;
    }
    .modal-card{
      background:rgba(10,16,13,.95);
      border-radius:18px;
      padding:24px;
      max-width:640px;
      width:100%;
      border:1px solid rgba(214,178,110,.2);
      box-shadow:0 20px 40px rgba(0,0,0,.45);
    }
    .modal-card h3{
      margin-top:0;
    }
    .detail-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-top:16px;
    }
    .detail-item{
      background:rgba(255,255,255,.04);
      padding:10px 12px;
      border-radius:12px;
      font-size:13px;
    }
    .detail-item span{
      display:block;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:#9fb4a6;
      margin-bottom:6px;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Forest Wallet</h1>
      <p class="header-context">View your game history and results tied to your character.</p>
      <div id="claimMessage" class="muted" style="margin-top:10px;"></div>
    </div>
    <div class="header-actions">
      <div class="header-claim" id="headerClaim" style="display:none;">
        <label style="margin:0;">
          <input id="claimJoinCode" type="text" autocomplete="off" placeholder="Enter join key">
        </label>
        <button class="icon-btn primary" id="claimJoinBtn" type="button" title="Claim" aria-label="Claim game">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2a1 1 0 0 1 1 1v8h8a1 1 0 1 1 0 2h-8v8a1 1 0 1 1-2 0v-8H3a1 1 0 1 1 0-2h8V3a1 1 0 0 1 1-1z"/></svg>
        </button>
      </div>
      <span class="tag" id="userName" style="display:none;"></span>
      <a class="primary link-button" id="loginLink" href="/user-area/oauth/start">Login with XivAuth</a>
      <button class="icon-btn" id="logoutBtn" type="button" style="display:none;" title="Logout" aria-label="Logout">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M10 17a1 1 0 0 1 0-2h7.59l-2.3-2.3a1 1 0 1 1 1.42-1.4l4 4a1 1 0 0 1 0 1.4l-4 4a1 1 0 1 1-1.42-1.4l2.3-2.3H10zM5 4h7a2 2 0 0 1 2 2v3a1 1 0 1 1-2 0V6H5v12h7v-3a1 1 0 1 1 2 0v3a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z"/></svg>
      </button>
    </div>
  </header><br>
  <section class="panel">
    <h2>Your games</h2>
    <div id="gamesContainer" class="muted">Login to view your game history.</div>
  </section>
  <div class="modal" id="gameDetailModal" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="actions" style="justify-content:space-between;">
        <h3 id="gameDetailTitle">Game details</h3>
        <button id="gameDetailClose" type="button">Close</button>
      </div>
      <div id="gameDetailBody"></div>
    </div>
  </div>
  <script>
    const TOKEN_KEY = "bigtree_user_token";
    const loginLink = document.getElementById("loginLink");
    const logoutBtn = document.getElementById("logoutBtn");
    const userName = document.getElementById("userName");
    const gamesContainer = document.getElementById("gamesContainer");
    const headerClaim = document.getElementById("headerClaim");
    const claimJoinCode = document.getElementById("claimJoinCode");
    const claimJoinBtn = document.getElementById("claimJoinBtn");
    const claimMessage = document.getElementById("claimMessage");
    const gameDetailModal = document.getElementById("gameDetailModal");
    const gameDetailBody = document.getElementById("gameDetailBody");
    const gameDetailTitle = document.getElementById("gameDetailTitle");
    const gameDetailClose = document.getElementById("gameDetailClose");
    let gameLookup = {};

    function escapeHtml(value){
      const text = value === undefined || value === null ? "" : String(value);
      return text.replace(/[&<>"']/g, (char) => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;",
      }[char]));
    }

    function setMessage(target, text, tone="muted"){
      if(!target) return;
      target.textContent = text || "";
      target.className = tone;
    }

    function getToken(){
      return window.localStorage.getItem(TOKEN_KEY);
    }

    function setToken(token){
      if(token){
        window.localStorage.setItem(TOKEN_KEY, token);
      }else{
        window.localStorage.removeItem(TOKEN_KEY);
      }
    }

    function authHeaders(){
      const token = getToken();
      if(!token) return {};
      return {"Authorization": `Bearer ${token}`};
    }

    function setUserHeader(user){
      if(user && user.xiv_username){
        userName.textContent = user.xiv_username;
        userName.style.display = "inline-flex";
        loginLink.style.display = "none";
        logoutBtn.style.display = "inline-flex";
        headerClaim.style.display = "flex";
      }else{
        userName.textContent = "";
        userName.style.display = "none";
        loginLink.style.display = "inline-flex";
        logoutBtn.style.display = "none";
        headerClaim.style.display = "none";
      }
    }

    function applyTokenFromUrl(){
      const params = new URLSearchParams(window.location.search);
      const token = params.get("user_token");
      if(!token){
        return false;
      }
      setToken(token);
      const url = new URL(window.location.href);
      url.searchParams.delete("user_token");
      window.history.replaceState({}, "", url.toString());
      return true;
    }

    async function loadCurrentUser(){
      const token = getToken();
      if(!token){
        setUserHeader(null);
        return false;
      }
      try{
        const res = await fetch("/user-area/me", {headers: authHeaders()});
        const data = await res.json();
        if(!res.ok || !data.ok){
          throw new Error(data.error || "Invalid session");
        }
        setUserHeader(data.user);
        return true;
      }catch(err){
        setToken("");
        setUserHeader(null);
        return false;
      }
    }

    async function fetchGames(){
      const token = getToken();
      if(!token){
        gamesContainer.textContent = "Login to view your game history.";
        return;
      }
      try{
        const res = await fetch("/user-area/games?all=1", {headers: authHeaders()});
        const data = await res.json();
        if(!res.ok || !data.ok){
          throw new Error(data.error || "Failed to load games");
        }
        renderGames(data.games || []);
      }catch(err){
        gamesContainer.textContent = err.message || "Unable to load games.";
      }
    }

    function renderGames(games){
      gameLookup = {};
      if(!games || !games.length){
        gamesContainer.innerHTML = "<div class='muted'>No games found yet.</div>";
        return;
      }
      games.forEach((game) => {
        if(game && game.game_id){
          gameLookup[game.game_id] = game;
        }
      });
      gamesContainer.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Game</th>
              <th>Type</th>
              <th>Status</th>
              <th>Currency</th>
              <th>Outcome</th>
              <th>Players</th>
              <th>Player page</th>
              <th>Created</th>
            </tr>
          </thead>
          <tbody>
            ${games.map(renderGameRow).join("")}
          </tbody>
        </table>
      `;
    }

    function buildPlayerUrl(game){
      if(!game || !game.join_code){
        return "";
      }
      const moduleId = game.module || "game";
      if(moduleId === "cardgames"){
        const payload = game.payload || {};
        const gameId = payload.game_id || payload.gameId;
        if(!gameId){
          return "";
        }
        return `/cardgames/${encodeURIComponent(gameId)}/session/${encodeURIComponent(game.join_code)}`;
      }
      if(moduleId === "tarot"){
        return `/tarot/session/${encodeURIComponent(game.join_code)}`;
      }
      return "";
    }

    function renderGameRow(game){
      const title = game.name || game.game_id || "Game";
      const players = (game.players || []).map(player => player.name).filter(Boolean);
      const playerText = players.length ? players.join(", ") : "-";
      const status = game.active ? "active" : "ended";
      const outcome = game.outcome || status;
      const playerUrl = buildPlayerUrl(game);
      const playerLink = playerUrl ? `<a href="${escapeHtml(playerUrl)}" target="_blank" rel="noreferrer">Open</a>` : "-";
      return `
        <tr class="game-row" data-game-id="${escapeHtml(game.game_id)}">
          <td>${escapeHtml(title)}</td>
          <td>${escapeHtml(game.module || "game")}</td>
          <td><span class="status-chip">${escapeHtml(status)}</span></td>
          <td>${escapeHtml(game.currency || "-")}</td>
          <td>${escapeHtml(outcome)}</td>
          <td>${escapeHtml(playerText)}</td>
          <td>${playerLink}</td>
          <td>${escapeHtml(game.created_at || "-")}</td>
        </tr>
      `;
    }

    function openGameModal(game){
      if(!game){
        return;
      }
      gameDetailTitle.textContent = game.name || game.game_id || "Game details";
      const players = (game.players || []).map(player => player.name).filter(Boolean);
      const playerText = players.length ? players.join(", ") : "-";
      const status = game.active ? "active" : "ended";
      const playerUrl = buildPlayerUrl(game);
      const details = [
        {label: "Game ID", value: game.game_id},
        {label: "Type", value: game.module || "game"},
        {label: "Status", value: status},
        {label: "Outcome", value: game.outcome || status},
        {label: "Currency", value: game.currency || "-"},
        {label: "Pot", value: game.pot || "-"},
        {label: "Winnings", value: game.winnings || "-"},
        {label: "Players", value: playerText},
        {label: "Join key", value: game.join_code || "-"},
        {label: "Player page", value: playerUrl || "-", link: playerUrl || ""},
        {label: "Created", value: game.created_at || "-"},
        {label: "Ended", value: game.ended_at || "-"},
      ];
      gameDetailBody.innerHTML = `
        <div class="detail-grid">
          ${details.map(detail => `
            <div class="detail-item">
              <span>${escapeHtml(detail.label)}</span>
              ${detail.link ? `<a href="${escapeHtml(detail.link)}" target="_blank" rel="noreferrer">${escapeHtml(detail.value)}</a>` : escapeHtml(detail.value)}
            </div>
          `).join("")}
        </div>
      `;
      gameDetailModal.classList.add("open");
    }

    function closeGameModal(){
      gameDetailModal.classList.remove("open");
    }

    async function claimByJoinCode(){
      const token = getToken();
      if(!token){
        setMessage(claimMessage, "Please login first.", "status-error");
        return;
      }
      const joinCode = claimJoinCode.value.trim();
      if(!joinCode){
        setMessage(claimMessage, "Enter a join key to claim.", "status-error");
        return;
      }
      setMessage(claimMessage, "Checking join key...", "muted");
      try{
        const res = await fetch("/user-area/claim-join", {
          method: "POST",
          headers: {"Content-Type":"application/json", ...authHeaders()},
          body: JSON.stringify({join_code: joinCode}),
        });
        const data = await res.json();
        if(!res.ok || !data.ok){
          if(res.status === 409 && data.game && data.game.claimed_username){
            throw new Error(`Already claimed by ${data.game.claimed_username}.`);
          }
          throw new Error(data.error || "Unable to claim join key.");
        }
        claimJoinCode.value = "";
        setMessage(claimMessage, "Game claimed. It will show in your list.", "status-ok");
        await fetchGames();
      }catch(err){
        setMessage(claimMessage, err.message || "Claim failed.", "status-error");
      }
    }

    gamesContainer.addEventListener("click", (event) => {
      if (event.target && event.target.tagName === "A"){
        return;
      }
      const row = event.target.closest(".game-row");
      if(!row){
        return;
      }
      const gameId = row.getAttribute("data-game-id");
      const game = gameLookup[gameId];
      openGameModal(game);
    });

    claimJoinBtn.addEventListener("click", claimByJoinCode);
    logoutBtn.addEventListener("click", () => {
      setToken("");
      setUserHeader(null);
      gamesContainer.textContent = "Login to view your game history.";
    });
    gameDetailClose.addEventListener("click", closeGameModal);
    gameDetailModal.addEventListener("click", (event) => {
      if(event.target === gameDetailModal){
        closeGameModal();
      }
    });

    applyTokenFromUrl();
    loadCurrentUser().then(fetchGames);
  </script>
</body>
</html>
