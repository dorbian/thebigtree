<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Forest Wallet</title>
  <link rel="icon" href="/icon.png" type="image/png">
  <link rel="stylesheet" href="/static/gallery/gallery.css">
  <style>
    :root{
      --panel-bg:rgba(12,18,15,.9);
      --panel-border:rgba(214,178,110,.2);
      --text:var(--text);
      --muted:var(--muted);
    }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,sans-serif;
      background:
        linear-gradient(180deg, rgba(7,16,12,.92), rgba(3,9,6,.92)),
        url("/static/images/walletimg.png");
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      background-attachment:fixed;
      color:#e7f2ea;
      position:relative;
      overflow-x:hidden;
    }
    body::before,
    body::after{
      content:"";
      position:fixed;
      inset:-10%;
      pointer-events:none;
      mix-blend-mode:screen;
      opacity:.38;
      z-index:0;
      background:
        radial-gradient(2px 2px at 10% 20%, rgba(255,226,150,.7), transparent 60%),
        radial-gradient(1.5px 1.5px at 30% 70%, rgba(255,236,180,.6), transparent 60%),
        radial-gradient(2px 2px at 60% 30%, rgba(255,214,120,.7), transparent 60%),
        radial-gradient(1.5px 1.5px at 80% 55%, rgba(255,240,190,.5), transparent 60%),
        radial-gradient(2px 2px at 85% 15%, rgba(255,220,140,.6), transparent 60%),
        radial-gradient(1.5px 1.5px at 45% 10%, rgba(255,235,170,.5), transparent 60%),
        radial-gradient(1.5px 1.5px at 15% 85%, rgba(255,228,150,.5), transparent 60%);
      animation: sparkleDrift 22s linear infinite;
    }
    body::after{
      opacity:.12;
      animation-duration: 30s;
      animation-direction: reverse;
      background:
        radial-gradient(1.5px 1.5px at 20% 35%, rgba(255,234,170,.6), transparent 60%),
        radial-gradient(2px 2px at 55% 65%, rgba(255,220,130,.6), transparent 60%),
        radial-gradient(1.5px 1.5px at 75% 25%, rgba(255,240,190,.5), transparent 60%),
        radial-gradient(1.5px 1.5px at 90% 80%, rgba(255,210,120,.5), transparent 60%),
        radial-gradient(2px 2px at 35% 50%, rgba(255,230,160,.6), transparent 60%);
    }
    @keyframes sparkleDrift{
      0%{transform:translate3d(0,0,0);}
      50%{transform:translate3d(-1.5%,1%,0);}
      100%{transform:translate3d(0,0,0);}
    }
    header,
    .panel,
    .modal{
      position:relative;
      z-index:1;
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:32px;
      gap:16px;
      flex-wrap:wrap;
    }
    header h1{
      margin:0;
      font-size:32px;
    }
    .header-context{
      margin:6px 0 0;
      color:rgba(231,242,234,.8);
    }
    .header-actions{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .header-claim{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .icon-btn{
      width:38px;
      height:38px;
      border-radius:10px;
      padding:0;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border:1px solid rgba(214,178,110,.35);
      background:rgba(255,255,255,.04);
      color:#e7f2ea;
    }
    .icon-btn.primary{
      background:#6bd4a2;
      color:#07100c;
      border-color:rgba(107,212,162,.6);
    }
    .icon-btn svg{
      width:18px;
      height:18px;
      display:block;
      fill:currentColor;
    }
    .section-title{
      font-weight:600;
      letter-spacing:.02em;
      text-transform:uppercase;
      font-size:12px;
      color:rgba(231,242,234,.75);
    }
    .panel table{
      table-layout:fixed;
      width:100%;
    }
    .panel table th,
    .panel table td{
      overflow-wrap:anywhere;
      word-break:break-word;
    }
    .header-claim input{
      width:200px;
    }
    .panel{
      margin:0 auto 32px;
      padding:24px;
      max-width:900px;
      border:1px solid var(--panel-border);
      border-radius:18px;
      background:var(--panel-bg);
      box-shadow:0 10px 40px rgba(0,0,0,.4);
    }
    .panel h2{
      margin-top:0;
      letter-spacing:.04em;
    }
    label{
      display:flex;
      flex-direction:column;
      font-size:13px;
      margin-bottom:12px;
      gap:4px;
    }
    input{
      border-radius:8px;
      padding:10px 12px;
      border:1px solid rgba(214,178,110,.4);
      background:rgba(255,255,255,.04);
      color:#fff;
    }
    .actions{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
    }
    .link-button{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      text-decoration:none;
    }
    button{
      border:none;
      border-radius:8px;
      padding:10px 18px;
      font-size:14px;
      cursor:pointer;
      font-family:inherit;
      letter-spacing:.04em;
    }
    .primary{
      background:#6bd4a2;
      color:#07100c;
    }
    .muted{
      color:rgba(231,242,234,.8);
    }
    .status-ok{
      color:#6bd4a2;
    }
    .status-error{
      color:#f2a1a1;
    }
    table{
      width:100%;
      border-collapse:collapse;
    }
    th,td{
      padding:10px 12px;
      text-align:left;
      border-bottom:1px solid rgba(231,242,234,.12);
      font-size:14px;
    }
    th{
      text-transform:uppercase;
      letter-spacing:.08em;
      font-size:12px;
      color:#9fb4a6;
    }
    tr.game-row{
      cursor:pointer;
    }
    tr.game-row:hover{
      background:rgba(255,255,255,.03);
    }
    .tag{
      font-size:12px;
      border-radius:10px;
      padding:4px 8px;
      border:1px solid rgba(107,212,162,.4);
      display:inline-flex;
      margin-right:4px;
    }
    .user-pill{
      height:38px;
      padding:0 12px;
      align-items:center;
      justify-content:center;
      line-height:1;
    }
    .status-chip{
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(214,178,110,.4);
    }
    .claim-btn{
      background:#0f6a4f;
      color:#f0fff7;
    }
    .modal{
      position:fixed;
      inset:0;
      background:rgba(4,8,6,.7);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
      padding:24px;
    }
    .modal.open{
      display:flex;
    }
    .modal-card{
      background:rgba(10,16,13,.95);
      border-radius:18px;
      padding:24px;
      max-width:640px;
      width:100%;
      border:1px solid rgba(214,178,110,.2);
      box-shadow:0 20px 40px rgba(0,0,0,.45);
    }
    .modal-card h3{
      margin-top:0;
    }
    .detail-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-top:16px;
    }
    .detail-item{
      background:rgba(255,255,255,.04);
      padding:10px 12px;
      border-radius:12px;
      font-size:13px;
    }
    .detail-item span{
      display:block;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:#9fb4a6;
      margin-bottom:6px;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Forest Wallet</h1>
      <p class="header-context">View your game history and results tied to your character.</p>
      <div id="claimMessage" class="muted" style="margin-top:10px;"></div>
    </div>
    <div class="header-actions">
      <div class="header-claim" id="headerClaim" style="display:none;">
        <label style="margin:0;">
          <input id="claimJoinCode" type="text" autocomplete="off" placeholder="Enter join key">
        </label>
        <button class="icon-btn primary" id="claimJoinBtn" type="button" title="Claim" aria-label="Claim game">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2a1 1 0 0 1 1 1v8h8a1 1 0 1 1 0 2h-8v8a1 1 0 1 1-2 0v-8H3a1 1 0 1 1 0-2h8V3a1 1 0 0 1 1-1z"/></svg>
        </button>
      </div>
      <span class="tag user-pill" id="userName" style="display:none;"></span>
      <a class="primary link-button" id="loginLink" href="/user-area/oauth/start">Login with XivAuth</a>
      <button class="icon-btn" id="logoutBtn" type="button" style="display:none;" title="Logout" aria-label="Logout">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M10 17a1 1 0 0 1 0-2h7.59l-2.3-2.3a1 1 0 1 1 1.42-1.4l4 4a1 1 0 0 1 0 1.4l-4 4a1 1 0 1 1-1.42-1.4l2.3-2.3H10zM5 4h7a2 2 0 0 1 2 2v3a1 1 0 1 1-2 0V6H5v12h7v-3a1 1 0 1 1 2 0v3a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z"/></svg>
      </button>
    </div>
  </header><br>
  <section class="panel">
    <h2>Active</h2>
    <div class="muted" style="margin-bottom:10px;">Active events and games you can still return to.</div>
    <div id="activeEventsContainer" class="muted" style="margin-bottom:18px;"></div>
    <div id="activeGamesContainer" class="muted">Login to view your game history.</div>
  </section>
  <section class="panel">
    <h2>Past</h2>
    <div class="muted" style="margin-bottom:10px;">Previous events and finished games.</div>
    <div id="pastEventsContainer" class="muted" style="margin-bottom:18px;"></div>
    <div id="pastGamesContainer" class="muted"></div>
  </section>
  <div class="modal" id="gameDetailModal" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="actions" style="justify-content:space-between;">
        <h3 id="gameDetailTitle">Game details</h3>
        <button id="gameDetailClose" type="button">Close</button>
      </div>
      <div id="gameDetailBody"></div>
    </div>
  </div>
  <div class="modal" id="eventDetailModal" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="actions" style="justify-content:space-between;">
        <h3 id="eventDetailTitle">Event details</h3>
        <button id="eventDetailClose" type="button">Close</button>
      </div>
      <div id="eventDetailBody"></div>
    </div>
  </div>
  <script>
    const TOKEN_KEY = "bigtree_user_token";
    const loginLink = document.getElementById("loginLink");
    const logoutBtn = document.getElementById("logoutBtn");
    const userName = document.getElementById("userName");
    const gamesContainer = document.getElementById("gamesContainer");
    const activeEventsContainer = document.getElementById("activeEventsContainer");
    const activeGamesContainer = document.getElementById("activeGamesContainer");
    const pastEventsContainer = document.getElementById("pastEventsContainer");
    const pastGamesContainer = document.getElementById("pastGamesContainer");
    const headerClaim = document.getElementById("headerClaim");
    const claimJoinCode = document.getElementById("claimJoinCode");
    const claimJoinBtn = document.getElementById("claimJoinBtn");
    const claimMessage = document.getElementById("claimMessage");
    const gameDetailModal = document.getElementById("gameDetailModal");
    const gameDetailBody = document.getElementById("gameDetailBody");
    const gameDetailTitle = document.getElementById("gameDetailTitle");
    const gameDetailClose = document.getElementById("gameDetailClose");
    const eventDetailModal = document.getElementById("eventDetailModal");
    const eventDetailTitle = document.getElementById("eventDetailTitle");
    const eventDetailBody = document.getElementById("eventDetailBody");
    const eventDetailClose = document.getElementById("eventDetailClose");
    let gameLookup = {};
    let eventLookup = {};

    function escapeHtml(value){
      const text = value === undefined || value === null ? "" : String(value);
      return text.replace(/[&<>"']/g, (char) => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;",
      }[char]));
    }

    function setMessage(target, text, tone="muted"){
      if(!target) return;
      target.textContent = text || "";
      target.className = tone;
    }

    function getToken(){
      return window.localStorage.getItem(TOKEN_KEY);
    }

    function setToken(token){
      if(token){
        window.localStorage.setItem(TOKEN_KEY, token);
      }else{
        window.localStorage.removeItem(TOKEN_KEY);
      }
    }

    function authHeaders(){
      const token = getToken();
      if(!token) return {};
      return {"Authorization": `Bearer ${token}`};
    }

    let currentUserName = "";
    function setUserHeader(user){
      if(user && user.xiv_username){
        currentUserName = user.xiv_username;
        userName.textContent = user.xiv_username;
        userName.style.display = "inline-flex";
        loginLink.style.display = "none";
        logoutBtn.style.display = "inline-flex";
        headerClaim.style.display = "flex";
      }else{
        currentUserName = "";
        userName.textContent = "";
        userName.style.display = "none";
        loginLink.style.display = "inline-flex";
        logoutBtn.style.display = "none";
        headerClaim.style.display = "none";
      }
    }

    function applyTokenFromUrl(){
      const params = new URLSearchParams(window.location.search);
      const token = params.get("user_token");
      if(!token){
        return false;
      }
      setToken(token);
      const url = new URL(window.location.href);
      url.searchParams.delete("user_token");
      window.history.replaceState({}, "", url.toString());
      return true;
    }

    async function loadCurrentUser(){
      const token = getToken();
      if(!token){
        setUserHeader(null);
        return false;
      }
      try{
        const res = await fetch("/user-area/me", {headers: authHeaders()});
        const data = await res.json();
        if(!res.ok || !data.ok){
          throw new Error(data.error || "Invalid session");
        }
        setUserHeader(data.user);
        return true;
      }catch(err){
        setToken("");
        setUserHeader(null);
        return false;
      }
    }

    async function fetchGames(){
      const token = getToken();
      if(!token){
        if (activeGamesContainer) activeGamesContainer.textContent = "Login to view your game history.";
        if (pastGamesContainer) pastGamesContainer.textContent = "";
        return;
      }
      try{
        const res = await fetch("/user-area/games?all=1", {headers: authHeaders()});
        const data = await res.json();
        if(!res.ok || !data.ok){
          throw new Error(data.error || "Failed to load games");
        }
        const games = data.games || [];
        const activeGames = games.filter(g => !!g.active);
        const pastGames = games.filter(g => !g.active);
        renderGames(activeGames, activeGamesContainer);
        renderGames(pastGames, pastGamesContainer, {emptyText: "No past games found yet."});
      }catch(err){
        if (activeGamesContainer) activeGamesContainer.textContent = err.message || "Unable to load games.";
        if (pastGamesContainer) pastGamesContainer.textContent = "";
      }
    }

    function renderGames(games, target, opts){
      const options = opts || {};
      gameLookup = {};
      if(!target) return;
      if(!games || !games.length){
        target.innerHTML = `<div class='muted'>${escapeHtml(options.emptyText || "No games found yet.")}</div>`;
        return;
      }
      games.forEach((game) => {
        if(game && game.game_id){
          gameLookup[game.game_id] = game;
        }
      });
      target.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Game</th>
              <th>Type</th>
              <th>Status</th>
              <th>Paid</th>
              <th>Outcome</th>
              <th>Player page</th>
              <th>Created</th>
            </tr>
          </thead>
          <tbody>
            ${games.map(renderGameRow).join("")}
          </tbody>
        </table>
      `;
    }

    function buildPlayerUrl(game){
      if(!game){
        return "";
      }
      const moduleId = game.module || "game";
      if(moduleId === "cardgames"){
        if(!game.join_code) return "";
        const payload = game.payload || {};
        const gameId = payload.game_id || payload.gameId;
        if(!gameId){
          return "";
        }
        return `/cardgames/${encodeURIComponent(gameId)}/session/${encodeURIComponent(game.join_code)}`;
      }
      if(moduleId === "tarot"){
        if(!game.join_code) return "";
        return `/tarot/session/${encodeURIComponent(game.join_code)}`;
      }
      if(moduleId === "bingo"){
        // Prefer owner token (join_code). If it's missing, fall back to game+owner params.
        if(game.join_code){
          return `/bingo/owner?token=${encodeURIComponent(game.join_code)}`;
        }
        const gid = game.game_id ? String(game.game_id) : "";
        let owner = game.claimed_username ? String(game.claimed_username) : (currentUserName || "");
        if (!owner && Array.isArray(game.players)){
          const match = game.players.find(p => {
            const role = String((p || {}).role || "").toLowerCase();
            return role === "owner" || role === "host" || role === "dealer" || role === "caller";
          });
          if (match && match.name){
            owner = String(match.name);
          }
        }
        if(gid && owner){
          return `/bingo/owner?game=${encodeURIComponent(gid)}&owner=${encodeURIComponent(owner)}`;
        }
        return "";
      }
      return "";
    }

    function formatGameType(game){
      const moduleId = (game.module || "").toLowerCase();
      if (moduleId === "cardgames"){
        const payload = game.payload || {};
        const raw = payload.game_id || payload.gameId || "";
        return raw ? String(raw) : "Cardgame";
      }
      if (moduleId === "bingo") return "Bingo";
      if (moduleId === "tarot") return "Tarot";
      return moduleId ? moduleId : "Game";
    }

    function getGameTitle(game){
      const title = game.title || game.name;
      if (title) return String(title);
      return formatGameType(game);
    }

    function getGamePaid(game){
      const meta = game.metadata || {};
      const paid = game.pot ?? meta.price;
      if (paid === undefined || paid === null || paid === ""){
        return "-";
      }
      const currency = game.currency || "";
      return currency ? `${paid} ${currency}` : String(paid);
    }

    function formatDateOnly(value){
      if (!value) return "-";
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return String(value);
      return date.toLocaleDateString();
    }

    function renderGameRow(game){
      const title = getGameTitle(game);
      const status = game.active ? "active" : "ended";
      const outcome = game.active ? "-" : (game.outcome || status);
      const playerUrl = buildPlayerUrl(game);
      const playerLink = playerUrl ? `<a href="${escapeHtml(playerUrl)}" target="_blank" rel="noreferrer">Open</a>` : "-";
      return `
        <tr class="game-row" data-game-id="${escapeHtml(game.game_id)}">
          <td>${escapeHtml(title)}</td>
          <td>${escapeHtml(formatGameType(game))}</td>
          <td><span class="status-chip">${escapeHtml(status)}</span></td>
          <td>${escapeHtml(getGamePaid(game))}</td>
          <td>${escapeHtml(outcome)}</td>
          <td>${playerLink}</td>
          <td>${escapeHtml(formatDateOnly(game.created_at))}</td>
        </tr>
      `;
    }

    function openGameModal(game){
      if(!game){
        return;
      }
      gameDetailTitle.textContent = getGameTitle(game);
      const status = game.active ? "active" : "ended";
      const playerUrl = buildPlayerUrl(game);
      const details = [
        {label: "Title", value: getGameTitle(game)},
        {label: "Type", value: formatGameType(game)},
        {label: "Status", value: status},
        {label: "Outcome", value: game.active ? "-" : (game.outcome || status)},
        {label: "Paid", value: getGamePaid(game)},
        {label: "Winnings", value: game.winnings || "-"},
        {label: "Join key", value: game.join_code || "-"},
        {label: "Player page", value: playerUrl || "-", link: playerUrl || ""},
        {label: "Created", value: formatDateOnly(game.created_at)},
        {label: "Ended", value: game.ended_at || "-"},
      ];
      gameDetailBody.innerHTML = `
        <div class="detail-grid">
          ${details.map(detail => `
            <div class="detail-item">
              <span>${escapeHtml(detail.label)}</span>
              ${detail.link ? `<a href="${escapeHtml(detail.link)}" target="_blank" rel="noreferrer">${escapeHtml(detail.value)}</a>` : escapeHtml(detail.value)}
            </div>
          `).join("")}
        </div>
      `;
      gameDetailModal.classList.add("open");
    }

    function closeGameModal(){
      gameDetailModal.classList.remove("open");
    }

    async function fetchEvents(){
      const token = getToken();
      if(!token){
        if (activeEventsContainer) activeEventsContainer.textContent = "Login to view your events.";
        if (pastEventsContainer) pastEventsContainer.textContent = "";
        return;
      }
      try{
        const res = await fetch("/user-area/events?all=1", {headers: authHeaders()});
        const data = await res.json();
        if(!res.ok || !data.ok){
          throw new Error(data.error || "Failed to load events");
        }
        const events = data.events || [];
        const activeEvents = events.filter(ev => (ev.status || "") === "active");
        const pastEvents = events.filter(ev => (ev.status || "") !== "active");
        renderEvents(activeEvents, activeEventsContainer, {emptyText: "No active events right now."});
        renderEvents(pastEvents, pastEventsContainer, {emptyText: "No past events found yet."});
      }catch(err){
        if (activeEventsContainer) activeEventsContainer.textContent = err.message || "Unable to load events.";
        if (pastEventsContainer) pastEventsContainer.textContent = "";
      }
    }

    function renderEvents(events, target, opts){
      const options = opts || {};
      eventLookup = {};
      if (!target) return;
      if(!events || !events.length){
        target.innerHTML = `<div class='muted'>${escapeHtml(options.emptyText || "No events found yet.")}</div>`;
        return;
      }
      events.forEach((ev) => {
        if (ev && ev.event_code){
          eventLookup[ev.event_code] = ev;
        }
      });
      target.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Event</th>
              <th>Status</th>
              <th>Venue</th>
              <th>Wallet</th>
              <th>Games</th>
            </tr>
          </thead>
          <tbody>
            ${events.map(renderEventRow).join("")}
          </tbody>
        </table>
      `;
    }

    function renderEventRow(ev){
      const code = ev.event_code || "";
      const title = ev.title || code || "Event";
      const status = ev.status || "-";
      const venue = ev.venue_name || "-";
      const currency = ev.currency_name || "-";
      const walletAmount = ev.wallet_enabled ? `${ev.wallet_balance ?? 0}` : "-";
      const wallet = (walletAmount !== "-" && currency !== "-") ? `${walletAmount} ${currency}` : walletAmount;
      const gamesCount = ev.games_count ?? 0;
      const eventLink = status === "active" && code
        ? `<div style="margin-top:6px;"><a href="/events/${encodeURIComponent(code)}" target="_blank" rel="noreferrer">Open event</a></div>`
        : "";
      return `
        <tr class="event-row" data-event-code="${escapeHtml(code)}">
          <td>${escapeHtml(title)}<div class="muted" style="font-size:12px;"><code>${escapeHtml(code)}</code></div>${eventLink}</td>
          <td><span class="status-chip">${escapeHtml(status)}</span></td>
          <td>${escapeHtml(venue)}</td>
          <td>${escapeHtml(wallet)}</td>
          <td>${escapeHtml(String(gamesCount))}</td>
        </tr>
      `;
    }

    async function openEventModalByCode(code){
      if (!code) return;
      eventDetailTitle.textContent = "Event details";
      eventDetailBody.innerHTML = "<div class='muted'>Loading...</div>";
      eventDetailModal.classList.add("open");
      try{
        const res = await fetch(`/user-area/events/${encodeURIComponent(code)}`, {headers: authHeaders()});
        const data = await res.json();
        if (!res.ok || !data.ok){
          throw new Error(data.error || "Unable to load event");
        }
        const ev = data.event || {};
        const games = data.games || [];
        const walletEnabled = !!ev.wallet_enabled;
        const walletBalance = data.wallet_balance ?? null;
        const walletUsable = !!data.wallet_usable;
        const walletHistory = Array.isArray(data.wallet_history) ? data.wallet_history : [];
        const status = ev.status || "-";
        const currency = ev.currency_name || "-";
        const venue = ev.venue_name || "-";
        const usableText = walletEnabled ? (walletUsable ? "usable in new events" : "not usable in new events") : "-";
        const historyRows = walletHistory.length ? `
          <table style="margin-top:12px;">
            <thead><tr><th>Time</th><th>Change</th><th>Balance</th><th>Reason</th></tr></thead>
            <tbody>
              ${walletHistory.map(h => {
                const delta = Number(h.delta ?? 0);
                const sign = delta > 0 ? "+" : "";
                const reason = String(h.reason || "update");
                const meta = h.metadata || {};
                const gameTag = meta.game_id ? ` (${escapeHtml(String(meta.game_id))})` : "";
                const hostTag = meta.host_name ? ` · ${escapeHtml(String(meta.host_name))}` : "";
                const commentTag = meta.comment ? ` · ${escapeHtml(String(meta.comment))}` : "";
                return `
                  <tr>
                    <td>${escapeHtml(String(h.created_at || ""))}</td>
                    <td>${escapeHtml(`${sign}${delta}`)}</td>
                    <td>${escapeHtml(String(h.balance ?? 0))}</td>
                    <td>${escapeHtml(reason)}${gameTag}${hostTag}${commentTag}</td>
                  </tr>
                `;
              }).join("")}
            </tbody>
          </table>
        ` : "<div class='muted' style='margin-top:12px;'>No wallet activity yet.</div>";
        const gameRows = games.length ? `
          <table style="margin-top:12px;">
            <thead><tr><th>Game</th><th>Type</th><th>Status</th><th>Outcome</th><th>Join key</th></tr></thead>
            <tbody>
              ${games.map(g => `
                <tr class="game-row" data-game-id="${escapeHtml(g.game_id || "")}">
                  <td>${escapeHtml(g.title || g.game_id || "Game")}</td>
                  <td>${escapeHtml(g.module || "-")}</td>
                  <td>${escapeHtml(g.active ? "active" : "ended")}</td>
                  <td>${escapeHtml(g.outcome || "-")}</td>
                  <td><code>${escapeHtml(g.join_code || "-")}</code></td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        ` : "<div class='muted' style='margin-top:12px;'>No games recorded for this event yet.</div>";

        eventDetailTitle.textContent = ev.title || ev.event_code || "Event details";
        eventDetailBody.innerHTML = `
          <div class="detail-grid">
            <div class="detail-item"><span>Event code</span>${escapeHtml(ev.event_code || "-")}</div>
            <div class="detail-item"><span>Status</span>${escapeHtml(status)}</div>
            <div class="detail-item"><span>Venue</span>${escapeHtml(venue)}</div>
            <div class="detail-item"><span>Currency</span>${escapeHtml(currency)}</div>
            <div class="detail-item"><span>Wallet enabled</span>${walletEnabled ? "Yes" : "No"}</div>
            <div class="detail-item"><span>Wallet balance</span>${walletEnabled ? escapeHtml(String(walletBalance ?? 0)) : "-"}</div>
            <div class="detail-item"><span>Wallet carry-over</span>${walletEnabled ? (data.carry_over ? "Yes" : "No") : "-"}</div>
            <div class="detail-item"><span>Usable later</span>${walletEnabled ? escapeHtml(usableText) : "-"}</div>
          </div>
          <div class="section-title" style="margin-top:16px;">Wallet history</div>
          ${walletEnabled ? historyRows : "<div class='muted' style='margin-top:12px;'>Wallet is disabled for this event.</div>"}
          ${gameRows}
        `;
      }catch(err){
        eventDetailBody.innerHTML = `<div class='status-error'>${escapeHtml(err.message || "Unable to load event.")}</div>`;
      }
    }

    function closeEventModal(){
      eventDetailModal.classList.remove("open");
    }

    async function claimByJoinCode(){
      const token = getToken();
      if(!token){
        setMessage(claimMessage, "Please login first.", "status-error");
        return;
      }
      const joinCode = claimJoinCode.value.trim();
      if(!joinCode){
        setMessage(claimMessage, "Enter a join key to claim.", "status-error");
        return;
      }
      setMessage(claimMessage, "Checking join key...", "muted");
      try{
        const res = await fetch("/user-area/claim-join", {
          method: "POST",
          headers: {"Content-Type":"application/json", ...authHeaders()},
          body: JSON.stringify({join_code: joinCode}),
        });
        const data = await res.json();
        if(!res.ok || !data.ok){
          if(res.status === 409 && data.game && data.game.claimed_username){
            throw new Error(`Already claimed by ${data.game.claimed_username}.`);
          }
          throw new Error(data.error || "Unable to claim join key.");
        }
        claimJoinCode.value = "";
        setMessage(claimMessage, "Game claimed. It will show in your list.", "status-ok");
        await fetchGames();
        await fetchEvents();
      }catch(err){
        setMessage(claimMessage, err.message || "Claim failed.", "status-error");
      }
    }

    function handleGamesTableClick(event){
      if (event.target && event.target.tagName === "A"){
        return;
      }
      const row = event.target.closest(".game-row");
      if(!row){
        return;
      }
      const gameId = row.getAttribute("data-game-id");
      const game = gameLookup[gameId];
      openGameModal(game);
    }

    if (activeGamesContainer) activeGamesContainer.addEventListener("click", handleGamesTableClick);
    if (pastGamesContainer) pastGamesContainer.addEventListener("click", handleGamesTableClick);

    function handleEventsTableClick(event){
      const row = event.target.closest(".event-row");
      if(!row) return;
      const code = row.getAttribute("data-event-code") || "";
      openEventModalByCode(code);
    }
    if (activeEventsContainer) activeEventsContainer.addEventListener("click", handleEventsTableClick);
    if (pastEventsContainer) pastEventsContainer.addEventListener("click", handleEventsTableClick);

    claimJoinBtn.addEventListener("click", claimByJoinCode);
    logoutBtn.addEventListener("click", () => {
      setToken("");
      setUserHeader(null);
      if (activeGamesContainer) activeGamesContainer.textContent = "Login to view your game history.";
      if (pastGamesContainer) pastGamesContainer.textContent = "";
      if (activeEventsContainer) activeEventsContainer.textContent = "Login to view your events.";
      if (pastEventsContainer) pastEventsContainer.textContent = "";
    });
    gameDetailClose.addEventListener("click", closeGameModal);
    gameDetailModal.addEventListener("click", (event) => {
      if(event.target === gameDetailModal){
        closeGameModal();
      }
    });
    if (eventDetailClose) eventDetailClose.addEventListener("click", closeEventModal);
    if (eventDetailModal){
      eventDetailModal.addEventListener("click", (event) => {
        if(event.target === eventDetailModal){
          closeEventModal();
        }
      });
    }

    applyTokenFromUrl();
    loadCurrentUser().then(() => Promise.all([fetchGames(), fetchEvents()]));
  </script>
</body>
</html>
